I"¢â<h1 id="æ­£æ–‡">æ­£æ–‡</h1>
<h2 id="å‰è¨€">å‰è¨€</h2>
<h3 id="å·¥å…·é“¾">å·¥å…·é“¾</h3>
<p>ç”¨ Ubuntu æ¯”è¾ƒæ–¹ä¾¿:</p>
<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$ </span><span class="nb">sudo </span>apt <span class="nb">install</span> <span class="nt">-y</span> gcc objdump
<span class="nv">$ </span><span class="nb">sudo </span>apt <span class="nb">install</span> <span class="nt">-y</span> build-essential gdb
<span class="nv">$ </span><span class="nb">sudo </span>apt <span class="nb">install</span> <span class="nt">-y</span> gcc-multilib
<span class="nv">$ </span><span class="nb">sudo </span>apt <span class="nb">install</span> <span class="nt">-y</span> qemu
</code></pre></div></div>

<h3 id="è½¯ä»¶é…ç½®">è½¯ä»¶é…ç½®</h3>
<p>é¦–å…ˆæ˜¯ git çš„éƒ¨ç½²å’ŒåŸºæœ¬ç”¨æ³•.<br />
ç„¶åæ˜¯æ•´ä¸ªé¡¹ç›®çš„ Makefile. ä½¿ç”¨ <code class="language-plaintext highlighter-rouge">make handin</code> å¯ä»¥æäº¤, ä½†æ˜¯æˆ‘ä¸æ˜¯ MIT çš„å­¦ç”Ÿ; <code class="language-plaintext highlighter-rouge">make grade</code> å¯ä»¥æµ‹æˆç»©.</p>

<h3 id="ç³»ç»Ÿç¯å¢ƒ">ç³»ç»Ÿç¯å¢ƒ</h3>
<p>æœ¬æ¥æ˜¯åœ¨è£…æœ‰ Ubuntu 18.04 çš„æ¯æœºä¸Šè·‘çš„, å› ä¸ºç³»ç»Ÿä½æ•°åŸå› æ¢æˆäº† Windows 10 ä¸‹è·‘ Ubuntu 16.04 32 ä½çš„è™šæ‹Ÿæœº, ä½¿ç”¨ ssh è¿æ¥.</p>

<h2 id="part-1-pc-bootstrap">Part 1: PC Bootstrap</h2>
<h3 id="x86-æ±‡ç¼–">x86 æ±‡ç¼–</h3>
<p>æ±‡ç¼–å·²ç»åœ¨ä¸Šä¸Šä¸€ç¯‡åšæ–‡é‡Œå®Œæˆäº†. ä¸è¿‡å› ä¸º 828 å…¨ç¨‹ç”¨åˆ° gcc, æ‰€ä»¥æ±‡ç¼–è‡ªç„¶æ˜¯ AT&amp;T é£æ ¼çš„, åŒºåˆ«äº NASM.</p>

<h3 id="æ¨¡æ‹Ÿ-x86">æ¨¡æ‹Ÿ x86</h3>
<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>make
</code></pre></div></div>
<p>è¾“å‡º:</p>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>+ as kern/entry.S
+ cc kern/entrypgdir.c
+ cc kern/init.c
+ cc kern/console.c
+ cc kern/monitor.c
+ cc kern/printf.c
+ cc kern/kdebug.c
+ cc lib/printfmt.c
+ cc lib/readline.c
+ cc lib/string.c
+ ld obj/kern/kernel
ld: warning: section `.bss' type changed to PROGBITS
+ as boot/boot.S
+ cc -Os boot/main.c
+ ld boot/boot
boot block is 390 bytes (max 510)
+ mk obj/kern/kernel.img
</code></pre></div></div>
<p>bss æ®µæŠ¥äº†ä¸ªè­¦å‘Š, ä½†æ˜¯é—®é¢˜ä¸å¤§.</p>

<p>ç”¨ <code class="language-plaintext highlighter-rouge">make qemu</code> æˆ–è€… <code class="language-plaintext highlighter-rouge">make qemu-nox</code> å¯ä»¥æ”¾ QEMU é‡Œé¢è·‘.<br />
ç³»ç»Ÿè‡ªå¸¦ä¸¤ä¸ªæŒ‡ä»¤, <code class="language-plaintext highlighter-rouge">help</code> å’Œ <code class="language-plaintext highlighter-rouge">kerninfo</code>. <code class="language-plaintext highlighter-rouge">C-A,X</code> å¯ä»¥é€€å‡º QEMU.</p>

<h3 id="pc-çš„ç‰©ç†åœ°å€ç©ºé—´">PC çš„ç‰©ç†åœ°å€ç©ºé—´</h3>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>+------------------+  &lt;- 0xFFFFFFFF (4GB)
|      32-bit      |
|  memory mapped   |
|     devices      |
|                  |
/\/\/\/\/\/\/\/\/\/\

/\/\/\/\/\/\/\/\/\/\
|                  |
|      Unused      |
|                  |
+------------------+  &lt;- depends on amount of RAM
|                  |
|                  |
| Extended Memory  |
|                  |
|                  |
+------------------+  &lt;- 0x00100000 (1MB)
|     BIOS ROM     |
+------------------+  &lt;- 0x000F0000 (960KB)
|  16-bit devices, |
|  expansion ROMs  |
+------------------+  &lt;- 0x000C0000 (768KB)
|   VGA Display    |
+------------------+  &lt;- 0x000A0000 (640KB)
|                  |
|    Low Memory    |
|                  |
+------------------+  &lt;- 0x00000000
</code></pre></div></div>
<p>æ³¨æ„, JOS è¢«é™åˆ¶åªç”¨ PC ç‰©ç†åœ°å€çš„å‰ 256MB.</p>

<h3 id="the-rom-bios">The ROM BIOS</h3>
<p>åœ¨ç¬¬ä¸€ä¸ªç»ˆç«¯é‡Œæ‰§è¡Œ <code class="language-plaintext highlighter-rouge">make qemu-gdb</code> æˆ–è€… <code class="language-plaintext highlighter-rouge">make qemu-nox-gdb</code>, QEMU ä¼šåœåœ¨å¤„ç†å™¨æ‰§è¡Œç¬¬ä¸€ä¸ªæŒ‡ä»¤ä¹‹å‰. æ¥ç€åœ¨ç¬¬äºŒä¸ªç»ˆç«¯é‡Œè¾“å…¥ <code class="language-plaintext highlighter-rouge">make gdb</code> å¯ä»¥å¯¹ QEMU é‡Œçš„ç³»ç»Ÿè¿›è¡Œè°ƒè¯•.</p>

<p>æ¥ç€, å¯ä»¥è·Ÿè¸ªåˆ°ç¬¬ä¸€æ¡æŒ‡ä»¤æ˜¯:</p>
<pre><code class="language-asm">[f000:fff0]    0xffff0:	ljmp   $0xf000,$0xe05b
</code></pre>
<p>è¿™é‡Œ CS = 0xf000, IP = 0xe05b.</p>

<p>BIOSè¿è¡Œ, å°†ä¼šéƒ¨ç½²ä¸­æ–­æè¿°ç¬¦è¡¨, å¹¶ä¸”åˆå§‹åŒ–ä¸€äº›è®¾å¤‡.<br />
å½“åˆå§‹åŒ–å®Œæˆ PCI æ€»çº¿å’Œä¸€äº›é‡è¦è®¾å¤‡å, å®ƒå¼€å§‹åœ¨å­˜å‚¨ç›˜ä¸­æœç´¢å¼•å¯¼è®¾å¤‡(bootable device), ä»¥å¯åŠ¨boot loader.</p>

<h2 id="part-2-the-boot-loader">Part 2: The Boot Loader</h2>
<p>PC çš„è½¯ç›˜ç¡¬ç›˜ä¼šè¢«åˆ†æˆ 512 bytes çš„æ‰‡åŒº(sectors), æ‰‡åŒºæ˜¯ç›˜çš„æœ€å°ä¼ è¾“ç²’åº¦(minimum transfer granularity). ä¸€ä¸ªå¯å¼•å¯¼ç›˜çš„ç¬¬ä¸€ä¸ªæ‰‡åŒºè¢«å«åšå¼•å¯¼æ‰‡åŒº(boot sector), é‡Œé¢æœ‰ boot loader çš„ä»£ç . å¦‚æœ BIOS æ‰¾åˆ°äº†å¯å¼•å¯¼ç›˜, å®ƒä¼šæŠŠ boot loader è¯»è¿›ç‰©ç†å†…å­˜çš„ 0x7c00~0x7dff (512 bytes), ç„¶åä½¿ç”¨ <code class="language-plaintext highlighter-rouge">jmp</code> è·³åˆ° <code class="language-plaintext highlighter-rouge">0000:7c00</code>.<br />
CD-ROMS çš„ä¸€ä¸ªæ‰‡åŒºæœ‰ 2048 bytes, boot loader ä¹Ÿä¼šéšä¹‹å˜å¤§, BIOS è¯»å–çš„å†…å®¹ä¹Ÿè¦éšä¹‹å˜å¤§. è¯¦è§ <a href="https://pdos.csail.mit.edu/6.828/2018/readings/boot-cdrom.pdf"><em>â€œEl Toritoâ€ Bootable CD-ROM Format Specification</em></a>. ç•¥.</p>

<p>æ¥ç€æ˜¯ä¸¤ä¸ªæºä»£ç , <code class="language-plaintext highlighter-rouge">boot/boot.S</code> å’Œ <code class="language-plaintext highlighter-rouge">boot/main.c</code>, æ ¹æ®å”çš„æ–‡ç« , è¿™ä¸¤ä¸ªä»£ç å¿…é¡»å®Œå…¨å¼„æ‡‚.<br />
boot/boot.S</p>
<pre><code class="language-asm">#include &lt;inc/mmu.h&gt;             # Memory Management Unit å†…å­˜ç®¡ç†å•å…ƒ

# Start the CPU: switch to 32-bit protected mode, jump into C.
# The BIOS loads this code from the first sector of the hard disk into
# memory at physical address 0x7c00 and starts executing in real mode
# with %cs=0 %ip=7c00.
# å¯åŠ¨ CPU, åˆ‡æ¢åˆ° 32 ä½ä¿æŠ¤æ¨¡å¼, ç„¶åè·³è½¬åˆ° C. 
# è¿™æ®µä»£ç å°±æ˜¯ boot loader, BIOS ä¼šä»ç¡¬ç›˜çš„ç¬¬ä¸€ä¸ªæ‰‡åŒºè¯»å–å®ƒä»¬åˆ°ç‰©ç†å†…å­˜çš„ 0x7c00, 
# ç„¶ååœ¨å®æ¨¡å¼ä¸­ä» 0000:7c00 å¼€å§‹æ‰§è¡Œ. 

.set PROT_MODE_CSEG, 0x8         # å†…æ ¸çš„ CS é€‰æ‹©å™¨
.set PROT_MODE_DSEG, 0x10        # å†…æ ¸çš„ DS é€‰æ‹©å™¨
.set CR0_PE_ON,      0x1         # ä¿æŠ¤æ¨¡å¼å¯åŠ¨æ ‡å¿—, CR0, Exercise 2 ä¸­æœ‰æåˆ°

.globl start
start:
  .code16                     # Assemble for 16-bit mode
  cli                         # Disable interrupts
  cld                         # String operations increment. DF = 0, å¢æ–¹å‘

  # Set up the important data segment registers (DS, ES, SS).
  xorw    %ax,%ax             # ax = 0
  movw    %ax,%ds             # ds = 0
  movw    %ax,%es             # es = 0
  movw    %ax,%ss             # ss = 0

  # Enable A20:
  #   For backwards compatibility with the earliest PCs, physical
  #   address line 20 is tied low, so that addresses higher than
  #   1MB wrap around to zero by default.  This code undoes this.
  # å¼€å¯ A20:
  #   åŒæ ·åœ¨ Exercise 2 ä¸­æœ‰æåˆ°è¿‡.
  #   ç‰©ç†åœ°å€çº¿ 20 å¼€å¯, è¿™æ ·å¯ä»¥ä¿è¯è‰¯å¥½çš„å‘åå…¼å®¹æ€§.
  #
# seta20.1 æ˜¯å‘é”®ç›˜æ§åˆ¶å™¨çš„ 0x64 ç«¯å£å‘é€ 0x61 å‘½ä»¤, è¿™ä¸ªå‘½ä»¤çš„æ„æ€æ˜¯è¦å‘é”®ç›˜æ§åˆ¶å™¨çš„ P2 å†™å…¥æ•°æ®.
seta20.1:
  inb     $0x64,%al               # Wait for not busy
  # if al &amp; 0x2 == 0, ZF ç½®ä½.
  # ç›¸å½“äº bit2 ä¸º 0 æ—¶, ZF ç½®ä½.
  testb   $0x2,%al
  # if ZF == 0, jmp.
  # ç›¸å½“äº bit2 ä¸º 0 æ—¶, è·³è½¬, å¦åˆ™å¾ªç¯ç›´åˆ° bit2 ä¸ºç©ºä½.
  # 0x64 ç«¯å£æ˜¯ KB controller read status, é”®ç›˜æ§åˆ¶å™¨è¯»çŠ¶æ€å¯„å­˜å™¨.
  jnz     seta20.1

  # å‘ 0x64 ç«¯å£å†™å…¥ 0xd1.
  # 0x60 æ¥å£æ˜¯ PS/2 ç¡¬ä»¶æ¥å£æˆ–è€… PS/2 æ§åˆ¶å™¨æœ¬èº«è¯»/å†™æ•°æ®.
  # 0x64 æ˜¯çŠ¶æ€å¯„å­˜å™¨.
  # å°† 0xd1 å†™å…¥ 0x64 ç«¯å£, æ˜¯è®¾ç½®è¿™ä¸ªçŠ¶æ€å¯„å­˜å™¨, 
  # ä½¿å¯ä»¥é€šè¿‡ 0x60 ç«¯å£å†™å…¥æ•°æ®è€Œæ§åˆ¶ PS/2 çš„çŠ¶æ€.
  movb    $0xd1,%al               # 0xd1 -&gt; port 0x64
  outb    %al,$0x64

seta20.2:
  # åŒä¸Š. æ£€æµ‹ç¼“å†²åŒºæ˜¯å¦æœ‰ç©ºä½, æ²¡æœ‰åˆ™ç­‰å¾….
  inb     $0x64,%al               # Wait for not busy
  testb   $0x2,%al
  jnz     seta20.2

  # å°† 0xdf å†™å…¥ 0x60, å¼€å¯ A20 åœ°å€æ€»çº¿.
  # ä½†æ˜¯ Exercise 2 ä¸­å‡ºç°çš„æ˜¯å°† 0x60 çš„ bit1 ç½®ä¸º 1.
  # åŸå› ä¸æ˜.
  movb    $0xdf,%al               # 0xdf -&gt; port 0x60
  outb    %al,$0x60

  # Switch from real to protected mode, using a bootstrap GDT
  # and segment translation that makes virtual addresses 
  # identical to their physical addresses, so that the 
  # effective memory map does not change during the switch.
  # ä»å®æ¨¡å¼åˆ‡æ¢åˆ°ä¿æŠ¤æ¨¡å¼çš„å‡†å¤‡å·¥ä½œ.
  # å°† gdtdesc(åœ¨ä»£ç æœ€å) åŠ è½½åˆ° GDTR ä¸­.
  # GDT æ˜¯å…¨å±€æè¿°ç¬¦è¡¨, GDTR æ˜¯å…¨å±€æè¿°ç¬¦è¡¨å¯„å­˜å™¨.
  # æƒ³è¦åœ¨ä¿æŠ¤æ¨¡å¼ä¸‹å¯¹å†…å­˜è¿›è¡Œå¯»å€å°±å…ˆè¦æœ‰ GDT, GDT è¡¨é‡Œæ¯ä¸€é¡¹å«åšæ®µæè¿°ç¬¦, 
  # ç”¨æ¥è®°å½•æ¯ä¸ªå†…å­˜åˆ†æ®µçš„ä¸€äº›å±æ€§ä¿¡æ¯, æ¯ä¸ªæ®µæè¿°ç¬¦å 8å­—èŠ‚.
  # CPU ä½¿ç”¨ GDTR å¯„å­˜å™¨æ¥ä¿å­˜æˆ‘ä»¬ GDT åœ¨å†…å­˜ä¸­çš„ä½ç½®å’Œ GDT çš„é•¿åº¦.
  # æ‰€ä»¥æ‰æœ‰äº† gdtdesc é‡Œé¢çš„å†…å®¹.
  lgdt    gdtdesc
  # å°† CR0 çš„ bit0 ç½® 1, å‡†å¤‡è¿›å…¥ä¿æŠ¤æ¨¡å¼.
  movl    %cr0, %eax
  orl     $CR0_PE_ON, %eax
  movl    %eax, %cr0

  # Jump to next instruction, but in 32-bit code segment.
  # Switches processor into 32-bit mode.
  # é•¿è·³è½¬åˆ° protcseg, $PROT_MODE_CSEG æ˜¯å‰é¢è®¾ç½®çš„ CS å®(?)
  ljmp    $PROT_MODE_CSEG, $protcseg

  .code32                     # Assemble for 32-bit mode
protcseg:
  # Set up the protected-mode data segment registers
  # éƒ¨ç½²ä¿æŠ¤æ¨¡å¼æ•°æ®æ®µå¯„å­˜å™¨, è·Ÿ Exercise 2 ä¸­çš„ç±»ä¼¼.
  movw    $PROT_MODE_DSEG, %ax    # Our data segment selector
  movw    %ax, %ds                # -&gt; DS: Data Segment
  movw    %ax, %es                # -&gt; ES: Extra Segment
  movw    %ax, %fs                # -&gt; FS
  movw    %ax, %gs                # -&gt; GS
  movw    %ax, %ss                # -&gt; SS: Stack Segment

  # Set up the stack pointer and call into C.
  # å°†æ ˆåŒºè®¾ç½®åœ¨ $start å¤„
  # å› ä¸ºæ ˆçš„å·¥ä½œæ¨¡å¼æ˜¯åœ°å€å‡ä¸ºå¢æ–¹å‘, æ‰€ä»¥ä¸ä¼šå½±å“ä»£ç éƒ¨åˆ†.
  movl    $start, %esp
  # è°ƒç”¨ C æ¥å£ bootmain.
  call bootmain

  # If bootmain returns (it shouldn't), loop.
  # æ­»å¾ªç¯.
spin:
  jmp spin

# Bootstrap GDT
# è®¾ç½® 4 å­—èŠ‚å¯¹é½
.p2align 2                                # force 4 byte alignment
# åˆå§‹åŒ– gtd è¡¨
gdt:
  SEG_NULL                              # null seg
  SEG(STA_X|STA_R, 0x0, 0xffffffff)     # code seg
  SEG(STA_W, 0x0, 0xffffffff)           # data seg

gdtdesc:
  .word   0x17                            # sizeof(gdt) - 1
  .long   gdt                             # address gdt
</code></pre>
<p>boot/main.c</p>
<div class="language-c highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="cp">#include &lt;inc/x86.h&gt;
#include &lt;inc/elf.h&gt;
</span>
<span class="cm">/**********************************************************************
 * This a dirt simple boot loader, whose sole job is to boot
 * an ELF kernel image from the first IDE hard disk.
 * è¿™æ˜¯ä¸€ä¸ªç®€å•çš„ boot loader, ä½œç”¨ä»…ä»…æ˜¯ä» IDE ç¡¬ç›˜å¼•å¯¼ ELF å†…æ ¸é•œåƒ.
 *
 * DISK LAYOUT
 *  * This program(boot.S and main.c) is the bootloader.  It should
 *    be stored in the first sector of the disk.
 *  * æ³¨æ„ boot.S å’Œ main.c ä¸€èµ·æ‰æ˜¯ boot loader. éœ€è¦è¢«å­˜å‚¨åœ¨ç›˜çš„ç¬¬ä¸€æ‰‡åŒº.
 *
 *  * The 2nd sector onward holds the kernel image.
 *  * ç¬¬äºŒæ‰‡åŒºå¼€å§‹å­˜æ”¾å†…æ ¸é•œåƒ.
 *
 *  * The kernel image must be in ELF format.
 *  * å†…æ ¸é•œåƒå¿…é¡»æ˜¯ ELF æ ¼å¼.
 *
 * BOOT UP STEPS
 *  * when the CPU boots it loads the BIOS into memory and executes it
 *
 *  * the BIOS intializes devices, sets of the interrupt routines, and 
 *    reads the first sector of the boot device(e.g., hard-drive)
 *    into memory and jumps to it.
 *  * BIOS åˆå§‹åŒ–è®¾å¤‡å’Œä¸€äº›ä¸­æ–­ç¨‹å¼, ç„¶åä»å¼•å¯¼è®¾å¤‡è¯»å…¥ç¬¬ä¸€ä¸ªæ‰‡åŒºåˆ°å†…å­˜åè·³è½¬.
 *
 *  * Assuming this boot loader is stored in the first sector of the
 *    hard-drive, this code takes over...
 *
 *  * control starts in boot.S -- which sets up protected mode,
 *    and a stack so C code then run, then calls bootmain()
 *  * æ‰§è¡Œ boot.S, ç”¨æ¥éƒ¨ç½²ä¿æŠ¤æ¨¡å¼å’Œèƒ½å¤Ÿè®© C ä»£ç è¿è¡Œçš„æ ˆ, ç„¶åè°ƒç”¨ C æ¥å£ `bootmain()`.
 *
 *  * bootmain() in this file takes over, reads in the kernel and jumps to it.
 **********************************************************************/</span>

<span class="cm">/**********************************************************************
è¿™æ®µæ³¨é‡Šç›´æ¥ç™½å«–è‡ªå”çš„æ–‡ç« [2].
// The definition of struct Elf.
struct Elf {
 	    uint32_t e_magic;               // must equal ELF_MAGIC. ä¿å­˜äº† 4 ä¸ª char, "\0x7FELF", ç”¨æ¥æ ¡éªŒæ˜¯å¦æ˜¯ä¸€ä¸ª Elf ç»“æ„ä½“
 	    uint8_t  e_elf[12];             // åº”è¯¥æ˜¯å…³äºä¸€äº›å¹³å°ç›¸å…³çš„è®¾ç½®, å…³ç³»åˆ°å¦‚ä½•è¯‘ç å’Œè§£é‡Šæ–‡ä»¶å†…å®¹å­˜  ç–‘. 
 	    uint16_t e_type;                // è¯¥æ–‡ä»¶çš„ç±»å‹
 	    uint16_t e_machine;             // è¯¥æ–‡ä»¶éœ€è¦çš„ä½“ç³»ç»“æ„
 	    uint32_t e_version;             // æ–‡ä»¶çš„ç‰ˆæœ¬
 	    uint32_t e_entry;               // ç¨‹åºçš„å…¥å£åœ°å€
 	    uint32_t e_phoff;               // è¡¨ç¤º Program header table åœ¨æ–‡ä»¶ä¸­çš„åç§»é‡(ä»¥å­—èŠ‚è®¡ç®—)
 	    uint32_t e_shoff;               // è¡¨ç¤º Section header table åœ¨æ–‡ä»¶ä¸­çš„åç§»é‡(ä»¥å­—èŠ‚è®¡ç®—)
 	    uint32_t e_flags;               // å¯¹ IA32 è€Œè¨€, æ­¤é¡¹ä¸º 0. 
 	    uint16_t e_ehsize;              // è¡¨ç¤º ELF header å¤§å°
 	    uint16_t e_phentsize;           // è¡¨ç¤º Program header table ä¸­æ¯ä¸€ä¸ªæ¡ç›®çš„å¤§å°
 	    uint16_t e_phnum;               // è¡¨ç¤º Program header table ä¸­æœ‰å¤šå°‘ä¸ªæ¡ç›®
 	    uint16_t e_shentsize;           // è¡¨ç¤º Section header table ä¸­æ¯ä¸€ä¸ªæ¡ç›®çš„å¤§å°
 	    uint16_t e_shnum;               // è¡¨ç¤º Section header table ä¸­æœ‰å¤šå°‘ä¸ªæ¡ç›®
 	    uint16_t e_shstrndx;            // è¡¨ç¤ºåŒ…å«èŠ‚åç§°çš„å­—ç¬¦ä¸²æ˜¯ç¬¬å‡ ä¸ªèŠ‚
};

// The definition of struct Proghdr.
struct Proghdr {
    uint32_t p_type;                  // å½“å‰ program çš„æ®µç±»å‹
		uint32_t p_offset;                // æ®µçš„ç¬¬ä¸€ä¸ªå­—èŠ‚åœ¨æ–‡ä»¶ä¸­çš„åç§»
		uint32_t p_va;                    // æ®µçš„ç¬¬ä¸€ä¸ªå­—èŠ‚åœ¨æ–‡ä»¶ä¸­çš„è™šæ‹Ÿåœ°å€
		uint32_t p_pa;                    // æ®µçš„ç¬¬ä¸€ä¸ªå­—èŠ‚åœ¨æ–‡ä»¶ä¸­çš„ç‰©ç†åœ°å€, åœ¨ç‰©ç†å†…å­˜å®šä½ç›¸å…³çš„ç³»ç»Ÿä¸­ä½¿ç”¨
		uint32_t p_filesz;                // æ®µåœ¨æ–‡ä»¶ä¸­çš„é•¿åº¦
		uint32_t p_memsz;                 // æ®µåœ¨å†…å­˜ä¸­çš„é•¿åº¦
		uint32_t p_flags;                 // ä¸æ®µç›¸å…³çš„æ ‡è¯†ä½
		uint32_t p_align;                 // æ ¹æ®æ­¤é¡¹æ¥ç¡®å®šæ®µåœ¨æ–‡ä»¶ä»¥åŠå†…å­˜ä¸­å¦‚ä½•å¯¹é½
};
 **********************************************************************/</span>

<span class="c1">// æ‰‡åŒºå¤§å°</span>
<span class="cp">#define SECTSIZE        512
</span><span class="c1">// ä¸€ä¸ª ELF è¡¨å­˜åœ¨ 0x10000.</span>
<span class="cp">#define ELFHDR          ((struct Elf *) 0x10000) // scratch space
</span>
<span class="kt">void</span> <span class="nf">readsect</span><span class="p">(</span><span class="kt">void</span><span class="o">*</span><span class="p">,</span> <span class="kt">uint32_t</span><span class="p">);</span>
<span class="kt">void</span> <span class="nf">readseg</span><span class="p">(</span><span class="kt">uint32_t</span><span class="p">,</span> <span class="kt">uint32_t</span><span class="p">,</span> <span class="kt">uint32_t</span><span class="p">);</span>

<span class="kt">void</span>
<span class="nf">bootmain</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
        <span class="c1">// program header table, ç¬¬ä¸€ä¸ªæ˜¯æŒ‡å‘è¡¨ä¸­ program header çš„æŒ‡é’ˆ.</span>
        <span class="c1">// eph æ˜¯ end of program header.</span>
        <span class="k">struct</span> <span class="n">Proghdr</span> <span class="o">*</span><span class="n">ph</span><span class="p">,</span> <span class="o">*</span><span class="n">eph</span><span class="p">;</span>

        <span class="c1">// read 1st page off disk</span>
        <span class="c1">// è¯»å–ä» 0 å¼€å§‹çš„ 8 ä¸ªæ‰‡åŒºæ”¾å…¥ ELFHDR ä½ç½®.</span>
        <span class="n">readseg</span><span class="p">((</span><span class="kt">uint32_t</span><span class="p">)</span> <span class="n">ELFHDR</span><span class="p">,</span> <span class="n">SECTSIZE</span><span class="o">*</span><span class="mi">8</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>

        <span class="c1">// is this a valid ELF?</span>
        <span class="c1">// æ ¡éªŒå®ƒæ˜¯ä¸æ˜¯ Elf ç»“æ„ä½“. </span>
        <span class="k">if</span> <span class="p">(</span><span class="n">ELFHDR</span><span class="o">-&gt;</span><span class="n">e_magic</span> <span class="o">!=</span> <span class="n">ELF_MAGIC</span><span class="p">)</span>
                <span class="k">goto</span> <span class="n">bad</span><span class="p">;</span>

        <span class="c1">// load each program segment (ignores ph flags)</span>
        <span class="c1">// è¯»å– program header table, åœ°å€æ˜¯ ELFHDR + pht offset</span>
        <span class="n">ph</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">Proghdr</span> <span class="o">*</span><span class="p">)</span> <span class="p">((</span><span class="kt">uint8_t</span> <span class="o">*</span><span class="p">)</span> <span class="n">ELFHDR</span> <span class="o">+</span> <span class="n">ELFHDR</span><span class="o">-&gt;</span><span class="n">e_phoff</span><span class="p">);</span>
        <span class="c1">// end of program header, program header table çš„æœ€åä¸€ä¸ªæ¡ç›®çš„ä¸‹ä¸€ä¸ªä½ç½®. </span>
        <span class="n">eph</span> <span class="o">=</span> <span class="n">ph</span> <span class="o">+</span> <span class="n">ELFHDR</span><span class="o">-&gt;</span><span class="n">e_phnum</span><span class="p">;</span>
        <span class="c1">// å°† program headers è¯»å…¥å†…å­˜</span>
        <span class="k">for</span> <span class="p">(;</span> <span class="n">ph</span> <span class="o">&lt;</span> <span class="n">eph</span><span class="p">;</span> <span class="n">ph</span><span class="o">++</span><span class="p">)</span>
                <span class="c1">// p_pa is the load address of this segment (as well</span>
                <span class="c1">// as the physical address)</span>
                <span class="c1">// ä» offset è¯» memsz é•¿åº¦çš„æ•°æ®åˆ° pa é‡Œ.</span>
                <span class="n">readseg</span><span class="p">(</span><span class="n">ph</span><span class="o">-&gt;</span><span class="n">p_pa</span><span class="p">,</span> <span class="n">ph</span><span class="o">-&gt;</span><span class="n">p_memsz</span><span class="p">,</span> <span class="n">ph</span><span class="o">-&gt;</span><span class="n">p_offset</span><span class="p">);</span>

        <span class="c1">// call the entry point from the ELF header</span>
        <span class="c1">// note: does not return!</span>
        <span class="c1">// è¿è¡Œç¨‹åºå…¥å£</span>
        <span class="p">((</span><span class="kt">void</span> <span class="p">(</span><span class="o">*</span><span class="p">)(</span><span class="kt">void</span><span class="p">))</span> <span class="p">(</span><span class="n">ELFHDR</span><span class="o">-&gt;</span><span class="n">e_entry</span><span class="p">))();</span>

<span class="nl">bad:</span>
        <span class="c1">// 0x8A00 å†™å…¥ 0x8A00 ç«¯å£, 0x8A00 å†™å…¥ 0x8E00 ç«¯å£</span>
        <span class="c1">// å¼€å¯ IO Debug</span>
        <span class="c1">// å¯ä»¥åœ¨ bocks çš„è°ƒè¯•å™¨ä¸­çœ‹åˆ°çŠ¶æ€</span>
        <span class="n">outw</span><span class="p">(</span><span class="mh">0x8A00</span><span class="p">,</span> <span class="mh">0x8A00</span><span class="p">);</span>
        <span class="n">outw</span><span class="p">(</span><span class="mh">0x8A00</span><span class="p">,</span> <span class="mh">0x8E00</span><span class="p">);</span>
        <span class="k">while</span> <span class="p">(</span><span class="mi">1</span><span class="p">)</span>
                <span class="cm">/* do nothing */</span><span class="p">;</span>
<span class="p">}</span>

<span class="c1">// Read 'count' bytes at 'offset' from kernel into physical address 'pa'.</span>
<span class="c1">// Might copy more than asked</span>
<span class="c1">// ä»å†…æ ¸çš„ offset è¯»å– count ä¸ªå­—èŠ‚è¿›ç‰©ç†åœ°å€ pa</span>
<span class="kt">void</span>
<span class="nf">readseg</span><span class="p">(</span><span class="kt">uint32_t</span> <span class="n">pa</span><span class="p">,</span> <span class="kt">uint32_t</span> <span class="n">count</span><span class="p">,</span> <span class="kt">uint32_t</span> <span class="n">offset</span><span class="p">)</span>
<span class="p">{</span>
        <span class="kt">uint32_t</span> <span class="n">end_pa</span><span class="p">;</span>

        <span class="n">end_pa</span> <span class="o">=</span> <span class="n">pa</span> <span class="o">+</span> <span class="n">count</span><span class="p">;</span>

        <span class="c1">// round down to sector boundary</span>
        <span class="c1">// æŠ¹æ‰ä½ä½çš„æ•°å­—, é”å®šåˆ°æ‰‡åŒºè¾¹ç•Œ.</span>
        <span class="c1">// æ¯”å¦‚è¿™é‡Œ SECTSIZE ä¸º 512, å‡ä¸€æ±‚åå, äºŒè¿›åˆ¶ä½ 9 ä½å‡ä¸º 0, é«˜ä½å…¨ä¸º 1.</span>
        <span class="c1">// åŸåœ°åšä¸è¿ç®—å¯ä»¥å°†ä½ 9 ä½æŠ¹æˆ 0.</span>
        <span class="n">pa</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="p">(</span><span class="n">SECTSIZE</span> <span class="o">-</span> <span class="mi">1</span><span class="p">);</span>

        <span class="c1">// translate from bytes to sectors, and kernel starts at sector 1</span>
        <span class="c1">// å°† offset çš„å•ä½ç”±å­—èŠ‚è®¡ç®—æˆæ‰‡åŒº. å†…æ ¸æ˜¯ä»æ‰‡åŒº 1 å¼€å§‹çš„, æ‰€ä»¥å†åŠ  1.</span>
        <span class="n">offset</span> <span class="o">=</span> <span class="p">(</span><span class="n">offset</span> <span class="o">/</span> <span class="n">SECTSIZE</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span><span class="p">;</span>

        <span class="c1">// If this is too slow, we could read lots of sectors at a time.</span>
        <span class="c1">// We'd write more to memory than asked, but it doesn't matter --</span>
        <span class="c1">// we load in increasing order.</span>
        <span class="k">while</span> <span class="p">(</span><span class="n">pa</span> <span class="o">&lt;</span> <span class="n">end_pa</span><span class="p">)</span> <span class="p">{</span>
                <span class="c1">// Since we haven't enabled paging yet and we're using</span>
                <span class="c1">// an identity segment mapping (see boot.S), we can</span>
                <span class="c1">// use physical addresses directly.  This won't be the</span>
                <span class="c1">// case once JOS enables the MMU.</span>
                <span class="c1">// ä»ç¼–å·ä¸º offset çš„æ‰‡åŒºè¯»å–æ•°æ®è¿›æ–‡ä»¶çš„ç‰©ç†åœ°å€</span>
                <span class="n">readsect</span><span class="p">((</span><span class="kt">uint8_t</span><span class="o">*</span><span class="p">)</span> <span class="n">pa</span><span class="p">,</span> <span class="n">offset</span><span class="p">);</span>
                <span class="n">pa</span> <span class="o">+=</span> <span class="n">SECTSIZE</span><span class="p">;</span>
                <span class="n">offset</span><span class="o">++</span><span class="p">;</span>
        <span class="p">}</span>
<span class="p">}</span>

<span class="kt">void</span>
<span class="nf">waitdisk</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
        <span class="c1">// wait for disk reaady</span>
        <span class="c1">// ä¸€ç›´ä» 0x1f7 è¯»å–æ•°æ®, ç›´è‡³å®ƒç©ºé—².</span>
        <span class="c1">// 0x40 è¿™ä¸ªä½ä¸º 1 æ—¶, è¡¨ç¤ºç©ºé—².</span>
        <span class="k">while</span> <span class="p">((</span><span class="n">inb</span><span class="p">(</span><span class="mh">0x1F7</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xC0</span><span class="p">)</span> <span class="o">!=</span> <span class="mh">0x40</span><span class="p">)</span>
                <span class="cm">/* do nothing */</span><span class="p">;</span>
<span class="p">}</span>

<span class="c1">// è¯»å…¥ä¸€ä¸ªæ‰‡åŒº</span>
<span class="kt">void</span>
<span class="nf">readsect</span><span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="n">dst</span><span class="p">,</span> <span class="kt">uint32_t</span> <span class="n">offset</span><span class="p">)</span>
<span class="p">{</span>
        <span class="c1">// wait for disk to be ready</span>
        <span class="n">waitdisk</span><span class="p">();</span>

        <span class="c1">// outb(port, data);</span>
        <span class="c1">// å‘ç«¯å£è¾“å‡ºæ•°æ®</span>
        <span class="n">outb</span><span class="p">(</span><span class="mh">0x1F2</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>         <span class="c1">// count = 1</span>
        <span class="c1">// offset å¤ªé•¿äº†, æ‰€ä»¥åˆ†æ®µ</span>
        <span class="n">outb</span><span class="p">(</span><span class="mh">0x1F3</span><span class="p">,</span> <span class="n">offset</span><span class="p">);</span>
        <span class="n">outb</span><span class="p">(</span><span class="mh">0x1F4</span><span class="p">,</span> <span class="n">offset</span> <span class="o">&gt;&gt;</span> <span class="mi">8</span><span class="p">);</span>
        <span class="n">outb</span><span class="p">(</span><span class="mh">0x1F5</span><span class="p">,</span> <span class="n">offset</span> <span class="o">&gt;&gt;</span> <span class="mi">16</span><span class="p">);</span>
        <span class="n">outb</span><span class="p">(</span><span class="mh">0x1F6</span><span class="p">,</span> <span class="p">(</span><span class="n">offset</span> <span class="o">&gt;&gt;</span> <span class="mi">24</span><span class="p">)</span> <span class="o">|</span> <span class="mh">0xE0</span><span class="p">);</span>
        <span class="n">outb</span><span class="p">(</span><span class="mh">0x1F7</span><span class="p">,</span> <span class="mh">0x20</span><span class="p">);</span>      <span class="c1">// cmd 0x20 - read sectors</span>

        <span class="c1">// wait for disk to be ready</span>
        <span class="n">waitdisk</span><span class="p">();</span>

        <span class="c1">// read a sector</span>
        <span class="c1">// 0x1F0 æ˜¯ç¡¬ç›˜æ¥å£çš„æ•°æ®ç«¯å£, æ˜¯ä¸€ä¸ª 16 ä½ç«¯å£.</span>
        <span class="c1">// ä¸€æ—¦ç¡¬ç›˜ç©ºé—²ä¸”å‡†å¤‡å°±ç»ª, å°±å¯ä»¥è¿ç»­ä»è¿™ä¸ªç«¯å£å†™å…¥æˆ–è¯»å–æ•°æ®.</span>
        <span class="c1">// ç¬¬ä¸‰ä¸ªå‚æ•°æ˜¯åŒå­—, æ‰€ä»¥è¦é™¤ä»¥ 4.</span>
        <span class="n">insl</span><span class="p">(</span><span class="mh">0x1F0</span><span class="p">,</span> <span class="n">dst</span><span class="p">,</span> <span class="n">SECTSIZE</span><span class="o">/</span><span class="mi">4</span><span class="p">);</span>
<span class="p">}</span>
</code></pre></div></div>

<p>åŸæ–‡åœ¨ Exercise3 ç»“æŸä¹‹å, æäº†å‡ ä¸ªé—®é¢˜:</p>
<ul>
  <li>Q: At what point does the processor start executing 32-bit code? What exactly causes the switch from 16- to 32-bit mode?</li>
  <li>Q: What is the last instruction of the boot loader executed, and what is the first instruction of the kernel it just loaded?</li>
  <li>Q: Where is the first instruction of the kernel?</li>
  <li>Q: How does the boot loader decide how many sectors it must read in order to fetch the entire kernel from disk? Where does it find this information?</li>
</ul>

<p>è€å®è¯´è¿™äº›é—®é¢˜æˆ‘éƒ½å›ç­”ä¸ä¸Šæ¥. å…ˆæ”¾ç€. æ—¢ç„¶æ˜¯è¦æ±‚çš„ä¸€å®šä¼šè¡¥ä¸Š.</p>

<h3 id="loading-the-kernel">Loading the Kernel</h3>
<p>æ©, ä¸€ä¸Šæ¥å°±æ˜¯ Exercise 4.<br />
ELF æ˜¯ Executable and Linkable Format çš„ç¼©å†™. ç¼–è¯‘å™¨å…ˆå°† C æºæ–‡ä»¶(<code class="language-plaintext highlighter-rouge">*.c</code>)ç¼–è¯‘æˆç›®æ ‡æ–‡ä»¶(<code class="language-plaintext highlighter-rouge">*.o</code>), ç›®æ ‡æ–‡ä»¶åŒ…å«æ±‡ç¼–ç¼–ç æˆçš„ç¡¬ä»¶å¯æ‰§è¡Œçš„äºŒè¿›åˆ¶æ ¼å¼. Full information about this format is available in the <a href="https://pdos.csail.mit.edu/6.828/2018/readings/elf.pdf">ELF specification</a> on our reference page. ELF å¾ˆå¤æ‚ä¸æ˜¯è¿™ä¸ªè¯¾ç¨‹çš„éƒ¨åˆ†, æ‰€ä»¥ç›´æ¥å‚è€ƒ <a href="http://en.wikipedia.org/wiki/Executable_and_Linkable_Format">Wikipedia Page</a>.</p>

<p>ä¸€ä¸ª ELF binary æœ‰å®šé•¿çš„ ELF header, C å®šä¹‰çš„è¿™ä¸ªå¤´ä¸º <code class="language-plaintext highlighter-rouge">inc/elf.h</code>. æˆ‘ä»¬éœ€è¦å…³æ³¨çš„éƒ¨åˆ†æ˜¯:</p>
<ul>
  <li><code class="language-plaintext highlighter-rouge">.text</code>, ç¨‹åºæ‰§è¡ŒæŒ‡ä»¤.</li>
  <li><code class="language-plaintext highlighter-rouge">.rodata</code>, read-only æ•°æ®, æ¯”å¦‚ ASCII å¸¸é‡.</li>
  <li><code class="language-plaintext highlighter-rouge">.data</code>, æ•°æ®æ®µæŒæœ‰ç¨‹åºçš„åˆå§‹åŒ–æ•°æ®, æ¯”å¦‚å…¨å±€å˜é‡å£°æ˜çš„ <code class="language-plaintext highlighter-rouge">int x = 5;</code>.</li>
</ul>

<p>å½“é“¾æ¥å™¨è®¡ç®—ç¨‹åºå†…å­˜å¸ƒå±€æ—¶, ä¼šä¸ºæœªåˆå§‹åŒ–å…¨å±€å˜é‡(uninitialized global variables)ä¿ç•™ç©ºé—´, è¿™æ®µæ˜¯ç´§è·Ÿåœ¨ <code class="language-plaintext highlighter-rouge">.data</code> ä¹‹åçš„ <code class="language-plaintext highlighter-rouge">.bss</code> æ®µ. C ä¼šå°†æœªåˆå§‹åŒ–çš„ <code class="language-plaintext highlighter-rouge">.bss</code> æ®µåˆå§‹åŒ–ä¸º 0.<br />
æ¥ç€ä»–è®©æˆ‘ä»¬è‡ªå·±ä½¿ç”¨ objdump å·¥å…·æ£€æŸ¥ç¨‹åºçš„æ®µ, ä½¿ç”¨ <code class="language-plaintext highlighter-rouge">-h</code> å‚æ•°. åœ¨ <code class="language-plaintext highlighter-rouge">.text</code> æ®µä¸­, VMA è¡¨ç¤º link address, LMA è¡¨ç¤º load address. æ¯”å¦‚æˆ‘ä»¬ä½¿ç”¨åŸæ–‡ä¸­ä¸¾ä¾‹çš„ boot loader æ–‡ä»¶:</p>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>$ objdump -h obj/boot/boot.out 

obj/boot/boot.out:     file format elf32-i386

Sections:
Idx Name          Size      VMA       LMA       File off  Algn
  0 .text         00000186  00007c00  00007c00  00000074  2**2
                  CONTENTS, ALLOC, LOAD, CODE
  1 .eh_frame     000000a8  00007d88  00007d88  000001fc  2**2
                  CONTENTS, ALLOC, LOAD, READONLY, DATA
  2 .stab         00000720  00000000  00000000  000002a4  2**2
                  CONTENTS, READONLY, DEBUGGING
  3 .stabstr      0000088f  00000000  00000000  000009c4  2**0
                  CONTENTS, READONLY, DEBUGGING
  4 .comment      00000035  00000000  00000000  00001253  2**0
                  CONTENTS, READONLY
</code></pre></div></div>
<p><code class="language-plaintext highlighter-rouge">-x</code> å‚æ•°å¯ä»¥è¾“å‡ºç¨‹åºå¤´ä¿¡æ¯å’Œé“¾æ¥å™¨ä½¿ç”¨çš„ç¬¦å·è¡¨.</p>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>$ objdump -x obj/kern/kernel

obj/kern/kernel:     file format elf32-i386
obj/kern/kernel
architecture: i386, flags 0x00000112:
EXEC_P, HAS_SYMS, D_PAGED
start address 0x0010000c

Program Header:
    LOAD off    0x00001000 vaddr 0xf0100000 paddr 0x00100000 align 2**12
         filesz 0x00007120 memsz 0x00007120 flags r-x
    LOAD off    0x00009000 vaddr 0xf0108000 paddr 0x00108000 align 2**12
         filesz 0x0000a948 memsz 0x0000a948 flags rw-
   STACK off    0x00000000 vaddr 0x00000000 paddr 0x00000000 align 2**4
         filesz 0x00000000 memsz 0x00000000 flags rwx

Sections:
Idx Name          Size      VMA       LMA       File off  Algn
  0 .text         00001871  f0100000  00100000  00001000  2**4
                  CONTENTS, ALLOC, LOAD, READONLY, CODE
  1 .rodata       00000714  f0101880  00101880  00002880  2**5
                  CONTENTS, ALLOC, LOAD, READONLY, DATA
  2 .stab         000038d1  f0101f94  00101f94  00002f94  2**2
                  CONTENTS, ALLOC, LOAD, READONLY, DATA
  3 .stabstr      000018bb  f0105865  00105865  00006865  2**0
                  CONTENTS, ALLOC, LOAD, READONLY, DATA
  4 .data         0000a300  f0108000  00108000  00009000  2**12
                  CONTENTS, ALLOC, LOAD, DATA
  5 .bss          00000648  f0112300  00112300  00013300  2**5
                  CONTENTS, ALLOC, LOAD, DATA
  6 .comment      00000035  00000000  00000000  00013948  2**0
                  CONTENTS, READONLY
SYMBOL TABLE:
f0100000 l    d  .text	00000000 .text
f0101880 l    d  .rodata	00000000 .rodata
f0101f94 l    d  .stab	00000000 .stab
f0105865 l    d  .stabstr	00000000 .stabstr
f0108000 l    d  .data	00000000 .data
f0112300 l    d  .bss	00000000 .bss
00000000 l    d  .comment	00000000 .comment
00000000 l    df *ABS*	00000000 obj/kern/entry.o
f010002f l       .text	00000000 relocated
f010003e l       .text	00000000 spin
00000000 l    df *ABS*	00000000 entrypgdir.c
00000000 l    df *ABS*	00000000 init.c
00000000 l    df *ABS*	00000000 console.c
f0100177 l     F .text	0000001f serial_proc_data
f0100196 l     F .text	00000043 cons_intr
f0112320 l     O .bss	00000208 cons
f01001d9 l     F .text	00000119 kbd_proc_data
f0112300 l     O .bss	00000004 shift.1407
f0101a60 l     O .rodata	00000100 shiftcode
f0101960 l     O .rodata	00000100 togglecode
f0101940 l     O .rodata	00000010 charcode
f01002f2 l     F .text	000001e9 cons_putc
f0112528 l     O .bss	00000002 crt_pos
f011252c l     O .bss	00000004 crt_buf
f0112530 l     O .bss	00000004 addr_6845
f0112534 l     O .bss	00000001 serial_exists
f0112200 l     O .data	00000100 normalmap
f0112100 l     O .data	00000100 shiftmap
f0112000 l     O .data	00000100 ctlmap
00000000 l    df *ABS*	00000000 monitor.c
f0101d44 l     O .rodata	00000018 commands
00000000 l    df *ABS*	00000000 printf.c
f01008bf l     F .text	00000013 putch
00000000 l    df *ABS*	00000000 kdebug.c
f010090c l     F .text	000000f6 stab_binsearch
00000000 l    df *ABS*	00000000 printfmt.c
f0100bd3 l     F .text	000000af printnum
f0100c82 l     F .text	0000001d sprintputch
f0101f68 l     O .rodata	0000001c error_string
00000000 l    df *ABS*	00000000 readline.c
f0112540 l     O .bss	00000400 buf
00000000 l    df *ABS*	00000000 string.c
f010000c g       .text	00000000 entry
f010129c g     F .text	00000020 strcpy
f01004f7 g     F .text	00000012 kbd_intr
f010076e g     F .text	0000000a mon_backtrace
f01000e6 g     F .text	00000057 _panic
f0100094 g     F .text	00000052 i386_init
f010142e g     F .text	00000068 memmove
f0101170 g     F .text	0000001a snprintf
f0100cbc g     F .text	00000466 vprintfmt
f0100509 g     F .text	0000004a cons_getc
f01008f8 g     F .text	00000014 cprintf
f0101496 g     F .text	00000013 memcpy
f010118a g     F .text	000000d9 readline
f0111000 g     O .data	00001000 entry_pgtable
f0100040 g     F .text	00000054 test_backtrace
f0101122 g     F .text	0000004e vsnprintf
f0112300 g       .bss	00000000 edata
f0100553 g     F .text	00000108 cons_init
f0105864 g       .stab	00000000 __STAB_END__
f0105865 g       .stabstr	00000000 __STABSTR_BEGIN__
f0101720 g     F .text	00000151 .hidden __umoddi3
f01004db g     F .text	0000001c serial_intr
f01015f0 g     F .text	00000122 .hidden __udivdi3
f010067c g     F .text	0000000a iscons
f0101505 g     F .text	000000de strtol
f010127b g     F .text	00000021 strnlen
f01012bc g     F .text	00000022 strcat
f0112944 g     O .bss	00000004 panicstr
f0112940 g       .bss	00000000 end
f010013d g     F .text	0000003a _warn
f01013c5 g     F .text	0000001c strfind
f0101871 g       .text	00000000 etext
0010000c g       .text	00000000 _start
f010130b g     F .text	0000003b strlcpy
f010136c g     F .text	00000038 strncmp
f01012de g     F .text	0000002d strncpy
f01014a9 g     F .text	00000039 memcmp
f010065b g     F .text	00000010 cputchar
f01013e1 g     F .text	0000004d memset
f010066b g     F .text	00000011 getchar
f0100c9f g     F .text	0000001d printfmt
f010711f g       .stabstr	00000000 __STABSTR_END__
f0101346 g     F .text	00000026 strcmp
f0100a02 g     F .text	000001d1 debuginfo_eip
f01008d2 g     F .text	00000026 vcprintf
f0110000 g       .data	00000000 bootstacktop
f0110000 g     O .data	00001000 entry_pgdir
f0108000 g       .data	00000000 bootstack
f0101f94 g       .stab	00000000 __STAB_BEGIN__
f0101263 g     F .text	00000018 strlen
f01013a4 g     F .text	00000021 strchr
f01006be g     F .text	000000b0 mon_kerninfo
f0100778 g     F .text	00000147 monitor
f01014e2 g     F .text	00000023 memfind
f0100686 g     F .text	00000038 mon_help
</code></pre></div></div>
<p>Program Header éƒ¨åˆ†, vdddr æŒ‡ virtual address, paddr æŒ‡ physical address, memsz/filesz æŒ‡ the size of the loaded area.</p>

<p><code class="language-plaintext highlighter-rouge">boot/main.c</code> ä¸­, æ¯ä¸€ä¸ªç¨‹åºå¤´çš„ <code class="language-plaintext highlighter-rouge">ph-&gt;p_pa</code> åŸŸéƒ½åŒ…å«äº†æ®µçš„ç›®æ ‡ç‰©ç†åœ°å€(the segmentâ€™s destination physical address).<br />
BIOS ä»å†…å­˜ 0x7c00 å¼€å§‹åŠ è½½å¼•å¯¼æ‰‡åŒº. äºæ˜¯å°±æœ‰äº† Exercise 5 çš„å†…å®¹.</p>

<p>ELF å¤´ä¸­è¿˜æœ‰ä¸€ä¸ªéå¸¸é‡è¦çš„åŸŸå« <code class="language-plaintext highlighter-rouge">e_entry</code>, è¿™ä¸ªæˆ‘ä»¬ä¹Ÿåœ¨ <code class="language-plaintext highlighter-rouge">bootmain()</code> é‡Œè§è¿‡. è¿™ä¸ªåŸŸæŒæœ‰è¿™ä¸ªç¨‹åºçš„å…¥å£é“¾æ¥åœ°å€(the link address of the entry point), ä¹Ÿå°±æ˜¯ç¨‹åº text æ®µçš„å†…å­˜åœ°å€.</p>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>$ objdump -f obj/kern/kernel

obj/kern/kernel:     file format elf32-i386
architecture: i386, flags 0x00000112:
EXEC_P, HAS_SYMS, D_PAGED
start address 0x0010000c
</code></pre></div></div>
<p>æ¥ç€æ˜¯å®Œæˆ Exercise 6 çš„å†…å®¹.</p>

<h2 id="part-3-the-kernel">Part 3: The Kernel</h2>
<h3 id="using-virtual-memory-to-work-around-position-dependence">Using virtual memory to work around position dependence</h3>
<p>åˆ©ç”¨è™šæ‹Ÿå†…å­˜è§£å†³ä½ç½®ä¾èµ–é—®é¢˜.<br />
æ“ä½œç³»ç»Ÿå†…æ ¸ä¸€èˆ¬ä¼šé“¾æ¥åˆ°é«˜ä½è™šæ‹Ÿå†…å­˜(è¿™ä¸ªå¯ä»¥åˆ° <code class="language-plaintext highlighter-rouge">kern/kernel.ld</code> ä¸­æŸ¥çœ‹), å¦‚ 0xf0100000, ç„¶åå°†æ›´ä½çš„å¤„ç†å™¨è™šæ‹Ÿåœ°å€ç•™ç»™ç”¨æˆ·ç¨‹åº.<br />
å¾ˆå¤šæœºå™¨æ²¡æœ‰é‚£ä¹ˆé«˜çš„åœ°å€, è¿™æ—¶å€™å°±ä¼šç”¨åˆ°å¤„ç†å™¨çš„å†…å­˜ç®¡ç†ç¡¬ä»¶å»æŠŠ 0xf0100000 æ˜ å°„åˆ° 0x00100000. è¿™æ · kernel å°±ä¼šè¢«åŠ è½½åˆ°ç‰©ç†åœ°å€ 1MB å¤„, æ­£å¥½åœ¨ BIOS ROM ä¸Šé¢.<br />
æ¥ç€, æˆ‘ä»¬å…ˆæ˜ å°„ 4MB çš„ç‰©ç†å†…å­˜, è§ Exercise 7. ä¸è¿‡è¿™é‡Œè¦æ³¨æ„, æ²¡æœ‰ 6.828 ä¸“ç”¨çš„ QEMU ä¼šæ— é™é‡å¯.</p>

<h3 id="formatted-printing-to-the-console">Formatted Printing to the Console</h3>
<p>ç»ˆç»ˆç»ˆäºåˆ°æˆ‘æœ€å–œæ¬¢çš„ C ä»£ç çš„éƒ¨åˆ†äº†!</p>
<blockquote>
  <p>Read through kern/printf.c, lib/printfmt.c, and kern/console.c, and make sure you understand their relationship. It will become clear in later labs why printfmt.c is located in the separate lib directory.</p>
</blockquote>

<p>è®©è¯» <code class="language-plaintext highlighter-rouge">kern/printf.c</code> å’Œ <code class="language-plaintext highlighter-rouge">lib/printfmt.c</code> è¿˜æœ‰ <code class="language-plaintext highlighter-rouge">kern/console.c</code> çš„ä»£ç , ç„¶åè®©ç†æ¸…å…³ç³».</p>

<p>kern/printf.c:</p>
<div class="language-c highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">// Simple implementation of cprintf console output for the kernel,</span>
<span class="c1">// based on printfmt() and the kernel console's cputchar().</span>

<span class="cp">#include &lt;inc/types.h&gt;
#include &lt;inc/stdio.h&gt;
#include &lt;inc/stdarg.h&gt;
</span>

<span class="k">static</span> <span class="kt">void</span>
<span class="nf">putch</span><span class="p">(</span><span class="kt">int</span> <span class="n">ch</span><span class="p">,</span> <span class="kt">int</span> <span class="o">*</span><span class="n">cnt</span><span class="p">)</span>
<span class="p">{</span>
	<span class="c1">// æ‰“å°ä¸€ä¸ªå­—ç¬¦</span>
	<span class="n">cputchar</span><span class="p">(</span><span class="n">ch</span><span class="p">);</span>
	<span class="c1">// çœ‹ä¸å¤ªæ‡‚è¿™é‡Œä¸ºä»€ä¹ˆè¦åŠ è§£å¼•ç”¨</span>
	<span class="o">*</span><span class="n">cnt</span><span class="o">++</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">int</span>
<span class="nf">vcprintf</span><span class="p">(</span><span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">fmt</span><span class="p">,</span> <span class="kt">va_list</span> <span class="n">ap</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">cnt</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="c1">// ä¼ å…¥ä¸Šé¢å®šä¹‰çš„æ‰“å°ä¸€ä¸ªå­—ç¬¦çš„å±€éƒ¨å‡½æ•°, ä¸€ä¸ªè®¡æ•°å™¨, ä¼ è¿›æ¥çš„æ ¼å¼åŒ–å­—ç¬¦ä¸²å’Œå¯å˜å‚æ•°åˆ—è¡¨.</span>
	<span class="n">vprintfmt</span><span class="p">((</span><span class="kt">void</span><span class="o">*</span><span class="p">)</span><span class="n">putch</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">cnt</span><span class="p">,</span> <span class="n">fmt</span><span class="p">,</span> <span class="n">ap</span><span class="p">);</span>
	<span class="c1">// è¿”å›è®¡æ•°å™¨, åˆæ­¥æ¨æ–­åº”è¯¥æ˜¯è·Ÿ C æ ‡å‡†åº“çš„ printf è¿”å›å€¼ç›¸åŒ.</span>
	<span class="k">return</span> <span class="n">cnt</span><span class="p">;</span>
<span class="p">}</span>

<span class="c1">// è¿™ä¸ªå‡½æ•°å°±æ˜¯åœ¨ vcprintf åŠ äº†ä¸€å±‚å¯å˜å‚æ•°åˆ—è¡¨æŒ‡é’ˆçš„å£³å­</span>
<span class="kt">int</span>
<span class="nf">cprintf</span><span class="p">(</span><span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">fmt</span><span class="p">,</span> <span class="p">...)</span>
<span class="p">{</span>
	<span class="c1">// å¯å˜å‚æ•°çš„ä½¿ç”¨æ–¹æ³•å‚è€ƒ C Primer Plus, å› ä¸ºéƒ½ä¼šäº†è¿™é‡Œå°±ä¸æäº†.</span>
	<span class="kt">va_list</span> <span class="n">ap</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">cnt</span><span class="p">;</span>

	<span class="n">va_start</span><span class="p">(</span><span class="n">ap</span><span class="p">,</span> <span class="n">fmt</span><span class="p">);</span>
	<span class="n">cnt</span> <span class="o">=</span> <span class="n">vcprintf</span><span class="p">(</span><span class="n">fmt</span><span class="p">,</span> <span class="n">ap</span><span class="p">);</span>
	<span class="n">va_end</span><span class="p">(</span><span class="n">ap</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">cnt</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></div></div>
<p>lib/printfmt.c:</p>
<div class="language-c highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">// Stripped-down primitive printf-style formatting routines,</span>
<span class="c1">// used in common by printf, sprintf, fprintf, etc.</span>
<span class="c1">// This code is also used by both the kernel and user programs.</span>

<span class="cp">#include &lt;inc/types.h&gt;
#include &lt;inc/stdio.h&gt;
#include &lt;inc/string.h&gt;
#include &lt;inc/stdarg.h&gt;
#include &lt;inc/error.h&gt;
</span>
<span class="cm">/*
 * Space or zero padding and a field width are supported for the numeric
 * formats only.
 *
 * The special format %e takes an integer error code
 * and prints a string describing the error.
 * The integer may be positive or negative,
 * so that -E_NO_MEM and E_NO_MEM are equivalent.
 */</span>

<span class="c1">// é”™è¯¯ä¿¡æ¯çš„å­—ç¬¦ä¸²å¸¸é‡. </span>
<span class="k">static</span> <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span> <span class="k">const</span> <span class="n">error_string</span><span class="p">[</span><span class="n">MAXERROR</span><span class="p">]</span> <span class="o">=</span>
<span class="p">{</span>
	<span class="p">[</span><span class="n">E_UNSPECIFIED</span><span class="p">]</span>	<span class="o">=</span> <span class="s">"unspecified error"</span><span class="p">,</span>
	<span class="p">[</span><span class="n">E_BAD_ENV</span><span class="p">]</span>	<span class="o">=</span> <span class="s">"bad environment"</span><span class="p">,</span>
	<span class="p">[</span><span class="n">E_INVAL</span><span class="p">]</span>	<span class="o">=</span> <span class="s">"invalid parameter"</span><span class="p">,</span>
	<span class="p">[</span><span class="n">E_NO_MEM</span><span class="p">]</span>	<span class="o">=</span> <span class="s">"out of memory"</span><span class="p">,</span>
	<span class="p">[</span><span class="n">E_NO_FREE_ENV</span><span class="p">]</span>	<span class="o">=</span> <span class="s">"out of environments"</span><span class="p">,</span>
	<span class="p">[</span><span class="n">E_FAULT</span><span class="p">]</span>	<span class="o">=</span> <span class="s">"segmentation fault"</span><span class="p">,</span>   <span class="c1">// å ªç§°å™©æ¢¦çš„ä¸œè¥¿?</span>
<span class="p">};</span>

<span class="cm">/*
 * Print a number (base &lt;= 16) in reverse order,
 * using specified putch function and associated pointer putdat.
 * ä¸€ä¸ªå±€éƒ¨å‡½æ•°.
 * é€†åºæ‰“å°ä¸€ä¸ªæ•°, è¦æ±‚è¿›åˆ¶å°äº 16.
 * ä½¿ç”¨ç‰¹åˆ¶çš„ putchar å‡½æ•°, å…³è”æŒ‡é’ˆ putdat. è¿™ä¿©ç­‰ä¸‹ä¼šåœ¨ vprintfmt å‡½æ•°é‡Œçœ‹åˆ°.
 * putch å‡½æ•°æŒ‡é’ˆè·Ÿ printf.c é‡Œçš„ putch å…¶å®åº”è¯¥æ˜¯ä¸€ä¸ªä¸œè¥¿. å¾…ä¼šå„¿å†è¯´å§.
 */</span>
<span class="k">static</span> <span class="kt">void</span>
<span class="nf">printnum</span><span class="p">(</span><span class="kt">void</span> <span class="p">(</span><span class="o">*</span><span class="n">putch</span><span class="p">)(</span><span class="kt">int</span><span class="p">,</span> <span class="kt">void</span><span class="o">*</span><span class="p">),</span> <span class="kt">void</span> <span class="o">*</span><span class="n">putdat</span><span class="p">,</span>
	 <span class="kt">unsigned</span> <span class="kt">long</span> <span class="kt">long</span> <span class="n">num</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="n">base</span><span class="p">,</span> <span class="kt">int</span> <span class="n">width</span><span class="p">,</span> <span class="kt">int</span> <span class="n">padc</span><span class="p">)</span>
<span class="p">{</span>
	<span class="c1">// first recursively print all preceding (more significant) digits</span>
	<span class="c1">// é€’å½’è¾“å‡º</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">num</span> <span class="o">&gt;=</span> <span class="n">base</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printnum</span><span class="p">(</span><span class="n">putch</span><span class="p">,</span> <span class="n">putdat</span><span class="p">,</span> <span class="n">num</span> <span class="o">/</span> <span class="n">base</span><span class="p">,</span> <span class="n">base</span><span class="p">,</span> <span class="n">width</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span> <span class="n">padc</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="c1">// print any needed pad characters before first digit</span>
		<span class="c1">// è¿™ä¸ªå°±æ˜¯æ‰“å°å›ºå®šå®½åº¦çš„æ•°å­—, padc æ˜¯å ä½ç¬¦</span>
		<span class="k">while</span> <span class="p">(</span><span class="o">--</span><span class="n">width</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span>
			<span class="n">putch</span><span class="p">(</span><span class="n">padc</span><span class="p">,</span> <span class="n">putdat</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="c1">// then print this (the least significant) digit</span>
	<span class="n">putch</span><span class="p">(</span><span class="s">"0123456789abcdef"</span><span class="p">[</span><span class="n">num</span> <span class="o">%</span> <span class="n">base</span><span class="p">],</span> <span class="n">putdat</span><span class="p">);</span>
<span class="p">}</span>
<span class="c1">// çœ‹å®Œäº†, ä¸€ä¸ªå­—, å¦™å•Š</span>

<span class="c1">// Get an unsigned int of various possible sizes from a varargs list,</span>
<span class="c1">// depending on the lflag parameter.</span>
<span class="k">static</span> <span class="kt">unsigned</span> <span class="kt">long</span> <span class="kt">long</span>
<span class="nf">getuint</span><span class="p">(</span><span class="kt">va_list</span> <span class="o">*</span><span class="n">ap</span><span class="p">,</span> <span class="kt">int</span> <span class="n">lflag</span><span class="p">)</span>
<span class="p">{</span>
	<span class="c1">// è¿™é‡Œçš„ lflag åº”è¯¥æ˜¯ %u å‰é¢çš„ l æ•°é‡å†³å®šçš„.</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">lflag</span> <span class="o">&gt;=</span> <span class="mi">2</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">va_arg</span><span class="p">(</span><span class="o">*</span><span class="n">ap</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">long</span> <span class="kt">long</span><span class="p">);</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">lflag</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">va_arg</span><span class="p">(</span><span class="o">*</span><span class="n">ap</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">long</span><span class="p">);</span>
	<span class="k">else</span>
		<span class="k">return</span> <span class="n">va_arg</span><span class="p">(</span><span class="o">*</span><span class="n">ap</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span><span class="p">);</span>
<span class="p">}</span>

<span class="c1">// Same as getuint but signed - can't use getuint</span>
<span class="c1">// because of sign extension</span>
<span class="k">static</span> <span class="kt">long</span> <span class="kt">long</span>
<span class="nf">getint</span><span class="p">(</span><span class="kt">va_list</span> <span class="o">*</span><span class="n">ap</span><span class="p">,</span> <span class="kt">int</span> <span class="n">lflag</span><span class="p">)</span>
<span class="p">{</span>
	<span class="c1">// è¿™é‡Œä¹Ÿä¸€æ ·, æ˜¯ç”± l çš„æ•°é‡å†³å®šçš„.</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">lflag</span> <span class="o">&gt;=</span> <span class="mi">2</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">va_arg</span><span class="p">(</span><span class="o">*</span><span class="n">ap</span><span class="p">,</span> <span class="kt">long</span> <span class="kt">long</span><span class="p">);</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">lflag</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">va_arg</span><span class="p">(</span><span class="o">*</span><span class="n">ap</span><span class="p">,</span> <span class="kt">long</span><span class="p">);</span>
	<span class="k">else</span>
		<span class="k">return</span> <span class="n">va_arg</span><span class="p">(</span><span class="o">*</span><span class="n">ap</span><span class="p">,</span> <span class="kt">int</span><span class="p">);</span>
<span class="p">}</span>


<span class="c1">// Main function to format and print a string.</span>
<span class="kt">void</span> <span class="nf">printfmt</span><span class="p">(</span><span class="kt">void</span> <span class="p">(</span><span class="o">*</span><span class="n">putch</span><span class="p">)(</span><span class="kt">int</span><span class="p">,</span> <span class="kt">void</span><span class="o">*</span><span class="p">),</span> <span class="kt">void</span> <span class="o">*</span><span class="n">putdat</span><span class="p">,</span> <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">fmt</span><span class="p">,</span> <span class="p">...);</span>

<span class="kt">void</span>
<span class="nf">vprintfmt</span><span class="p">(</span><span class="kt">void</span> <span class="p">(</span><span class="o">*</span><span class="n">putch</span><span class="p">)(</span><span class="kt">int</span><span class="p">,</span> <span class="kt">void</span><span class="o">*</span><span class="p">),</span> <span class="kt">void</span> <span class="o">*</span><span class="n">putdat</span><span class="p">,</span> <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">fmt</span><span class="p">,</span> <span class="kt">va_list</span> <span class="n">ap</span><span class="p">)</span>
<span class="p">{</span>
	<span class="c1">// ä¸€ä¸ªå¸¸é‡å¼•ç”¨</span>
	<span class="k">register</span> <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">p</span><span class="p">;</span>
	<span class="c1">// ch å°±æ˜¯ ch, åƒ fmt çš„å­—ç¬¦çš„</span>
	<span class="c1">// err æ˜¯ %e ç”¨åˆ°çš„ç¼–å·</span>
	<span class="k">register</span> <span class="kt">int</span> <span class="n">ch</span><span class="p">,</span> <span class="n">err</span><span class="p">;</span>
	<span class="c1">// æ— ç¬¦å· 64 ä½æ•´å‹</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="kt">long</span> <span class="n">num</span><span class="p">;</span>
	<span class="c1">// è¿›åˆ¶(åŸºæ•°), è¡¨ç¤º l å‰ç¼€æ•°é‡çš„è®¡æ•°å™¨, è¾“å‡ºå®½åº¦, ç²¾åº¦, %s ä¸­æœ‰ç”¨åˆ°çš„ altflag</span>
	<span class="kt">int</span> <span class="n">base</span><span class="p">,</span> <span class="n">lflag</span><span class="p">,</span> <span class="n">width</span><span class="p">,</span> <span class="n">precision</span><span class="p">,</span> <span class="n">altflag</span><span class="p">;</span>
	<span class="c1">// å®½åº¦ä¸å¤Ÿæ—¶çš„å ä½ç¬¦</span>
	<span class="kt">char</span> <span class="n">padc</span><span class="p">;</span>

	<span class="k">while</span> <span class="p">(</span><span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
		<span class="c1">// æ­»å¾ªç¯, ä½†æ˜¯é‡åˆ°'\0'ä¼š break çš„.</span>
		<span class="c1">// åƒ fmt çš„å­—ç¬¦. è½¬æ¢æˆæ— ç¬¦å·æ²¡æ‡‚ä»€ä¹ˆæ„æ€, å¯èƒ½æ˜¯æ‰©å……ASCII?</span>
		<span class="c1">// å¦‚æœæ²¡åƒåˆ° % (è½¬æ¢è¯´æ˜ç¬¦çš„æ ‡å¿—), å°±è¾“å‡ºè¿™ä¸ªå­—ç¬¦ç„¶åç»§ç»­åƒ.</span>
		<span class="k">while</span> <span class="p">((</span><span class="n">ch</span> <span class="o">=</span> <span class="o">*</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">char</span> <span class="o">*</span><span class="p">)</span> <span class="n">fmt</span><span class="o">++</span><span class="p">)</span> <span class="o">!=</span> <span class="sc">'%'</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">ch</span> <span class="o">==</span> <span class="sc">'\0'</span><span class="p">)</span>
				<span class="k">return</span><span class="p">;</span>
			<span class="n">putch</span><span class="p">(</span><span class="n">ch</span><span class="p">,</span> <span class="n">putdat</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="c1">// ä¸Šé¢åƒåˆ°äº† % ä¼šç»§ç»­ä¸‹é¢çš„</span>
		<span class="c1">// Process a %-escape sequence</span>
		<span class="c1">// é‡ç½®ä¸€äº›å¿…è¦çš„å˜é‡</span>
		<span class="n">padc</span> <span class="o">=</span> <span class="sc">' '</span><span class="p">;</span>
		<span class="n">width</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
		<span class="n">precision</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
		<span class="n">lflag</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">altflag</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="c1">// é‡æ¥ä¸€é switch, ç»™è½¬æ¢è¯´æ˜ç¬¦çš„ä¸€äº›ç±»å‹å‰ç¼€å‡†å¤‡çš„</span>
	<span class="nl">reswitch:</span>
		<span class="k">switch</span> <span class="p">(</span><span class="n">ch</span> <span class="o">=</span> <span class="o">*</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">char</span> <span class="o">*</span><span class="p">)</span> <span class="n">fmt</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>

		<span class="c1">// flag to pad on the right</span>
		<span class="k">case</span> <span class="sc">'-'</span><span class="p">:</span>
			<span class="n">padc</span> <span class="o">=</span> <span class="sc">'-'</span><span class="p">;</span>
			<span class="k">goto</span> <span class="n">reswitch</span><span class="p">;</span>

		<span class="c1">// flag to pad with 0's instead of spaces</span>
		<span class="k">case</span> <span class="sc">'0'</span><span class="p">:</span>
			<span class="n">padc</span> <span class="o">=</span> <span class="sc">'0'</span><span class="p">;</span>
			<span class="k">goto</span> <span class="n">reswitch</span><span class="p">;</span>

		<span class="c1">// width field</span>
		<span class="k">case</span> <span class="sc">'1'</span><span class="p">:</span>
		<span class="k">case</span> <span class="sc">'2'</span><span class="p">:</span>
		<span class="k">case</span> <span class="sc">'3'</span><span class="p">:</span>
		<span class="k">case</span> <span class="sc">'4'</span><span class="p">:</span>
		<span class="k">case</span> <span class="sc">'5'</span><span class="p">:</span>
		<span class="k">case</span> <span class="sc">'6'</span><span class="p">:</span>
		<span class="k">case</span> <span class="sc">'7'</span><span class="p">:</span>
		<span class="k">case</span> <span class="sc">'8'</span><span class="p">:</span>
		<span class="k">case</span> <span class="sc">'9'</span><span class="p">:</span>
			<span class="c1">// å¦‚æœè¯»å–åˆ°ä¸€ä¸ªæ•°å­—, å°±æŠŠå®ƒåé¢çš„æ•°å­—éƒ½è¯»äº†, å¹¶ä¸€å¹¶è½¬æˆåè¿›åˆ¶</span>
			<span class="k">for</span> <span class="p">(</span><span class="n">precision</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="p">;</span> <span class="o">++</span><span class="n">fmt</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">precision</span> <span class="o">=</span> <span class="n">precision</span> <span class="o">*</span> <span class="mi">10</span> <span class="o">+</span> <span class="n">ch</span> <span class="o">-</span> <span class="sc">'0'</span><span class="p">;</span>
				<span class="n">ch</span> <span class="o">=</span> <span class="o">*</span><span class="n">fmt</span><span class="p">;</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">ch</span> <span class="o">&lt;</span> <span class="sc">'0'</span> <span class="o">||</span> <span class="n">ch</span> <span class="o">&gt;</span> <span class="sc">'9'</span><span class="p">)</span>
					<span class="k">break</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="k">goto</span> <span class="n">process_precision</span><span class="p">;</span>

		<span class="k">case</span> <span class="sc">'*'</span><span class="p">:</span>
			<span class="c1">// è¿™æ˜¯ä»å¯å˜å‚æ•°åˆ—è¡¨ä¸­è·å–ç²¾åº¦çš„æ ‡å¿—</span>
			<span class="n">precision</span> <span class="o">=</span> <span class="n">va_arg</span><span class="p">(</span><span class="n">ap</span><span class="p">,</span> <span class="kt">int</span><span class="p">);</span>
			<span class="k">goto</span> <span class="n">process_precision</span><span class="p">;</span>

		<span class="k">case</span> <span class="sc">'.'</span><span class="p">:</span>
			<span class="c1">// å¦‚æœæ£€æµ‹åˆ° width è¿˜æ˜¯ -1, å°±æŠŠèµ‹å€¼æˆ 0, </span>
			<span class="c1">// è¿™æ ·å°±å¯ä»¥å’Œ process_precision é…åˆäº†.</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">width</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
				<span class="n">width</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="k">goto</span> <span class="n">reswitch</span><span class="p">;</span>

		<span class="k">case</span> <span class="sc">'#'</span><span class="p">:</span>
			<span class="n">altflag</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
			<span class="k">goto</span> <span class="n">reswitch</span><span class="p">;</span>

		<span class="c1">// åˆšæ‰æˆ‘è¿˜åœ¨æƒ³æ€ä¹ˆè§£å†³å°æ•°ç‚¹çš„é—®é¢˜, æ²¡æƒ³åˆ°è¿™é‡Œåšçš„è¿™ä¹ˆç²¾å¦™</span>
		<span class="c1">// æˆ‘ç”¨ goto å°±æ²¡æœ‰è¿™ä¸ªæ°´å¹³äº†</span>
		<span class="c1">// å¦‚æœæ£€æµ‹åˆ° width è¿˜æ²¡è¢«èµ‹å€¼, ä¹Ÿå°±æ˜¯è¿˜æ²¡è¯»åˆ°å°æ•°ç‚¹, </span>
		<span class="c1">// é‚£è¯»è¿›æ¥çš„é“å®šä¸æ˜¯ precision, å°±æŠŠ width å’Œ precision æ¢ä¸€ä¸‹</span>
		<span class="c1">// å¦™å•Š!</span>
		<span class="nl">process_precision:</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">width</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
				<span class="n">width</span> <span class="o">=</span> <span class="n">precision</span><span class="p">,</span> <span class="n">precision</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
			<span class="k">goto</span> <span class="n">reswitch</span><span class="p">;</span>

		<span class="c1">// long flag (doubled for long long)</span>
		<span class="c1">// å‰é¢è¯´äº†å¥½å‡ æ¬¡çš„ l å‰ç¼€</span>
		<span class="k">case</span> <span class="sc">'l'</span><span class="p">:</span>
			<span class="n">lflag</span><span class="o">++</span><span class="p">;</span>
			<span class="k">goto</span> <span class="n">reswitch</span><span class="p">;</span>

		<span class="c1">// character</span>
		<span class="c1">// è¾“å‡ºä¸€ä¸ªå­—ç¬¦å‹</span>
		<span class="k">case</span> <span class="sc">'c'</span><span class="p">:</span>
			<span class="n">putch</span><span class="p">(</span><span class="n">va_arg</span><span class="p">(</span><span class="n">ap</span><span class="p">,</span> <span class="kt">int</span><span class="p">),</span> <span class="n">putdat</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>

		<span class="c1">// error message</span>
		<span class="c1">// é”™è¯¯ä¿¡æ¯, æ ‡å‡†åº“çš„ printf æ˜¯ E å­—è®°æµ®ç‚¹è¾“å‡º</span>
		<span class="k">case</span> <span class="sc">'e'</span><span class="p">:</span>
			<span class="c1">// err æ˜¯ä¸ªæ•´æ•°</span>
			<span class="n">err</span> <span class="o">=</span> <span class="n">va_arg</span><span class="p">(</span><span class="n">ap</span><span class="p">,</span> <span class="kt">int</span><span class="p">);</span>
			<span class="c1">// å–ç»å¯¹å€¼</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">err</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
				<span class="n">err</span> <span class="o">=</span> <span class="o">-</span><span class="n">err</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">err</span> <span class="o">&gt;=</span> <span class="n">MAXERROR</span> <span class="o">||</span> <span class="p">(</span><span class="n">p</span> <span class="o">=</span> <span class="n">error_string</span><span class="p">[</span><span class="n">err</span><span class="p">])</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
				<span class="c1">// å¦‚æœå¯¹åº”ä¸ä¸Š error_string, é‚£å°±è¾“å‡ºä¸€ä¸ªç¼–å·</span>
				<span class="n">printfmt</span><span class="p">(</span><span class="n">putch</span><span class="p">,</span> <span class="n">putdat</span><span class="p">,</span> <span class="s">"error %d"</span><span class="p">,</span> <span class="n">err</span><span class="p">);</span>
			<span class="k">else</span>
				<span class="c1">// å¦‚æœå¯¹çš„ä¸Š, å°±è¾“å‡ºé”™è¯¯ä¿¡æ¯</span>
				<span class="n">printfmt</span><span class="p">(</span><span class="n">putch</span><span class="p">,</span> <span class="n">putdat</span><span class="p">,</span> <span class="s">"%s"</span><span class="p">,</span> <span class="n">p</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>

		<span class="c1">// string</span>
		<span class="c1">// å­—ç¬¦ä¸²è¾“å‡º</span>
		<span class="k">case</span> <span class="sc">'s'</span><span class="p">:</span>
			<span class="c1">// è¾“å‡º NULL</span>
			<span class="k">if</span> <span class="p">((</span><span class="n">p</span> <span class="o">=</span> <span class="n">va_arg</span><span class="p">(</span><span class="n">ap</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="p">))</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
				<span class="n">p</span> <span class="o">=</span> <span class="s">"(null)"</span><span class="p">;</span>
			<span class="c1">// å®½åº¦å¤§äº 0 ä¸”ä¸ºå³å¯¹é½</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">width</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span> <span class="n">padc</span> <span class="o">!=</span> <span class="sc">'-'</span><span class="p">)</span>
				<span class="c1">// è¿™é‡Œæ±‚ p çš„é•¿åº¦, æœ€å¤§å€¼é™åˆ¶åœ¨ precision</span>
				<span class="c1">// æ¯”è¾ƒç²¾å·§çš„ä»£ç .</span>
				<span class="k">for</span> <span class="p">(</span><span class="n">width</span> <span class="o">-=</span> <span class="n">strnlen</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">precision</span><span class="p">);</span> <span class="n">width</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">;</span> <span class="n">width</span><span class="o">--</span><span class="p">)</span>
					<span class="n">putch</span><span class="p">(</span><span class="n">padc</span><span class="p">,</span> <span class="n">putdat</span><span class="p">);</span>
			<span class="c1">// å¦‚æœåˆ°äº†å­—ç¬¦ä¸²å°¾, ä¸”(ç²¾åº¦æœªè®¾ç½®, æˆ–è€…è¾“å‡ºäº†ç²¾åº¦ä¸ªå­—ç¬¦äº†)å°± break.</span>
			<span class="k">for</span> <span class="p">(;</span> <span class="p">(</span><span class="n">ch</span> <span class="o">=</span> <span class="o">*</span><span class="n">p</span><span class="o">++</span><span class="p">)</span> <span class="o">!=</span> <span class="sc">'\0'</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">precision</span> <span class="o">&lt;</span> <span class="mi">0</span> <span class="o">||</span> <span class="o">--</span><span class="n">precision</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">);</span> <span class="n">width</span><span class="o">--</span><span class="p">)</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">altflag</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">ch</span> <span class="o">&lt;</span> <span class="sc">' '</span> <span class="o">||</span> <span class="n">ch</span> <span class="o">&gt;</span> <span class="sc">'~'</span><span class="p">))</span>
					<span class="n">putch</span><span class="p">(</span><span class="sc">'?'</span><span class="p">,</span> <span class="n">putdat</span><span class="p">);</span>
				<span class="k">else</span>
					<span class="n">putch</span><span class="p">(</span><span class="n">ch</span><span class="p">,</span> <span class="n">putdat</span><span class="p">);</span>
				<span class="c1">// ä¸Šé¢å®šä¹‰çš„ altflag è¢«è®¾ç½®ä¸ºäº† 0, æ‰€ä»¥è¿™é‡Œçš„åˆ†æ”¯æ˜¯åºŸçš„, </span>
				<span class="c1">// æ§åˆ¶å­—ç¬¦, æ‰©å±•ASCIIç…§å¸¸è¾“å‡º</span>
			<span class="c1">// å¦‚æœæ˜¯å·¦å¯¹é½è¿™é‡Œçš„ width å°±è¿˜åœ¨, è¾“å‡ºå¯¹åº”æ•°é‡çš„ç©ºæ ¼.</span>
			<span class="k">for</span> <span class="p">(;</span> <span class="n">width</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">;</span> <span class="n">width</span><span class="o">--</span><span class="p">)</span>
				<span class="n">putch</span><span class="p">(</span><span class="sc">' '</span><span class="p">,</span> <span class="n">putdat</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>

		<span class="c1">// (signed) decimal</span>
		<span class="c1">// è¾“å‡ºæœ‰ç¬¦å·åè¿›åˆ¶æ•´å‹</span>
		<span class="k">case</span> <span class="sc">'d'</span><span class="p">:</span>
			<span class="n">num</span> <span class="o">=</span> <span class="n">getint</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ap</span><span class="p">,</span> <span class="n">lflag</span><span class="p">);</span>
			<span class="c1">// æ³¨æ„ä»»æ„æ•´å‹éƒ½ä½œä¸º 64 ä½æ•´æ•°å¤„ç†, è¿™é‡Œåº”è¯¥æ˜¯ä¸ºäº†é˜²æ­¢è¡¥ç å¼•èµ·çš„ä¸€äº›é—®é¢˜.</span>
			<span class="k">if</span> <span class="p">((</span><span class="kt">long</span> <span class="kt">long</span><span class="p">)</span> <span class="n">num</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">putch</span><span class="p">(</span><span class="sc">'-'</span><span class="p">,</span> <span class="n">putdat</span><span class="p">);</span>
				<span class="n">num</span> <span class="o">=</span> <span class="o">-</span><span class="p">(</span><span class="kt">long</span> <span class="kt">long</span><span class="p">)</span> <span class="n">num</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="n">base</span> <span class="o">=</span> <span class="mi">10</span><span class="p">;</span>
			<span class="k">goto</span> <span class="n">number</span><span class="p">;</span>

		<span class="c1">// unsigned decimal</span>
		<span class="c1">// è¾“å‡ºæ— ç¬¦å·åè¿›åˆ¶æ•´å‹</span>
		<span class="k">case</span> <span class="sc">'u'</span><span class="p">:</span>
			<span class="n">num</span> <span class="o">=</span> <span class="n">getuint</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ap</span><span class="p">,</span> <span class="n">lflag</span><span class="p">);</span>
			<span class="n">base</span> <span class="o">=</span> <span class="mi">10</span><span class="p">;</span>
			<span class="k">goto</span> <span class="n">number</span><span class="p">;</span>

		<span class="c1">// (unsigned) octal</span>
		<span class="c1">// è¾“å‡ºæ— ç¬¦å·å…«è¿›åˆ¶æ•´å‹</span>
		<span class="k">case</span> <span class="sc">'o'</span><span class="p">:</span>
			<span class="c1">// Replace this with your code.</span>
			<span class="c1">// è¿™æ®µä»£ç åœ¨ Exercise 8 ä¸­æ”¹äº†</span>
			<span class="n">putch</span><span class="p">(</span><span class="sc">'X'</span><span class="p">,</span> <span class="n">putdat</span><span class="p">);</span>
			<span class="n">putch</span><span class="p">(</span><span class="sc">'X'</span><span class="p">,</span> <span class="n">putdat</span><span class="p">);</span>
			<span class="n">putch</span><span class="p">(</span><span class="sc">'X'</span><span class="p">,</span> <span class="n">putdat</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>

		<span class="c1">// pointer</span>
		<span class="c1">// ä»¥åå…­è¿›åˆ¶æ ‡è®°å¼€å¤´ä»¥åå…­è¿›åˆ¶è¾“å‡ºæŒ‡é’ˆ</span>
		<span class="k">case</span> <span class="sc">'p'</span><span class="p">:</span>
			<span class="n">putch</span><span class="p">(</span><span class="sc">'0'</span><span class="p">,</span> <span class="n">putdat</span><span class="p">);</span>
			<span class="n">putch</span><span class="p">(</span><span class="sc">'x'</span><span class="p">,</span> <span class="n">putdat</span><span class="p">);</span>
			<span class="n">num</span> <span class="o">=</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="kt">long</span><span class="p">)</span>
				<span class="p">(</span><span class="kt">uintptr_t</span><span class="p">)</span> <span class="n">va_arg</span><span class="p">(</span><span class="n">ap</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="p">);</span>
			<span class="n">base</span> <span class="o">=</span> <span class="mi">16</span><span class="p">;</span>
			<span class="k">goto</span> <span class="n">number</span><span class="p">;</span>

		<span class="c1">// (unsigned) hexadecimal</span>
		<span class="c1">// åå…­è¿›åˆ¶è¾“å‡º</span>
		<span class="k">case</span> <span class="sc">'x'</span><span class="p">:</span>
			<span class="n">num</span> <span class="o">=</span> <span class="n">getuint</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ap</span><span class="p">,</span> <span class="n">lflag</span><span class="p">);</span>
			<span class="n">base</span> <span class="o">=</span> <span class="mi">16</span><span class="p">;</span>
		<span class="c1">// æ‰€æœ‰æ•´æ•°çš„é€šç”¨è¾“å‡ºéƒ¨åˆ†</span>
		<span class="nl">number:</span>
			<span class="n">printnum</span><span class="p">(</span><span class="n">putch</span><span class="p">,</span> <span class="n">putdat</span><span class="p">,</span> <span class="n">num</span><span class="p">,</span> <span class="n">base</span><span class="p">,</span> <span class="n">width</span><span class="p">,</span> <span class="n">padc</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>

		<span class="c1">// escaped '%' character</span>
		<span class="c1">// æ‰“å°ä¸€ä¸ª %</span>
		<span class="k">case</span> <span class="sc">'%'</span><span class="p">:</span>
			<span class="n">putch</span><span class="p">(</span><span class="n">ch</span><span class="p">,</span> <span class="n">putdat</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>

		<span class="c1">// unrecognized escape sequence - just print it literally</span>
		<span class="nl">default:</span>
			<span class="c1">// å¦‚æœ % åé¢çäº†ä¸œè¥¿, å°±è¾“å‡ºä¸€ä¸ª % ç„¶åæŠŠ % åé¢å¤šä½™çš„ä¸œè¥¿åå‡ºæ¥.</span>
			<span class="n">putch</span><span class="p">(</span><span class="sc">'%'</span><span class="p">,</span> <span class="n">putdat</span><span class="p">);</span>
			<span class="c1">// åå­—ç¬¦</span>
			<span class="k">for</span> <span class="p">(</span><span class="n">fmt</span><span class="o">--</span><span class="p">;</span> <span class="n">fmt</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">!=</span> <span class="sc">'%'</span><span class="p">;</span> <span class="n">fmt</span><span class="o">--</span><span class="p">)</span>
				<span class="cm">/* do nothing */</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="c1">// ç»™ vprintfmt åŠ ä¸€ä¸ªå£³å­.</span>
<span class="kt">void</span>
<span class="nf">printfmt</span><span class="p">(</span><span class="kt">void</span> <span class="p">(</span><span class="o">*</span><span class="n">putch</span><span class="p">)(</span><span class="kt">int</span><span class="p">,</span> <span class="kt">void</span><span class="o">*</span><span class="p">),</span> <span class="kt">void</span> <span class="o">*</span><span class="n">putdat</span><span class="p">,</span> <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">fmt</span><span class="p">,</span> <span class="p">...)</span>
<span class="p">{</span>
	<span class="kt">va_list</span> <span class="n">ap</span><span class="p">;</span>

	<span class="n">va_start</span><span class="p">(</span><span class="n">ap</span><span class="p">,</span> <span class="n">fmt</span><span class="p">);</span>
	<span class="n">vprintfmt</span><span class="p">(</span><span class="n">putch</span><span class="p">,</span> <span class="n">putdat</span><span class="p">,</span> <span class="n">fmt</span><span class="p">,</span> <span class="n">ap</span><span class="p">);</span>
	<span class="n">va_end</span><span class="p">(</span><span class="n">ap</span><span class="p">);</span>
<span class="p">}</span>

<span class="c1">// å­—ç¬¦ä¸²æ‰“å°çš„ buffer ç»“æ„ä½“</span>
<span class="k">struct</span> <span class="n">sprintbuf</span> <span class="p">{</span>
	<span class="kt">char</span> <span class="o">*</span><span class="n">buf</span><span class="p">;</span>       <span class="c1">// buffer é¦–éƒ¨</span>
	<span class="kt">char</span> <span class="o">*</span><span class="n">ebuf</span><span class="p">;</span>      <span class="c1">// buffer å°¾éƒ¨('\0', ä¸æ˜¯'\0'çš„ä¸‹ä¸€ä½)</span>
	<span class="kt">int</span> <span class="n">cnt</span><span class="p">;</span>         <span class="c1">// æ‰“å°è¿‡çš„å­—ç¬¦çš„è®¡æ•°å™¨</span>
<span class="p">};</span>

<span class="c1">// </span>
<span class="k">static</span> <span class="kt">void</span>
<span class="nf">sprintputch</span><span class="p">(</span><span class="kt">int</span> <span class="n">ch</span><span class="p">,</span> <span class="k">struct</span> <span class="n">sprintbuf</span> <span class="o">*</span><span class="n">b</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">b</span><span class="o">-&gt;</span><span class="n">cnt</span><span class="o">++</span><span class="p">;</span>                 <span class="c1">// è®¡æ•°å™¨å¢</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">b</span><span class="o">-&gt;</span><span class="n">buf</span> <span class="o">&lt;</span> <span class="n">b</span><span class="o">-&gt;</span><span class="n">ebuf</span><span class="p">)</span>     <span class="c1">// å¦‚æœæ²¡åˆ°å°¾éƒ¨</span>
		<span class="o">*</span><span class="n">b</span><span class="o">-&gt;</span><span class="n">buf</span><span class="o">++</span> <span class="o">=</span> <span class="n">ch</span><span class="p">;</span>       <span class="c1">// æŠŠä¸€ä¸ªå­—ç¬¦æ”¾åˆ° buf é‡Œé¢</span>
<span class="p">}</span>

<span class="c1">// å®‰å…¨ç‰ˆæœ¬çš„ vsprintf, æœ‰ä¸ª n åšä¿æŠ¤.</span>
<span class="kt">int</span>
<span class="nf">vsnprintf</span><span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="n">buf</span><span class="p">,</span> <span class="kt">int</span> <span class="n">n</span><span class="p">,</span> <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">fmt</span><span class="p">,</span> <span class="kt">va_list</span> <span class="n">ap</span><span class="p">)</span>
<span class="p">{</span>
	<span class="c1">// æ³¨æ„è¿™é‡Œ buf+n ä¹‹åå‡ä¸€äº†, æ‰€ä»¥åº”è¯¥æ˜¯è®¤ä¸º n ä¼ è¿›æ¥çš„ç±»ä¼¼ strlen(n)+1,</span>
	<span class="c1">// è¿™æ ·ä¸ä¼šåŒ…æ‹¬ç»“å°¾çš„'\0'</span>
	<span class="k">struct</span> <span class="n">sprintbuf</span> <span class="n">b</span> <span class="o">=</span> <span class="p">{</span><span class="n">buf</span><span class="p">,</span> <span class="n">buf</span><span class="o">+</span><span class="n">n</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">};</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">buf</span> <span class="o">==</span> <span class="nb">NULL</span> <span class="o">||</span> <span class="n">n</span> <span class="o">&lt;</span> <span class="mi">1</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">E_INVAL</span><span class="p">;</span>

	<span class="c1">// è°ƒç”¨å›åˆ°äº†å›åˆ°äº† vprintfmt å¤´ä¸Š</span>
	<span class="c1">// print the string to the buffer</span>
	<span class="n">vprintfmt</span><span class="p">((</span><span class="kt">void</span><span class="o">*</span><span class="p">)</span><span class="n">sprintputch</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">b</span><span class="p">,</span> <span class="n">fmt</span><span class="p">,</span> <span class="n">ap</span><span class="p">);</span>

	<span class="c1">// null terminate the buffer</span>
	<span class="c1">// ç„¶åå®ƒä¼šåœ¨å°¾éƒ¨å¡«ä¸Šä¸€ä¸ª'\0'</span>
	<span class="c1">// æ‰€ä»¥ç°åœ¨å¤§è‡´æ˜ç™½äº†, å‰é¢çš„é‚£ä¸ªå‡ä¸€åº”è¯¥æ˜¯ç»™ sizeof å­—ç¬¦æ•°ç»„å‡†å¤‡çš„</span>
	<span class="o">*</span><span class="n">b</span><span class="p">.</span><span class="n">buf</span> <span class="o">=</span> <span class="sc">'\0'</span><span class="p">;</span>

	<span class="k">return</span> <span class="n">b</span><span class="p">.</span><span class="n">cnt</span><span class="p">;</span>
<span class="p">}</span>


<span class="c1">// ç»™ vsnprintf åŠ ä¸€å±‚å£³å­</span>
<span class="kt">int</span>
<span class="nf">snprintf</span><span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="n">buf</span><span class="p">,</span> <span class="kt">int</span> <span class="n">n</span><span class="p">,</span> <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">fmt</span><span class="p">,</span> <span class="p">...)</span>
<span class="p">{</span>
	<span class="kt">va_list</span> <span class="n">ap</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">rc</span><span class="p">;</span>

	<span class="n">va_start</span><span class="p">(</span><span class="n">ap</span><span class="p">,</span> <span class="n">fmt</span><span class="p">);</span>
	<span class="n">rc</span> <span class="o">=</span> <span class="n">vsnprintf</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="n">n</span><span class="p">,</span> <span class="n">fmt</span><span class="p">,</span> <span class="n">ap</span><span class="p">);</span>
	<span class="n">va_end</span><span class="p">(</span><span class="n">ap</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">rc</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></div></div>
<p>kern/consoles.c, çœ‹ä¸æ‡‚, ä¸æƒ³çœ‹, æš‚æ—¶ä¸å¤„ç†.</p>
<div class="language-c highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="cm">/* See COPYRIGHT for copyright information. */</span>

<span class="cp">#include &lt;inc/x86.h&gt;
#include &lt;inc/memlayout.h&gt;
#include &lt;inc/kbdreg.h&gt;
#include &lt;inc/string.h&gt;
#include &lt;inc/assert.h&gt;
</span>
<span class="cp">#include &lt;kern/console.h&gt;
</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">cons_intr</span><span class="p">(</span><span class="kt">int</span> <span class="p">(</span><span class="o">*</span><span class="n">proc</span><span class="p">)(</span><span class="kt">void</span><span class="p">));</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">cons_putc</span><span class="p">(</span><span class="kt">int</span> <span class="n">c</span><span class="p">);</span>

<span class="c1">// Stupid I/O delay routine necessitated by historical PC design flaws</span>
<span class="k">static</span> <span class="kt">void</span>
<span class="nf">delay</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">inb</span><span class="p">(</span><span class="mh">0x84</span><span class="p">);</span>
	<span class="n">inb</span><span class="p">(</span><span class="mh">0x84</span><span class="p">);</span>
	<span class="n">inb</span><span class="p">(</span><span class="mh">0x84</span><span class="p">);</span>
	<span class="n">inb</span><span class="p">(</span><span class="mh">0x84</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/***** Serial I/O code *****/</span>

<span class="cp">#define COM1		0x3F8
</span>
<span class="cp">#define COM_RX		0	// In:	Receive buffer (DLAB=0)
#define COM_TX		0	// Out: Transmit buffer (DLAB=0)
#define COM_DLL		0	// Out: Divisor Latch Low (DLAB=1)
#define COM_DLM		1	// Out: Divisor Latch High (DLAB=1)
#define COM_IER		1	// Out: Interrupt Enable Register
#define   COM_IER_RDI	0x01	//   Enable receiver data interrupt
#define COM_IIR		2	// In:	Interrupt ID Register
#define COM_FCR		2	// Out: FIFO Control Register
#define COM_LCR		3	// Out: Line Control Register
#define	  COM_LCR_DLAB	0x80	//   Divisor latch access bit
#define	  COM_LCR_WLEN8	0x03	//   Wordlength: 8 bits
#define COM_MCR		4	// Out: Modem Control Register
#define	  COM_MCR_RTS	0x02	// RTS complement
#define	  COM_MCR_DTR	0x01	// DTR complement
#define	  COM_MCR_OUT2	0x08	// Out2 complement
#define COM_LSR		5	// In:	Line Status Register
#define   COM_LSR_DATA	0x01	//   Data available
#define   COM_LSR_TXRDY	0x20	//   Transmit buffer avail
#define   COM_LSR_TSRE	0x40	//   Transmitter off
</span>
<span class="k">static</span> <span class="n">bool</span> <span class="n">serial_exists</span><span class="p">;</span>

<span class="k">static</span> <span class="kt">int</span>
<span class="nf">serial_proc_data</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">inb</span><span class="p">(</span><span class="n">COM1</span><span class="o">+</span><span class="n">COM_LSR</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">COM_LSR_DATA</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
	<span class="k">return</span> <span class="n">inb</span><span class="p">(</span><span class="n">COM1</span><span class="o">+</span><span class="n">COM_RX</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">void</span>
<span class="nf">serial_intr</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">serial_exists</span><span class="p">)</span>
		<span class="n">cons_intr</span><span class="p">(</span><span class="n">serial_proc_data</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span>
<span class="nf">serial_putc</span><span class="p">(</span><span class="kt">int</span> <span class="n">c</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	     <span class="o">!</span><span class="p">(</span><span class="n">inb</span><span class="p">(</span><span class="n">COM1</span> <span class="o">+</span> <span class="n">COM_LSR</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">COM_LSR_TXRDY</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">12800</span><span class="p">;</span>
	     <span class="n">i</span><span class="o">++</span><span class="p">)</span>
		<span class="n">delay</span><span class="p">();</span>

	<span class="n">outb</span><span class="p">(</span><span class="n">COM1</span> <span class="o">+</span> <span class="n">COM_TX</span><span class="p">,</span> <span class="n">c</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span>
<span class="nf">serial_init</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="c1">// Turn off the FIFO</span>
	<span class="n">outb</span><span class="p">(</span><span class="n">COM1</span><span class="o">+</span><span class="n">COM_FCR</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>

	<span class="c1">// Set speed; requires DLAB latch</span>
	<span class="n">outb</span><span class="p">(</span><span class="n">COM1</span><span class="o">+</span><span class="n">COM_LCR</span><span class="p">,</span> <span class="n">COM_LCR_DLAB</span><span class="p">);</span>
	<span class="n">outb</span><span class="p">(</span><span class="n">COM1</span><span class="o">+</span><span class="n">COM_DLL</span><span class="p">,</span> <span class="p">(</span><span class="kt">uint8_t</span><span class="p">)</span> <span class="p">(</span><span class="mi">115200</span> <span class="o">/</span> <span class="mi">9600</span><span class="p">));</span>
	<span class="n">outb</span><span class="p">(</span><span class="n">COM1</span><span class="o">+</span><span class="n">COM_DLM</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>

	<span class="c1">// 8 data bits, 1 stop bit, parity off; turn off DLAB latch</span>
	<span class="n">outb</span><span class="p">(</span><span class="n">COM1</span><span class="o">+</span><span class="n">COM_LCR</span><span class="p">,</span> <span class="n">COM_LCR_WLEN8</span> <span class="o">&amp;</span> <span class="o">~</span><span class="n">COM_LCR_DLAB</span><span class="p">);</span>

	<span class="c1">// No modem controls</span>
	<span class="n">outb</span><span class="p">(</span><span class="n">COM1</span><span class="o">+</span><span class="n">COM_MCR</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="c1">// Enable rcv interrupts</span>
	<span class="n">outb</span><span class="p">(</span><span class="n">COM1</span><span class="o">+</span><span class="n">COM_IER</span><span class="p">,</span> <span class="n">COM_IER_RDI</span><span class="p">);</span>

	<span class="c1">// Clear any preexisting overrun indications and interrupts</span>
	<span class="c1">// Serial port doesn't exist if COM_LSR returns 0xFF</span>
	<span class="n">serial_exists</span> <span class="o">=</span> <span class="p">(</span><span class="n">inb</span><span class="p">(</span><span class="n">COM1</span><span class="o">+</span><span class="n">COM_LSR</span><span class="p">)</span> <span class="o">!=</span> <span class="mh">0xFF</span><span class="p">);</span>
	<span class="p">(</span><span class="kt">void</span><span class="p">)</span> <span class="n">inb</span><span class="p">(</span><span class="n">COM1</span><span class="o">+</span><span class="n">COM_IIR</span><span class="p">);</span>
	<span class="p">(</span><span class="kt">void</span><span class="p">)</span> <span class="n">inb</span><span class="p">(</span><span class="n">COM1</span><span class="o">+</span><span class="n">COM_RX</span><span class="p">);</span>

<span class="p">}</span>



<span class="cm">/***** Parallel port output code *****/</span>
<span class="c1">// For information on PC parallel port programming, see the class References</span>
<span class="c1">// page.</span>

<span class="k">static</span> <span class="kt">void</span>
<span class="nf">lpt_putc</span><span class="p">(</span><span class="kt">int</span> <span class="n">c</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="o">!</span><span class="p">(</span><span class="n">inb</span><span class="p">(</span><span class="mh">0x378</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0x80</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">12800</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
		<span class="n">delay</span><span class="p">();</span>
	<span class="n">outb</span><span class="p">(</span><span class="mh">0x378</span><span class="o">+</span><span class="mi">0</span><span class="p">,</span> <span class="n">c</span><span class="p">);</span>
	<span class="n">outb</span><span class="p">(</span><span class="mh">0x378</span><span class="o">+</span><span class="mi">2</span><span class="p">,</span> <span class="mh">0x08</span><span class="o">|</span><span class="mh">0x04</span><span class="o">|</span><span class="mh">0x01</span><span class="p">);</span>
	<span class="n">outb</span><span class="p">(</span><span class="mh">0x378</span><span class="o">+</span><span class="mi">2</span><span class="p">,</span> <span class="mh">0x08</span><span class="p">);</span>
<span class="p">}</span>




<span class="cm">/***** Text-mode CGA/VGA display output *****/</span>

<span class="k">static</span> <span class="kt">unsigned</span> <span class="n">addr_6845</span><span class="p">;</span>
<span class="k">static</span> <span class="kt">uint16_t</span> <span class="o">*</span><span class="n">crt_buf</span><span class="p">;</span>
<span class="k">static</span> <span class="kt">uint16_t</span> <span class="n">crt_pos</span><span class="p">;</span>

<span class="k">static</span> <span class="kt">void</span>
<span class="nf">cga_init</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">volatile</span> <span class="kt">uint16_t</span> <span class="o">*</span><span class="n">cp</span><span class="p">;</span>
	<span class="kt">uint16_t</span> <span class="n">was</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="n">pos</span><span class="p">;</span>

	<span class="n">cp</span> <span class="o">=</span> <span class="p">(</span><span class="kt">uint16_t</span><span class="o">*</span><span class="p">)</span> <span class="p">(</span><span class="n">KERNBASE</span> <span class="o">+</span> <span class="n">CGA_BUF</span><span class="p">);</span>
	<span class="n">was</span> <span class="o">=</span> <span class="o">*</span><span class="n">cp</span><span class="p">;</span>
	<span class="o">*</span><span class="n">cp</span> <span class="o">=</span> <span class="p">(</span><span class="kt">uint16_t</span><span class="p">)</span> <span class="mh">0xA55A</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">*</span><span class="n">cp</span> <span class="o">!=</span> <span class="mh">0xA55A</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">cp</span> <span class="o">=</span> <span class="p">(</span><span class="kt">uint16_t</span><span class="o">*</span><span class="p">)</span> <span class="p">(</span><span class="n">KERNBASE</span> <span class="o">+</span> <span class="n">MONO_BUF</span><span class="p">);</span>
		<span class="n">addr_6845</span> <span class="o">=</span> <span class="n">MONO_BASE</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="o">*</span><span class="n">cp</span> <span class="o">=</span> <span class="n">was</span><span class="p">;</span>
		<span class="n">addr_6845</span> <span class="o">=</span> <span class="n">CGA_BASE</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* Extract cursor location */</span>
	<span class="n">outb</span><span class="p">(</span><span class="n">addr_6845</span><span class="p">,</span> <span class="mi">14</span><span class="p">);</span>
	<span class="n">pos</span> <span class="o">=</span> <span class="n">inb</span><span class="p">(</span><span class="n">addr_6845</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span><span class="p">;</span>
	<span class="n">outb</span><span class="p">(</span><span class="n">addr_6845</span><span class="p">,</span> <span class="mi">15</span><span class="p">);</span>
	<span class="n">pos</span> <span class="o">|=</span> <span class="n">inb</span><span class="p">(</span><span class="n">addr_6845</span> <span class="o">+</span> <span class="mi">1</span><span class="p">);</span>

	<span class="n">crt_buf</span> <span class="o">=</span> <span class="p">(</span><span class="kt">uint16_t</span><span class="o">*</span><span class="p">)</span> <span class="n">cp</span><span class="p">;</span>
	<span class="n">crt_pos</span> <span class="o">=</span> <span class="n">pos</span><span class="p">;</span>
<span class="p">}</span>



<span class="k">static</span> <span class="kt">void</span>
<span class="nf">cga_putc</span><span class="p">(</span><span class="kt">int</span> <span class="n">c</span><span class="p">)</span>
<span class="p">{</span>
	<span class="c1">// if no attribute given, then use black on white</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">c</span> <span class="o">&amp;</span> <span class="o">~</span><span class="mh">0xFF</span><span class="p">))</span>
		<span class="n">c</span> <span class="o">|=</span> <span class="mh">0x0700</span><span class="p">;</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">c</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="sc">'\b'</span><span class="p">:</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">crt_pos</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">crt_pos</span><span class="o">--</span><span class="p">;</span>
			<span class="n">crt_buf</span><span class="p">[</span><span class="n">crt_pos</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">c</span> <span class="o">&amp;</span> <span class="o">~</span><span class="mh">0xff</span><span class="p">)</span> <span class="o">|</span> <span class="sc">' '</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="sc">'\n'</span><span class="p">:</span>
		<span class="n">crt_pos</span> <span class="o">+=</span> <span class="n">CRT_COLS</span><span class="p">;</span>
		<span class="cm">/* fallthru */</span>
	<span class="k">case</span> <span class="sc">'\r'</span><span class="p">:</span>
		<span class="n">crt_pos</span> <span class="o">-=</span> <span class="p">(</span><span class="n">crt_pos</span> <span class="o">%</span> <span class="n">CRT_COLS</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="sc">'\t'</span><span class="p">:</span>
		<span class="n">cons_putc</span><span class="p">(</span><span class="sc">' '</span><span class="p">);</span>
		<span class="n">cons_putc</span><span class="p">(</span><span class="sc">' '</span><span class="p">);</span>
		<span class="n">cons_putc</span><span class="p">(</span><span class="sc">' '</span><span class="p">);</span>
		<span class="n">cons_putc</span><span class="p">(</span><span class="sc">' '</span><span class="p">);</span>
		<span class="n">cons_putc</span><span class="p">(</span><span class="sc">' '</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="n">crt_buf</span><span class="p">[</span><span class="n">crt_pos</span><span class="o">++</span><span class="p">]</span> <span class="o">=</span> <span class="n">c</span><span class="p">;</span>		<span class="cm">/* write the character */</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="c1">// What is the purpose of this?</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">crt_pos</span> <span class="o">&gt;=</span> <span class="n">CRT_SIZE</span><span class="p">)</span> <span class="p">{</span>
		<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

		<span class="n">memmove</span><span class="p">(</span><span class="n">crt_buf</span><span class="p">,</span> <span class="n">crt_buf</span> <span class="o">+</span> <span class="n">CRT_COLS</span><span class="p">,</span> <span class="p">(</span><span class="n">CRT_SIZE</span> <span class="o">-</span> <span class="n">CRT_COLS</span><span class="p">)</span> <span class="o">*</span> <span class="k">sizeof</span><span class="p">(</span><span class="kt">uint16_t</span><span class="p">));</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="n">CRT_SIZE</span> <span class="o">-</span> <span class="n">CRT_COLS</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">CRT_SIZE</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
			<span class="n">crt_buf</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0x0700</span> <span class="o">|</span> <span class="sc">' '</span><span class="p">;</span>
		<span class="n">crt_pos</span> <span class="o">-=</span> <span class="n">CRT_COLS</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* move that little blinky thing */</span>
	<span class="n">outb</span><span class="p">(</span><span class="n">addr_6845</span><span class="p">,</span> <span class="mi">14</span><span class="p">);</span>
	<span class="n">outb</span><span class="p">(</span><span class="n">addr_6845</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="n">crt_pos</span> <span class="o">&gt;&gt;</span> <span class="mi">8</span><span class="p">);</span>
	<span class="n">outb</span><span class="p">(</span><span class="n">addr_6845</span><span class="p">,</span> <span class="mi">15</span><span class="p">);</span>
	<span class="n">outb</span><span class="p">(</span><span class="n">addr_6845</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="n">crt_pos</span><span class="p">);</span>
<span class="p">}</span>


<span class="cm">/***** Keyboard input code *****/</span>

<span class="cp">#define NO		0
</span>
<span class="cp">#define SHIFT		(1&lt;&lt;0)
#define CTL		(1&lt;&lt;1)
#define ALT		(1&lt;&lt;2)
</span>
<span class="cp">#define CAPSLOCK	(1&lt;&lt;3)
#define NUMLOCK		(1&lt;&lt;4)
#define SCROLLLOCK	(1&lt;&lt;5)
</span>
<span class="cp">#define E0ESC		(1&lt;&lt;6)
</span>
<span class="k">static</span> <span class="kt">uint8_t</span> <span class="n">shiftcode</span><span class="p">[</span><span class="mi">256</span><span class="p">]</span> <span class="o">=</span>
<span class="p">{</span>
	<span class="p">[</span><span class="mh">0x1D</span><span class="p">]</span> <span class="o">=</span> <span class="n">CTL</span><span class="p">,</span>
	<span class="p">[</span><span class="mh">0x2A</span><span class="p">]</span> <span class="o">=</span> <span class="n">SHIFT</span><span class="p">,</span>
	<span class="p">[</span><span class="mh">0x36</span><span class="p">]</span> <span class="o">=</span> <span class="n">SHIFT</span><span class="p">,</span>
	<span class="p">[</span><span class="mh">0x38</span><span class="p">]</span> <span class="o">=</span> <span class="n">ALT</span><span class="p">,</span>
	<span class="p">[</span><span class="mh">0x9D</span><span class="p">]</span> <span class="o">=</span> <span class="n">CTL</span><span class="p">,</span>
	<span class="p">[</span><span class="mh">0xB8</span><span class="p">]</span> <span class="o">=</span> <span class="n">ALT</span>
<span class="p">};</span>

<span class="k">static</span> <span class="kt">uint8_t</span> <span class="n">togglecode</span><span class="p">[</span><span class="mi">256</span><span class="p">]</span> <span class="o">=</span>
<span class="p">{</span>
	<span class="p">[</span><span class="mh">0x3A</span><span class="p">]</span> <span class="o">=</span> <span class="n">CAPSLOCK</span><span class="p">,</span>
	<span class="p">[</span><span class="mh">0x45</span><span class="p">]</span> <span class="o">=</span> <span class="n">NUMLOCK</span><span class="p">,</span>
	<span class="p">[</span><span class="mh">0x46</span><span class="p">]</span> <span class="o">=</span> <span class="n">SCROLLLOCK</span>
<span class="p">};</span>

<span class="k">static</span> <span class="kt">uint8_t</span> <span class="n">normalmap</span><span class="p">[</span><span class="mi">256</span><span class="p">]</span> <span class="o">=</span>
<span class="p">{</span>
	<span class="n">NO</span><span class="p">,</span>   <span class="mh">0x1B</span><span class="p">,</span> <span class="sc">'1'</span><span class="p">,</span>  <span class="sc">'2'</span><span class="p">,</span>  <span class="sc">'3'</span><span class="p">,</span>  <span class="sc">'4'</span><span class="p">,</span>  <span class="sc">'5'</span><span class="p">,</span>  <span class="sc">'6'</span><span class="p">,</span>	<span class="c1">// 0x00</span>
	<span class="sc">'7'</span><span class="p">,</span>  <span class="sc">'8'</span><span class="p">,</span>  <span class="sc">'9'</span><span class="p">,</span>  <span class="sc">'0'</span><span class="p">,</span>  <span class="sc">'-'</span><span class="p">,</span>  <span class="sc">'='</span><span class="p">,</span>  <span class="sc">'\b'</span><span class="p">,</span> <span class="sc">'\t'</span><span class="p">,</span>
	<span class="sc">'q'</span><span class="p">,</span>  <span class="sc">'w'</span><span class="p">,</span>  <span class="sc">'e'</span><span class="p">,</span>  <span class="sc">'r'</span><span class="p">,</span>  <span class="sc">'t'</span><span class="p">,</span>  <span class="sc">'y'</span><span class="p">,</span>  <span class="sc">'u'</span><span class="p">,</span>  <span class="sc">'i'</span><span class="p">,</span>	<span class="c1">// 0x10</span>
	<span class="sc">'o'</span><span class="p">,</span>  <span class="sc">'p'</span><span class="p">,</span>  <span class="sc">'['</span><span class="p">,</span>  <span class="sc">']'</span><span class="p">,</span>  <span class="sc">'\n'</span><span class="p">,</span> <span class="n">NO</span><span class="p">,</span>   <span class="sc">'a'</span><span class="p">,</span>  <span class="sc">'s'</span><span class="p">,</span>
	<span class="sc">'d'</span><span class="p">,</span>  <span class="sc">'f'</span><span class="p">,</span>  <span class="sc">'g'</span><span class="p">,</span>  <span class="sc">'h'</span><span class="p">,</span>  <span class="sc">'j'</span><span class="p">,</span>  <span class="sc">'k'</span><span class="p">,</span>  <span class="sc">'l'</span><span class="p">,</span>  <span class="sc">';'</span><span class="p">,</span>	<span class="c1">// 0x20</span>
	<span class="sc">'\''</span><span class="p">,</span> <span class="sc">'`'</span><span class="p">,</span>  <span class="n">NO</span><span class="p">,</span>   <span class="sc">'\\'</span><span class="p">,</span> <span class="sc">'z'</span><span class="p">,</span>  <span class="sc">'x'</span><span class="p">,</span>  <span class="sc">'c'</span><span class="p">,</span>  <span class="sc">'v'</span><span class="p">,</span>
	<span class="sc">'b'</span><span class="p">,</span>  <span class="sc">'n'</span><span class="p">,</span>  <span class="sc">'m'</span><span class="p">,</span>  <span class="sc">','</span><span class="p">,</span>  <span class="sc">'.'</span><span class="p">,</span>  <span class="sc">'/'</span><span class="p">,</span>  <span class="n">NO</span><span class="p">,</span>   <span class="sc">'*'</span><span class="p">,</span>	<span class="c1">// 0x30</span>
	<span class="n">NO</span><span class="p">,</span>   <span class="sc">' '</span><span class="p">,</span>  <span class="n">NO</span><span class="p">,</span>   <span class="n">NO</span><span class="p">,</span>   <span class="n">NO</span><span class="p">,</span>   <span class="n">NO</span><span class="p">,</span>   <span class="n">NO</span><span class="p">,</span>   <span class="n">NO</span><span class="p">,</span>
	<span class="n">NO</span><span class="p">,</span>   <span class="n">NO</span><span class="p">,</span>   <span class="n">NO</span><span class="p">,</span>   <span class="n">NO</span><span class="p">,</span>   <span class="n">NO</span><span class="p">,</span>   <span class="n">NO</span><span class="p">,</span>   <span class="n">NO</span><span class="p">,</span>   <span class="sc">'7'</span><span class="p">,</span>	<span class="c1">// 0x40</span>
	<span class="sc">'8'</span><span class="p">,</span>  <span class="sc">'9'</span><span class="p">,</span>  <span class="sc">'-'</span><span class="p">,</span>  <span class="sc">'4'</span><span class="p">,</span>  <span class="sc">'5'</span><span class="p">,</span>  <span class="sc">'6'</span><span class="p">,</span>  <span class="sc">'+'</span><span class="p">,</span>  <span class="sc">'1'</span><span class="p">,</span>
	<span class="sc">'2'</span><span class="p">,</span>  <span class="sc">'3'</span><span class="p">,</span>  <span class="sc">'0'</span><span class="p">,</span>  <span class="sc">'.'</span><span class="p">,</span>  <span class="n">NO</span><span class="p">,</span>   <span class="n">NO</span><span class="p">,</span>   <span class="n">NO</span><span class="p">,</span>   <span class="n">NO</span><span class="p">,</span>	<span class="c1">// 0x50</span>
	<span class="p">[</span><span class="mh">0xC7</span><span class="p">]</span> <span class="o">=</span> <span class="n">KEY_HOME</span><span class="p">,</span>	      <span class="p">[</span><span class="mh">0x9C</span><span class="p">]</span> <span class="o">=</span> <span class="sc">'\n'</span> <span class="cm">/*KP_Enter*/</span><span class="p">,</span>
	<span class="p">[</span><span class="mh">0xB5</span><span class="p">]</span> <span class="o">=</span> <span class="sc">'/'</span> <span class="cm">/*KP_Div*/</span><span class="p">,</span>      <span class="p">[</span><span class="mh">0xC8</span><span class="p">]</span> <span class="o">=</span> <span class="n">KEY_UP</span><span class="p">,</span>
	<span class="p">[</span><span class="mh">0xC9</span><span class="p">]</span> <span class="o">=</span> <span class="n">KEY_PGUP</span><span class="p">,</span>	      <span class="p">[</span><span class="mh">0xCB</span><span class="p">]</span> <span class="o">=</span> <span class="n">KEY_LF</span><span class="p">,</span>
	<span class="p">[</span><span class="mh">0xCD</span><span class="p">]</span> <span class="o">=</span> <span class="n">KEY_RT</span><span class="p">,</span>	      <span class="p">[</span><span class="mh">0xCF</span><span class="p">]</span> <span class="o">=</span> <span class="n">KEY_END</span><span class="p">,</span>
	<span class="p">[</span><span class="mh">0xD0</span><span class="p">]</span> <span class="o">=</span> <span class="n">KEY_DN</span><span class="p">,</span>	      <span class="p">[</span><span class="mh">0xD1</span><span class="p">]</span> <span class="o">=</span> <span class="n">KEY_PGDN</span><span class="p">,</span>
	<span class="p">[</span><span class="mh">0xD2</span><span class="p">]</span> <span class="o">=</span> <span class="n">KEY_INS</span><span class="p">,</span>	      <span class="p">[</span><span class="mh">0xD3</span><span class="p">]</span> <span class="o">=</span> <span class="n">KEY_DEL</span>
<span class="p">};</span>

<span class="k">static</span> <span class="kt">uint8_t</span> <span class="n">shiftmap</span><span class="p">[</span><span class="mi">256</span><span class="p">]</span> <span class="o">=</span>
<span class="p">{</span>
	<span class="n">NO</span><span class="p">,</span>   <span class="mo">033</span><span class="p">,</span>  <span class="sc">'!'</span><span class="p">,</span>  <span class="sc">'@'</span><span class="p">,</span>  <span class="sc">'#'</span><span class="p">,</span>  <span class="sc">'$'</span><span class="p">,</span>  <span class="sc">'%'</span><span class="p">,</span>  <span class="sc">'^'</span><span class="p">,</span>	<span class="c1">// 0x00</span>
	<span class="sc">'&amp;'</span><span class="p">,</span>  <span class="sc">'*'</span><span class="p">,</span>  <span class="sc">'('</span><span class="p">,</span>  <span class="sc">')'</span><span class="p">,</span>  <span class="sc">'_'</span><span class="p">,</span>  <span class="sc">'+'</span><span class="p">,</span>  <span class="sc">'\b'</span><span class="p">,</span> <span class="sc">'\t'</span><span class="p">,</span>
	<span class="sc">'Q'</span><span class="p">,</span>  <span class="sc">'W'</span><span class="p">,</span>  <span class="sc">'E'</span><span class="p">,</span>  <span class="sc">'R'</span><span class="p">,</span>  <span class="sc">'T'</span><span class="p">,</span>  <span class="sc">'Y'</span><span class="p">,</span>  <span class="sc">'U'</span><span class="p">,</span>  <span class="sc">'I'</span><span class="p">,</span>	<span class="c1">// 0x10</span>
	<span class="sc">'O'</span><span class="p">,</span>  <span class="sc">'P'</span><span class="p">,</span>  <span class="sc">'{'</span><span class="p">,</span>  <span class="sc">'}'</span><span class="p">,</span>  <span class="sc">'\n'</span><span class="p">,</span> <span class="n">NO</span><span class="p">,</span>   <span class="sc">'A'</span><span class="p">,</span>  <span class="sc">'S'</span><span class="p">,</span>
	<span class="sc">'D'</span><span class="p">,</span>  <span class="sc">'F'</span><span class="p">,</span>  <span class="sc">'G'</span><span class="p">,</span>  <span class="sc">'H'</span><span class="p">,</span>  <span class="sc">'J'</span><span class="p">,</span>  <span class="sc">'K'</span><span class="p">,</span>  <span class="sc">'L'</span><span class="p">,</span>  <span class="sc">':'</span><span class="p">,</span>	<span class="c1">// 0x20</span>
	<span class="sc">'"'</span><span class="p">,</span>  <span class="sc">'~'</span><span class="p">,</span>  <span class="n">NO</span><span class="p">,</span>   <span class="sc">'|'</span><span class="p">,</span>  <span class="sc">'Z'</span><span class="p">,</span>  <span class="sc">'X'</span><span class="p">,</span>  <span class="sc">'C'</span><span class="p">,</span>  <span class="sc">'V'</span><span class="p">,</span>
	<span class="sc">'B'</span><span class="p">,</span>  <span class="sc">'N'</span><span class="p">,</span>  <span class="sc">'M'</span><span class="p">,</span>  <span class="sc">'&lt;'</span><span class="p">,</span>  <span class="sc">'&gt;'</span><span class="p">,</span>  <span class="sc">'?'</span><span class="p">,</span>  <span class="n">NO</span><span class="p">,</span>   <span class="sc">'*'</span><span class="p">,</span>	<span class="c1">// 0x30</span>
	<span class="n">NO</span><span class="p">,</span>   <span class="sc">' '</span><span class="p">,</span>  <span class="n">NO</span><span class="p">,</span>   <span class="n">NO</span><span class="p">,</span>   <span class="n">NO</span><span class="p">,</span>   <span class="n">NO</span><span class="p">,</span>   <span class="n">NO</span><span class="p">,</span>   <span class="n">NO</span><span class="p">,</span>
	<span class="n">NO</span><span class="p">,</span>   <span class="n">NO</span><span class="p">,</span>   <span class="n">NO</span><span class="p">,</span>   <span class="n">NO</span><span class="p">,</span>   <span class="n">NO</span><span class="p">,</span>   <span class="n">NO</span><span class="p">,</span>   <span class="n">NO</span><span class="p">,</span>   <span class="sc">'7'</span><span class="p">,</span>	<span class="c1">// 0x40</span>
	<span class="sc">'8'</span><span class="p">,</span>  <span class="sc">'9'</span><span class="p">,</span>  <span class="sc">'-'</span><span class="p">,</span>  <span class="sc">'4'</span><span class="p">,</span>  <span class="sc">'5'</span><span class="p">,</span>  <span class="sc">'6'</span><span class="p">,</span>  <span class="sc">'+'</span><span class="p">,</span>  <span class="sc">'1'</span><span class="p">,</span>
	<span class="sc">'2'</span><span class="p">,</span>  <span class="sc">'3'</span><span class="p">,</span>  <span class="sc">'0'</span><span class="p">,</span>  <span class="sc">'.'</span><span class="p">,</span>  <span class="n">NO</span><span class="p">,</span>   <span class="n">NO</span><span class="p">,</span>   <span class="n">NO</span><span class="p">,</span>   <span class="n">NO</span><span class="p">,</span>	<span class="c1">// 0x50</span>
	<span class="p">[</span><span class="mh">0xC7</span><span class="p">]</span> <span class="o">=</span> <span class="n">KEY_HOME</span><span class="p">,</span>	      <span class="p">[</span><span class="mh">0x9C</span><span class="p">]</span> <span class="o">=</span> <span class="sc">'\n'</span> <span class="cm">/*KP_Enter*/</span><span class="p">,</span>
	<span class="p">[</span><span class="mh">0xB5</span><span class="p">]</span> <span class="o">=</span> <span class="sc">'/'</span> <span class="cm">/*KP_Div*/</span><span class="p">,</span>      <span class="p">[</span><span class="mh">0xC8</span><span class="p">]</span> <span class="o">=</span> <span class="n">KEY_UP</span><span class="p">,</span>
	<span class="p">[</span><span class="mh">0xC9</span><span class="p">]</span> <span class="o">=</span> <span class="n">KEY_PGUP</span><span class="p">,</span>	      <span class="p">[</span><span class="mh">0xCB</span><span class="p">]</span> <span class="o">=</span> <span class="n">KEY_LF</span><span class="p">,</span>
	<span class="p">[</span><span class="mh">0xCD</span><span class="p">]</span> <span class="o">=</span> <span class="n">KEY_RT</span><span class="p">,</span>	      <span class="p">[</span><span class="mh">0xCF</span><span class="p">]</span> <span class="o">=</span> <span class="n">KEY_END</span><span class="p">,</span>
	<span class="p">[</span><span class="mh">0xD0</span><span class="p">]</span> <span class="o">=</span> <span class="n">KEY_DN</span><span class="p">,</span>	      <span class="p">[</span><span class="mh">0xD1</span><span class="p">]</span> <span class="o">=</span> <span class="n">KEY_PGDN</span><span class="p">,</span>
	<span class="p">[</span><span class="mh">0xD2</span><span class="p">]</span> <span class="o">=</span> <span class="n">KEY_INS</span><span class="p">,</span>	      <span class="p">[</span><span class="mh">0xD3</span><span class="p">]</span> <span class="o">=</span> <span class="n">KEY_DEL</span>
<span class="p">};</span>

<span class="cp">#define C(x) (x - '@')
</span>
<span class="k">static</span> <span class="kt">uint8_t</span> <span class="n">ctlmap</span><span class="p">[</span><span class="mi">256</span><span class="p">]</span> <span class="o">=</span>
<span class="p">{</span>
	<span class="n">NO</span><span class="p">,</span>      <span class="n">NO</span><span class="p">,</span>      <span class="n">NO</span><span class="p">,</span>      <span class="n">NO</span><span class="p">,</span>      <span class="n">NO</span><span class="p">,</span>      <span class="n">NO</span><span class="p">,</span>      <span class="n">NO</span><span class="p">,</span>      <span class="n">NO</span><span class="p">,</span>
	<span class="n">NO</span><span class="p">,</span>      <span class="n">NO</span><span class="p">,</span>      <span class="n">NO</span><span class="p">,</span>      <span class="n">NO</span><span class="p">,</span>      <span class="n">NO</span><span class="p">,</span>      <span class="n">NO</span><span class="p">,</span>      <span class="n">NO</span><span class="p">,</span>      <span class="n">NO</span><span class="p">,</span>
	<span class="n">C</span><span class="p">(</span><span class="sc">'Q'</span><span class="p">),</span>  <span class="n">C</span><span class="p">(</span><span class="sc">'W'</span><span class="p">),</span>  <span class="n">C</span><span class="p">(</span><span class="sc">'E'</span><span class="p">),</span>  <span class="n">C</span><span class="p">(</span><span class="sc">'R'</span><span class="p">),</span>  <span class="n">C</span><span class="p">(</span><span class="sc">'T'</span><span class="p">),</span>  <span class="n">C</span><span class="p">(</span><span class="sc">'Y'</span><span class="p">),</span>  <span class="n">C</span><span class="p">(</span><span class="sc">'U'</span><span class="p">),</span>  <span class="n">C</span><span class="p">(</span><span class="sc">'I'</span><span class="p">),</span>
	<span class="n">C</span><span class="p">(</span><span class="sc">'O'</span><span class="p">),</span>  <span class="n">C</span><span class="p">(</span><span class="sc">'P'</span><span class="p">),</span>  <span class="n">NO</span><span class="p">,</span>      <span class="n">NO</span><span class="p">,</span>      <span class="sc">'\r'</span><span class="p">,</span>    <span class="n">NO</span><span class="p">,</span>      <span class="n">C</span><span class="p">(</span><span class="sc">'A'</span><span class="p">),</span>  <span class="n">C</span><span class="p">(</span><span class="sc">'S'</span><span class="p">),</span>
	<span class="n">C</span><span class="p">(</span><span class="sc">'D'</span><span class="p">),</span>  <span class="n">C</span><span class="p">(</span><span class="sc">'F'</span><span class="p">),</span>  <span class="n">C</span><span class="p">(</span><span class="sc">'G'</span><span class="p">),</span>  <span class="n">C</span><span class="p">(</span><span class="sc">'H'</span><span class="p">),</span>  <span class="n">C</span><span class="p">(</span><span class="sc">'J'</span><span class="p">),</span>  <span class="n">C</span><span class="p">(</span><span class="sc">'K'</span><span class="p">),</span>  <span class="n">C</span><span class="p">(</span><span class="sc">'L'</span><span class="p">),</span>  <span class="n">NO</span><span class="p">,</span>
	<span class="n">NO</span><span class="p">,</span>      <span class="n">NO</span><span class="p">,</span>      <span class="n">NO</span><span class="p">,</span>      <span class="n">C</span><span class="p">(</span><span class="sc">'\\'</span><span class="p">),</span> <span class="n">C</span><span class="p">(</span><span class="sc">'Z'</span><span class="p">),</span>  <span class="n">C</span><span class="p">(</span><span class="sc">'X'</span><span class="p">),</span>  <span class="n">C</span><span class="p">(</span><span class="sc">'C'</span><span class="p">),</span>  <span class="n">C</span><span class="p">(</span><span class="sc">'V'</span><span class="p">),</span>
	<span class="n">C</span><span class="p">(</span><span class="sc">'B'</span><span class="p">),</span>  <span class="n">C</span><span class="p">(</span><span class="sc">'N'</span><span class="p">),</span>  <span class="n">C</span><span class="p">(</span><span class="sc">'M'</span><span class="p">),</span>  <span class="n">NO</span><span class="p">,</span>      <span class="n">NO</span><span class="p">,</span>      <span class="n">C</span><span class="p">(</span><span class="sc">'/'</span><span class="p">),</span>  <span class="n">NO</span><span class="p">,</span>      <span class="n">NO</span><span class="p">,</span>
	<span class="p">[</span><span class="mh">0x97</span><span class="p">]</span> <span class="o">=</span> <span class="n">KEY_HOME</span><span class="p">,</span>
	<span class="p">[</span><span class="mh">0xB5</span><span class="p">]</span> <span class="o">=</span> <span class="n">C</span><span class="p">(</span><span class="sc">'/'</span><span class="p">),</span>		<span class="p">[</span><span class="mh">0xC8</span><span class="p">]</span> <span class="o">=</span> <span class="n">KEY_UP</span><span class="p">,</span>
	<span class="p">[</span><span class="mh">0xC9</span><span class="p">]</span> <span class="o">=</span> <span class="n">KEY_PGUP</span><span class="p">,</span>		<span class="p">[</span><span class="mh">0xCB</span><span class="p">]</span> <span class="o">=</span> <span class="n">KEY_LF</span><span class="p">,</span>
	<span class="p">[</span><span class="mh">0xCD</span><span class="p">]</span> <span class="o">=</span> <span class="n">KEY_RT</span><span class="p">,</span>		<span class="p">[</span><span class="mh">0xCF</span><span class="p">]</span> <span class="o">=</span> <span class="n">KEY_END</span><span class="p">,</span>
	<span class="p">[</span><span class="mh">0xD0</span><span class="p">]</span> <span class="o">=</span> <span class="n">KEY_DN</span><span class="p">,</span>		<span class="p">[</span><span class="mh">0xD1</span><span class="p">]</span> <span class="o">=</span> <span class="n">KEY_PGDN</span><span class="p">,</span>
	<span class="p">[</span><span class="mh">0xD2</span><span class="p">]</span> <span class="o">=</span> <span class="n">KEY_INS</span><span class="p">,</span>		<span class="p">[</span><span class="mh">0xD3</span><span class="p">]</span> <span class="o">=</span> <span class="n">KEY_DEL</span>
<span class="p">};</span>

<span class="k">static</span> <span class="kt">uint8_t</span> <span class="o">*</span><span class="n">charcode</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="n">normalmap</span><span class="p">,</span>
	<span class="n">shiftmap</span><span class="p">,</span>
	<span class="n">ctlmap</span><span class="p">,</span>
	<span class="n">ctlmap</span>
<span class="p">};</span>

<span class="cm">/*
 * Get data from the keyboard.  If we finish a character, return it.  Else 0.
 * Return -1 if no data.
 */</span>
<span class="k">static</span> <span class="kt">int</span>
<span class="nf">kbd_proc_data</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">c</span><span class="p">;</span>
	<span class="kt">uint8_t</span> <span class="n">stat</span><span class="p">,</span> <span class="n">data</span><span class="p">;</span>
	<span class="k">static</span> <span class="kt">uint32_t</span> <span class="n">shift</span><span class="p">;</span>

	<span class="n">stat</span> <span class="o">=</span> <span class="n">inb</span><span class="p">(</span><span class="n">KBSTATP</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">stat</span> <span class="o">&amp;</span> <span class="n">KBS_DIB</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
	<span class="c1">// Ignore data from mouse.</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">stat</span> <span class="o">&amp;</span> <span class="n">KBS_TERR</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>

	<span class="n">data</span> <span class="o">=</span> <span class="n">inb</span><span class="p">(</span><span class="n">KBDATAP</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">data</span> <span class="o">==</span> <span class="mh">0xE0</span><span class="p">)</span> <span class="p">{</span>
		<span class="c1">// E0 escape character</span>
		<span class="n">shift</span> <span class="o">|=</span> <span class="n">E0ESC</span><span class="p">;</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">data</span> <span class="o">&amp;</span> <span class="mh">0x80</span><span class="p">)</span> <span class="p">{</span>
		<span class="c1">// Key released</span>
		<span class="n">data</span> <span class="o">=</span> <span class="p">(</span><span class="n">shift</span> <span class="o">&amp;</span> <span class="n">E0ESC</span> <span class="o">?</span> <span class="n">data</span> <span class="o">:</span> <span class="n">data</span> <span class="o">&amp;</span> <span class="mh">0x7F</span><span class="p">);</span>
		<span class="n">shift</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="p">(</span><span class="n">shiftcode</span><span class="p">[</span><span class="n">data</span><span class="p">]</span> <span class="o">|</span> <span class="n">E0ESC</span><span class="p">);</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">shift</span> <span class="o">&amp;</span> <span class="n">E0ESC</span><span class="p">)</span> <span class="p">{</span>
		<span class="c1">// Last character was an E0 escape; or with 0x80</span>
		<span class="n">data</span> <span class="o">|=</span> <span class="mh">0x80</span><span class="p">;</span>
		<span class="n">shift</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">E0ESC</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">shift</span> <span class="o">|=</span> <span class="n">shiftcode</span><span class="p">[</span><span class="n">data</span><span class="p">];</span>
	<span class="n">shift</span> <span class="o">^=</span> <span class="n">togglecode</span><span class="p">[</span><span class="n">data</span><span class="p">];</span>

	<span class="n">c</span> <span class="o">=</span> <span class="n">charcode</span><span class="p">[</span><span class="n">shift</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">CTL</span> <span class="o">|</span> <span class="n">SHIFT</span><span class="p">)][</span><span class="n">data</span><span class="p">];</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">shift</span> <span class="o">&amp;</span> <span class="n">CAPSLOCK</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="sc">'a'</span> <span class="o">&lt;=</span> <span class="n">c</span> <span class="o">&amp;&amp;</span> <span class="n">c</span> <span class="o">&lt;=</span> <span class="sc">'z'</span><span class="p">)</span>
			<span class="n">c</span> <span class="o">+=</span> <span class="sc">'A'</span> <span class="o">-</span> <span class="sc">'a'</span><span class="p">;</span>
		<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="sc">'A'</span> <span class="o">&lt;=</span> <span class="n">c</span> <span class="o">&amp;&amp;</span> <span class="n">c</span> <span class="o">&lt;=</span> <span class="sc">'Z'</span><span class="p">)</span>
			<span class="n">c</span> <span class="o">+=</span> <span class="sc">'a'</span> <span class="o">-</span> <span class="sc">'A'</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="c1">// Process special keys</span>
	<span class="c1">// Ctrl-Alt-Del: reboot</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="o">~</span><span class="n">shift</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">CTL</span> <span class="o">|</span> <span class="n">ALT</span><span class="p">))</span> <span class="o">&amp;&amp;</span> <span class="n">c</span> <span class="o">==</span> <span class="n">KEY_DEL</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">cprintf</span><span class="p">(</span><span class="s">"Rebooting!</span><span class="se">\n</span><span class="s">"</span><span class="p">);</span>
		<span class="n">outb</span><span class="p">(</span><span class="mh">0x92</span><span class="p">,</span> <span class="mh">0x3</span><span class="p">);</span> <span class="c1">// courtesy of Chris Frost</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">c</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">void</span>
<span class="nf">kbd_intr</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">cons_intr</span><span class="p">(</span><span class="n">kbd_proc_data</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span>
<span class="nf">kbd_init</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
<span class="p">}</span>



<span class="cm">/***** General device-independent console code *****/</span>
<span class="c1">// Here we manage the console input buffer,</span>
<span class="c1">// where we stash characters received from the keyboard or serial port</span>
<span class="c1">// whenever the corresponding interrupt occurs.</span>

<span class="cp">#define CONSBUFSIZE 512
</span>
<span class="k">static</span> <span class="k">struct</span> <span class="p">{</span>
	<span class="kt">uint8_t</span> <span class="n">buf</span><span class="p">[</span><span class="n">CONSBUFSIZE</span><span class="p">];</span>
	<span class="kt">uint32_t</span> <span class="n">rpos</span><span class="p">;</span>
	<span class="kt">uint32_t</span> <span class="n">wpos</span><span class="p">;</span>
<span class="p">}</span> <span class="n">cons</span><span class="p">;</span>

<span class="c1">// called by device interrupt routines to feed input characters</span>
<span class="c1">// into the circular console input buffer.</span>
<span class="k">static</span> <span class="kt">void</span>
<span class="nf">cons_intr</span><span class="p">(</span><span class="kt">int</span> <span class="p">(</span><span class="o">*</span><span class="n">proc</span><span class="p">)(</span><span class="kt">void</span><span class="p">))</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">c</span><span class="p">;</span>

	<span class="k">while</span> <span class="p">((</span><span class="n">c</span> <span class="o">=</span> <span class="p">(</span><span class="o">*</span><span class="n">proc</span><span class="p">)())</span> <span class="o">!=</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">c</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">continue</span><span class="p">;</span>
		<span class="n">cons</span><span class="p">.</span><span class="n">buf</span><span class="p">[</span><span class="n">cons</span><span class="p">.</span><span class="n">wpos</span><span class="o">++</span><span class="p">]</span> <span class="o">=</span> <span class="n">c</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">cons</span><span class="p">.</span><span class="n">wpos</span> <span class="o">==</span> <span class="n">CONSBUFSIZE</span><span class="p">)</span>
			<span class="n">cons</span><span class="p">.</span><span class="n">wpos</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="c1">// return the next input character from the console, or 0 if none waiting</span>
<span class="kt">int</span>
<span class="nf">cons_getc</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">c</span><span class="p">;</span>

	<span class="c1">// poll for any pending input characters,</span>
	<span class="c1">// so that this function works even when interrupts are disabled</span>
	<span class="c1">// (e.g., when called from the kernel monitor).</span>
	<span class="n">serial_intr</span><span class="p">();</span>
	<span class="n">kbd_intr</span><span class="p">();</span>

	<span class="c1">// grab the next character from the input buffer.</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">cons</span><span class="p">.</span><span class="n">rpos</span> <span class="o">!=</span> <span class="n">cons</span><span class="p">.</span><span class="n">wpos</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">c</span> <span class="o">=</span> <span class="n">cons</span><span class="p">.</span><span class="n">buf</span><span class="p">[</span><span class="n">cons</span><span class="p">.</span><span class="n">rpos</span><span class="o">++</span><span class="p">];</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">cons</span><span class="p">.</span><span class="n">rpos</span> <span class="o">==</span> <span class="n">CONSBUFSIZE</span><span class="p">)</span>
			<span class="n">cons</span><span class="p">.</span><span class="n">rpos</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="k">return</span> <span class="n">c</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="c1">// output a character to the console</span>
<span class="k">static</span> <span class="kt">void</span>
<span class="nf">cons_putc</span><span class="p">(</span><span class="kt">int</span> <span class="n">c</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">serial_putc</span><span class="p">(</span><span class="n">c</span><span class="p">);</span>
	<span class="n">lpt_putc</span><span class="p">(</span><span class="n">c</span><span class="p">);</span>
	<span class="n">cga_putc</span><span class="p">(</span><span class="n">c</span><span class="p">);</span>
<span class="p">}</span>

<span class="c1">// initialize the console devices</span>
<span class="kt">void</span>
<span class="nf">cons_init</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">cga_init</span><span class="p">();</span>
	<span class="n">kbd_init</span><span class="p">();</span>
	<span class="n">serial_init</span><span class="p">();</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">serial_exists</span><span class="p">)</span>
		<span class="n">cprintf</span><span class="p">(</span><span class="s">"Serial port does not exist!</span><span class="se">\n</span><span class="s">"</span><span class="p">);</span>
<span class="p">}</span>


<span class="c1">// `High'-level console I/O.  Used by readline and cprintf.</span>

<span class="kt">void</span>
<span class="nf">cputchar</span><span class="p">(</span><span class="kt">int</span> <span class="n">c</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">cons_putc</span><span class="p">(</span><span class="n">c</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">int</span>
<span class="nf">getchar</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">c</span><span class="p">;</span>

	<span class="k">while</span> <span class="p">((</span><span class="n">c</span> <span class="o">=</span> <span class="n">cons_getc</span><span class="p">())</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
		<span class="cm">/* do nothing */</span><span class="p">;</span>
	<span class="k">return</span> <span class="n">c</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">int</span>
<span class="nf">iscons</span><span class="p">(</span><span class="kt">int</span> <span class="n">fdnum</span><span class="p">)</span>
<span class="p">{</span>
	<span class="c1">// used by readline</span>
	<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></div></div>
<p>ç„¶å Exercise 8.</p>

<p>æ¥ç€æ˜¯å‡ ä¸ªé—®é¢˜:</p>
<blockquote>
  <p>Explain the interface between <code class="language-plaintext highlighter-rouge">printf.c</code> and <code class="language-plaintext highlighter-rouge">console.c</code>. Specifically, what function does <code class="language-plaintext highlighter-rouge">console.c</code> export? How is this function used by <code class="language-plaintext highlighter-rouge">printf.c</code>?</p>
</blockquote>

<p>è§£é‡Š <code class="language-plaintext highlighter-rouge">printf.c</code> å’Œ <code class="language-plaintext highlighter-rouge">console.c</code> ä¹‹é—´çš„æ¥å£. <br />
å…¶å®å°±ä¸€ä¸ªå‡½æ•°, <code class="language-plaintext highlighter-rouge">cputchar()</code>. å…·ä½“åŸç†ä¸å¤ªæƒ³çœ‹äº†. æ ¹æ®å”çš„æ–‡ç« , <code class="language-plaintext highlighter-rouge">console.c</code> é‡Œé¢æ§åˆ¶ CRT ä¹Ÿå°±æ˜¯æ˜¾ç¤ºå™¨æ¥å£è¾“å‡ºçš„.</p>

<blockquote>
  <p>Explain the following from <code class="language-plaintext highlighter-rouge">console.c</code>:</p>
  <div class="language-c highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="mi">1</span>      <span class="nf">if</span> <span class="p">(</span><span class="n">crt_pos</span> <span class="o">&gt;=</span> <span class="n">CRT_SIZE</span><span class="p">)</span> <span class="p">{</span>
<span class="mi">2</span>              <span class="kt">int</span> <span class="n">i</span><span class="p">;</span>
<span class="mi">3</span>              <span class="n">memmove</span><span class="p">(</span><span class="n">crt_buf</span><span class="p">,</span> <span class="n">crt_buf</span> <span class="o">+</span> <span class="n">CRT_COLS</span><span class="p">,</span> <span class="p">(</span><span class="n">CRT_SIZE</span> <span class="o">-</span> <span class="n">CRT_COLS</span><span class="p">)</span> <span class="o">*</span> <span class="k">sizeof</span><span class="p">(</span><span class="kt">uint16_t</span><span class="p">));</span>
<span class="mi">4</span>              <span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="n">CRT_SIZE</span> <span class="o">-</span> <span class="n">CRT_COLS</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">CRT_SIZE</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
<span class="mi">5</span>                      <span class="n">crt_buf</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0x0700</span> <span class="o">|</span> <span class="sc">' '</span><span class="p">;</span>
<span class="mi">6</span>              <span class="n">crt_pos</span> <span class="o">-=</span> <span class="n">CRT_COLS</span><span class="p">;</span>
<span class="mi">7</span>      <span class="p">}</span>
</code></pre></div>  </div>
</blockquote>

<p><code class="language-plaintext highlighter-rouge">CRT_SIZE</code> å’Œ <code class="language-plaintext highlighter-rouge">CRT_COLS</code> æ˜¯å®šä¹‰åœ¨ <code class="language-plaintext highlighter-rouge">console.h</code></p>
<div class="language-c highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="cp">#define CRT_ROWS	25
#define CRT_COLS	80
#define CRT_SIZE	(CRT_ROWS * CRT_COLS)
</span></code></pre></div></div>
<p><code class="language-plaintext highlighter-rouge">crt_buf</code> æ˜¯ä¸€ä¸ª <code class="language-plaintext highlighter-rouge">uint16_t*</code> æŒ‡é’ˆ. çœ‹ä¸æ‡‚å•¥æ„æ€, å‚è€ƒäº†ä¸€ä¸‹å­Ÿä½¬çš„çŸ¥ä¹: ä½œç”¨å°±æ˜¯å±å¹•å†™æ»¡çš„æ—¶å€™, æŠŠç¬¬ä¸€è¡Œæ¶ˆæ‰, ç„¶åå…¶ä»–æ‰€æœ‰è¡Œä¸Šç§»ä¸€è¡Œ, æ–°çš„å†…å®¹å†™åˆ°æ–°çš„è¡Œé‡Œ. ä¸è¿‡ç»“åˆä¸€ä¸‹çœ‹, <code class="language-plaintext highlighter-rouge">CRT_SIZE - CRT_COLS</code> ä¹Ÿç¡®å®åº”è¯¥æ˜¯è¿™ä¸ªæ„æ€å‘¢.</p>

<blockquote>
  <p>For the following questions you might wish to consult the notes for Lecture 2. These notes cover GCCâ€™s calling convention on the x86.<br />
Trace the execution of the following code step-by-step:</p>

  <div class="language-c highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kt">int</span> <span class="n">x</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span> <span class="n">y</span> <span class="o">=</span> <span class="mi">3</span><span class="p">,</span> <span class="n">z</span> <span class="o">=</span> <span class="mi">4</span><span class="p">;</span>
<span class="n">cprintf</span><span class="p">(</span><span class="s">"x %d, y %x, z %d</span><span class="se">\n</span><span class="s">"</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">z</span><span class="p">);</span>
</code></pre></div>  </div>

  <ul>
    <li>In the call to <code class="language-plaintext highlighter-rouge">cprintf()</code>, to what does <code class="language-plaintext highlighter-rouge">fmt</code> point? To what does <code class="language-plaintext highlighter-rouge">ap</code> point?</li>
    <li>List (in order of execution) each call to cons_putc, va_arg, and vcprintf. For cons_putc, list its argument as well. For va_arg, list what ap points to before and after the call. For vcprintf list the values of its two arguments.</li>
  </ul>
</blockquote>

<p>æˆ‘éƒ½ä¸å¤ªæƒ³è°ƒè¯•äº†â€¦å¥½éº»çƒ¦.<br />
gdb æ‰“æ–­ç‚¹å¯ä»¥æŒ‡å®šåˆ°å“ªä¸ªä¸€ä¸ªæ–‡ä»¶çš„å¤šå°‘è¡Œ, æ¯”å¦‚æˆ‘è¿™é‡Œæ˜¯:</p>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>(gdb) b kern/init.c:38
Breakpoint 1 at 0xf01000c8: file kern/init.c, line 38.
(gdb) c
Continuing.
The target architecture is assumed to be i386
=&gt; 0xf01000c8 &lt;i386_init+52&gt;:	push   $0x4

Breakpoint 1, i386_init () at kern/init.c:39
39		cprintf("x %d, y %x, z %d\n", x, y, z);
</code></pre></div></div>
<p>æ¥ç€é€æ­¥è°ƒè¯•:</p>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>(gdb) si
=&gt; 0xf01000ca &lt;i386_init+54&gt;:	push   $0x3
0xf01000ca	39		cprintf("x %d, y %x, z %d\n", x, y, z);
(gdb) si
=&gt; 0xf01000cc &lt;i386_init+56&gt;:	push   $0x1
0xf01000cc	39		cprintf("x %d, y %x, z %d\n", x, y, z);
(gdb) si
=&gt; 0xf01000ce &lt;i386_init+58&gt;:	push   $0xf0101912
0xf01000ce	39		cprintf("x %d, y %x, z %d\n", x, y, z);
(gdb) si
=&gt; 0xf01000d3 &lt;i386_init+63&gt;:	call   0xf0100906 &lt;cprintf&gt;
0xf01000d3	39		cprintf("x %d, y %x, z %d\n", x, y, z);
</code></pre></div></div>
<p>æ‰€ä»¥è¿™é‡Œå¯ä»¥çœ‹åˆ° <code class="language-plaintext highlighter-rouge">fmt</code> åº”è¯¥æ˜¯è¢«å­˜å‚¨åœ¨ 0xf0101912 çš„ä½ç½®çš„, ç”±äºè¿™é‡Œæ˜¯æ˜ å°„çš„è™šæ‹Ÿåœ°å€, æˆ‘ä»¬å¯ä»¥é¡ºå¸¦æ£€æŸ¥ä¸€ä¸‹å¯¹åº”çš„ç‰©ç†åœ°å€çš„å†…å®¹:</p>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>(gdb) x/s 0xf0101912
0xf0101912:	"x %d, y %x, z%d\n"
(gdb) x/s 0x00101912
0x101912:	"x %d, y %x, z%d\n"
</code></pre></div></div>
<p>è¿›å…¥ <code class="language-plaintext highlighter-rouge">cprintf()</code> å‡½æ•°ç»§ç»­.</p>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>(gdb) si
=&gt; 0xf010090f &lt;cprintf+9&gt;:	push   %eax
32		cnt = vcprintf(fmt, ap);
(gdb) si
=&gt; 0xf0100910 &lt;cprintf+10&gt;:	pushl  0x8(%ebp)
0xf0100910	32		cnt = vcprintf(fmt, ap);
(gdb) si
=&gt; 0xf0100913 &lt;cprintf+13&gt;:	call   0xf01008e0 &lt;vcprintf&gt;
0xf0100913	32		cnt = vcprintf(fmt, ap);
</code></pre></div></div>
<p>è¶ eax çš„å€¼è¿˜æ²¡æœ‰æ›´å˜, æˆ‘ä»¬çœ‹ä¸€ä¸‹ eax çš„åœ°å€å¤„åŒ…å«çš„å€¼:</p>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>(gdb) x/3d $eax
0xf010ffd4:	1	3	4
</code></pre></div></div>
<p>æ ¹æ®ä¸Šé¢çš„è°ƒè¯•ä¿¡æ¯, eax é‡Œå­˜çš„åº”è¯¥å°±æ˜¯å¯å˜å‚æ•°åˆ—è¡¨çš„æŒ‡é’ˆå€¼, ä¹Ÿå°±æ˜¯ <code class="language-plaintext highlighter-rouge">ap</code>.<br />
ç¬¬äºŒé¢˜ä¸åšäº†, éƒ½æ˜¯äº›èŠ±æ—¶é—´çš„æ´».</p>

<blockquote>
  <p>Run the following code.</p>
  <div class="language-c highlighter-rouge"><div class="highlight"><pre class="highlight"><code>   <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mh">0x00646c72</span><span class="p">;</span>
   <span class="n">cprintf</span><span class="p">(</span><span class="s">"H%x Wo%s"</span><span class="p">,</span> <span class="mi">57616</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">i</span><span class="p">);</span>
</code></pre></div>  </div>
  <p>What is the output? Explain how this output is arrived at in the step-by-step manner of the previous exercise. <a href="http://web.cs.mun.ca/~michael/c/ascii-table.html">Hereâ€™s an ASCII table</a> that maps bytes to characters.<br />
The output depends on that fact that the x86 is little-endian. If the x86 were instead big-endian what would you set i to in order to yield the same output? Would you need to change 57616 to a different value?</p>

  <p><a href="http://www.webopedia.com/TERM/b/big_endian.html">Hereâ€™s a description of little- and big-endian</a> and <a href="http://www.networksorcery.com/enp/ien/ien137.txt">a more whimsical description</a>.</p>
</blockquote>

<p>å…ˆè¯´ä¸€ä¸‹è¾“å‡º, æ˜¯ <code class="language-plaintext highlighter-rouge">He110 World</code>.   <br />
å¾ˆç®€å•, åªéœ€è¦æ‹¿ ASCII ç è¡¨æ¥å¯¹åº”ä¸€ä¸‹å°±å¯ä»¥äº†. <br />
è¿™é‡Œå¦‚æœæ¢æˆå¤§ç«¯æ³•, è‚¯å®šæ˜¯ä¸å½±å“å‰é¢çš„å¸¸æ•°çš„, ä½†æ˜¯åé¢çš„ä¼šå€’è¿‡æ¥. å­Ÿä½¬å’Œå”çš„æ–‡ç« éƒ½å†™åº”è¯¥è¾“å‡º <code class="language-plaintext highlighter-rouge">He110 Wodlr</code>, ä½†æ˜¯æˆ‘è§‰å¾— 00 ä¼šè¢«æ”¾åˆ°æœ€å‰é¢, åº”è¯¥ä½åœ°å€ç«¯çš„ç¬¬ä¸€ä¸ªå­—èŠ‚å°±æ˜¯ <code class="language-plaintext highlighter-rouge">'\0'</code>, åé¢çš„å†…å®¹ä¹Ÿå°±ä¸ä¼šè¾“å‡º, æ‰€ä»¥åº”è¯¥æ˜¯ <code class="language-plaintext highlighter-rouge">He110 Wo</code>.</p>

<blockquote>
  <p>In the following code, what is going to be printed after â€˜y=â€™? (note: the answer is not a specific value.) Why does this happen?</p>
  <div class="language-c highlighter-rouge"><div class="highlight"><pre class="highlight"><code>   <span class="n">cprintf</span><span class="p">(</span><span class="s">"x=%d y=%d"</span><span class="p">,</span> <span class="mi">3</span><span class="p">);</span>
</code></pre></div>  </div>
</blockquote>

<p>UB. è¾“å‡ºæ˜¯ <code class="language-plaintext highlighter-rouge">x=3, y=1600</code>. æˆ‘ä»¬çœ‹ä¸‹è°ƒè¯•çš„ç»“æœ.</p>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>(gdb) si
=&gt; 0xf01000cb &lt;i386_init+55&gt;:	push   $0x3
0xf01000cb	37		cprintf("x=%d, y=%d", 3);
(gdb) si
=&gt; 0xf01000cd &lt;i386_init+57&gt;:	push   $0xf0101912
0xf01000cd	37		cprintf("x=%d, y=%d", 3);
(gdb) si
=&gt; 0xf01000d2 &lt;i386_init+62&gt;:	call   0xf0100907 &lt;cprintf&gt;
0xf01000d2	37		cprintf("x=%d, y=%d", 3);
(gdb) si
=&gt; 0xf0100907 &lt;cprintf&gt;:	push   %ebp
cprintf (fmt=0xf0101912 "x=%d, y=%d") at kern/printf.c:27
</code></pre></div></div>
<p>ç­‰ <code class="language-plaintext highlighter-rouge">cprintf</code> çš„æ ˆéƒ¨ç½²å®Œæ¯•å, ç„¶åæˆ‘ä»¬çœ‹ä¸‹æ ˆçš„ä¿¡æ¯:</p>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>(gdb) x/8d $ebp
0xf010ffd8:	-267321352	-267386665	-267380462	3
0xf010ffe8:	1600	0	0	0
</code></pre></div></div>
<p>æˆ‘ä»¬åªçŸ¥é“ <code class="language-plaintext highlighter-rouge">3</code> åé¢æ˜¯ <code class="language-plaintext highlighter-rouge">1600</code>, åŸå› ä¸æ¸…æ¥š.</p>

<blockquote>
  <p>Letâ€™s say that GCC changed its calling convention so that it pushed arguments on the stack in declaration order, so that the last argument is pushed last. How would you have to change cprintf or its interface so that it would still be possible to pass it a variable number of arguments?</p>
</blockquote>

<p>çœ‹èµ·æ¥è¿™ä¸ªå¾ˆéº»çƒ¦å‘¢. ä½†æ˜¯æˆ‘è§‰å¾—è¿™æ ·ä¹Ÿè¿˜æ˜¯å¯è¡Œçš„:</p>
<div class="language-c highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kt">int</span> <span class="nf">cprintf</span><span class="p">(...,</span> <span class="n">fmt</span><span class="p">);</span>
</code></pre></div></div>
<p>æ²¡æœ‰æµ‹è¯•æˆ‘ä¹Ÿä¸æ˜¯å¾ˆæ¸…æ¥šèƒ½ä¸èƒ½è¿è¡Œ.</p>

<blockquote>
  <p><em>Challenge</em> Enhance the console to allow text to be printed in different colors. The traditional way to do this is to make it interpret <a href="http://rrbrandt.dee.ufcg.edu.br/en/docs/ansi/">ANSI escape sequences</a> embedded in the text strings printed to the console, but you may use any mechanism you like. There is plenty of information on <a href="https://pdos.csail.mit.edu/6.828/2018/reference.html">the 6.828 reference page</a> and elsewhere on the web on programming the VGA display hardware. If youâ€™re feeling really adventurous, you could try switching the VGA hardware into a graphics mode and making the console draw text onto the graphical frame buffer.</p>
</blockquote>

<p>Challenge ç¡®ç¡®å®å®æ˜¯ä¸€ä¸ª Challenge å‘¢. è®©æˆ‘ä»¬æƒ³åŠæ³•æ”¹å˜ VGA ç¡¬ä»¶çš„æ˜¾ç¤ºé¢œè‰².<br />
æˆ‘ä»¬å†ä¸€æ¬¡è¿›å…¥åˆ° <code class="language-plaintext highlighter-rouge">console.c</code> é‡Œ, è·Ÿé¢œè‰²ç›¸å…³çš„ä¼°è®¡å°±æ˜¯â€æˆ–ç­‰äºä¸€ä¸ªåå…­è¿›åˆ¶æ•°â€ä¹‹ç±»çš„è¯­å¥, æš‚æ—¶å…ˆé”å®šè¿™æ ·çš„æ‰¾å°±è¡Œäº†.<br />
æœä¸å…¶ç„¶, æˆ‘ä»¬åœ¨ L165~167 æ‰¾åˆ°äº†ä¸€æ¡æ³¨é‡Šå’Œå‡ ä¸ªè¯­å¥:</p>
<div class="language-c highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">// if no attribute given, then use black on white</span>
<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">c</span> <span class="o">&amp;</span> <span class="o">~</span><span class="mh">0xFF</span><span class="p">))</span>
	<span class="n">c</span> <span class="o">|=</span> <span class="mh">0x0700</span><span class="p">;</span>
</code></pre></div></div>
<p>é¦–å…ˆ, <code class="language-plaintext highlighter-rouge">c</code> æ˜¯ä¸€ä¸ª <code class="language-plaintext highlighter-rouge">int</code> å‹, æ¡ä»¶é‡Œé¢çš„æ„æ€å¤§æ¦‚å°±æ˜¯å¦‚æœ <code class="language-plaintext highlighter-rouge">c</code> çš„æœ€ä½ä¸€ä¸ªå­—èŠ‚ç­‰äº 0, å°±è®©å®ƒæˆ–ä¸Šä¸€ä¸ª <code class="language-plaintext highlighter-rouge">0x0700</code>. 
å¥½äº†, å¥½åœ¨æˆ‘åœ¨å‡ å¹´å‰(ä¼°æ‘¸ç€åº”è¯¥æœ‰ 8 å¹´äº†)å†™è¿‡ Windows çš„æ‰¹å¤„ç†ç¨‹åº, çŸ¥é“å®ƒçš„ <code class="language-plaintext highlighter-rouge">color</code> æŒ‡ä»¤çš„å¸®åŠ©ä¿¡æ¯é‡Œæœ‰å¼ è¡¨, è¿™é‡ŒæŠŠå®ƒæˆªå–è¿‡æ¥:</p>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>    0 = é»‘è‰²       8 = ç°è‰²
    1 = è“è‰²       9 = æ·¡è“è‰²
    2 = ç»¿è‰²       A = æ·¡ç»¿è‰²
    3 = æµ…ç»¿è‰²     B = æ·¡æµ…ç»¿è‰²
    4 = çº¢è‰²       C = æ·¡çº¢è‰²
    5 = ç´«è‰²       D = æ·¡ç´«è‰²
    6 = é»„è‰²       E = æ·¡é»„è‰²
    7 = ç™½è‰²       F = äº®ç™½è‰²
</code></pre></div></div>
<p>é¡ºå¸¦æˆ‘è¿˜çŒœæµ‹ç¬¬ä¸‰ä¸ªåå…­è¿›åˆ¶ä½è¡¨ç¤ºå‰æ™¯è‰², ç¬¬å››ä¸ªåå…­è¿›åˆ¶ä½è¡¨ç¤ºèƒŒæ™¯è‰². æˆ‘å°†è¿™ä¸ªæ•°å­—æ”¹æˆäº† <code class="language-plaintext highlighter-rouge">0x2700</code>, æœä¸å…¶ç„¶, æ˜¾ç¤º Booting from Hard Disk ä¹‹åçš„æ‰€æœ‰è¾“å‡ºä¿¡æ¯, éƒ½æ˜¯ç»¿èƒŒæ™¯è‰². <br />
è¿™ä¸ªæŒ‘æˆ˜ä¹Ÿå°±ç®—æ˜¯å®Œæˆäº†. å¥½åƒä¹Ÿä¸æ˜¯é‚£ä¹ˆéš¾.</p>

<h3 id="the-stack">The Stack</h3>
<p>æˆ‘ä»¬çš„ lab1 å†…å®¹æ¥è¿‘å°¾å£°äº†, ä½†æ˜¯ä»æœ‰ 4 ä¸ª Exercise è¿˜åœ¨ç­‰ç€æˆ‘ä»¬.<br />
è¿™ä¸ªéƒ¨åˆ†æˆ‘ä»¬å°†æ›´å¤šåœ°äº†è§£ x86 æœºå™¨çš„ C è¯­è¨€ä¸­æ ˆçš„å·¥ä½œæ¨¡å¼, æœ€åå°±åˆ°äº†æˆ‘ä»¬æ•´ä¸ª lab1 æœ€é«˜æ½®åœ°éƒ¨åˆ† â€“ å†™ä¸€ä¸ªæ–°çš„å‡½æ•°æ¥æ‰“å°æ ˆçš„ backtrace â€“ ä¸€ä¸ªä¿å­˜äº† IP(Instruction Pointer) å€¼çš„åˆ—è¡¨. è¿™ä¸ª IP å€¼æ¥è‡ªå¼•å¯¼å½“å‰æ‰§è¡Œä½ç½®çš„ <code class="language-plaintext highlighter-rouge">call</code> æŒ‡ä»¤.<br />
å¼€å¯ Exercise 9.</p>

<p>x86 æ ˆæŒ‡é’ˆ(ESP å¯„å­˜å™¨)æŒ‡å‘å½“å‰æ ˆä½¿ç”¨çš„æœ€ä½åœ°å€, æ‰€æœ‰åœ¨æ ˆåŒºåŸŸä¿å­˜èŒƒå›´å†…çš„ä»¥ ESP æŒ‡é’ˆä»¥ä¸‹æ‰€æœ‰å†…å­˜åŒºåŸŸå‡æ˜¯æ ˆçš„ç©ºé—²åŒºåŸŸ(free). å€¼å…¥æ ˆä¼šå…ˆä½¿æ ˆæŒ‡é’ˆå‡å°, ç„¶åå°†å€¼å­˜è¿›æ ˆæŒ‡é’ˆçš„ä½ç½®. å‡ºæ ˆç›¸å. åœ¨ 32 ä½æ¨¡å¼ä¸‹, æ ˆåªå­˜ 32 ä½å€¼, äºæ˜¯æ ˆæŒ‡é’ˆçš„å˜åŒ–ä»¥ 4 ä¸ºå•ä½. ä¹Ÿå°±æ˜¯æˆ‘ä»¬åœ¨ NASM æ•™ç¨‹ä¸­ä¸€ç›´ä»¥æ¥çœ‹åˆ°çš„äº†. <br />
æ¯”è¾ƒä¹‹ä¸‹, åŸºæŒ‡é’ˆ(Base Pointer, aka EBP å¯„å­˜å™¨)ä¸»è¦å…³è”è½¯ä»¶ä¸­çº¦å®šçš„æ ˆ. è¿™ä¸ªæˆ‘ä»¬åœ¨ NASM æ•™ç¨‹æè¿°æ¥å£æŠ€æœ¯çš„éƒ¨åˆ†ä¹Ÿçœ‹åˆ°äº†. åœ¨ C å‡½æ•°å…¥å£å¤„, ä½¿ç”¨ gdb è°ƒè¯•åº”ä¸º <code class="language-plaintext highlighter-rouge">{</code> çš„ä½ç½®(åŸæ–‡ä½¿ç”¨äº†åºå¹•ä»£ç  prologue code è¿™ä¸ªè¯), EBP çš„å€¼ä¼šå…ˆå…¥æ ˆ, ç„¶åå°† ESP çš„å€¼æ‹·è´åˆ° EBP. å¦‚æœå…¨éƒ¨å‡½æ•°éƒ½éµå¾ªè¿™ä¸ªçº¦å®š, ç„¶åæ˜¯ä¸€ä¸ªé•¿å¥:</p>
<blockquote>
  <p>It is possible to trace back through the stack by following the chain of saved ebp pointers and determining exactly what nested sequence of function calls caused this particular point in the program to be reached.</p>
</blockquote>

<p>ç›´æ¥è§£é‡Šä¸€ä¸‹å°±æ˜¯å‡½æ•°è°ƒç”¨æˆé“¾çŠ¶äº†, å°±å¯ä»¥å®ç°ä¸€ä¸ªåŠŸèƒ½, å‡½æ•°è°ƒç”¨çš„å›æº¯è·Ÿè¸ª, å³ä¸ºåˆšæ‰å°±æåˆ°çš„ backtrace.<br />
backtrace å¯ä»¥å¸®åŠ©æˆ‘ä»¬è·Ÿè¸ªåˆ° <code class="language-plaintext highlighter-rouge">assert</code> çš„é”™è¯¯æ ¹æºæˆ–è€…æ˜¯ <code class="language-plaintext highlighter-rouge">panic</code> çš„å‚æ•°é”™è¯¯æ ¹æº, ä¹Ÿå°±æ˜¯åœ¨å…¶ä»–é«˜çº§è¯­è¨€ä¸­å¸¸è§çš„å¼‚å¸¸é“¾çš„å®ç°åŸºç¡€.<br />
å¼€å§‹ Exercise 10.</p>

<p>åŸæ–‡æç¤ºå¯ä»¥ä½¿ç”¨çº¯ C å®Œæˆ <code class="language-plaintext highlighter-rouge">mon_backtrace()</code> å‡½æ•°, ä½†æ˜¯åœ¨é‚£ä¹‹å‰éœ€è¦å»äº†è§£ä¸€ä¸‹ <code class="language-plaintext highlighter-rouge">inc/x86.h</code> ä¸­çš„ <code class="language-plaintext highlighter-rouge">read_ebp()</code> å‡½æ•°, è®©ç”¨æˆ·èƒ½åœ¨ monitor ä¸­è°ƒç”¨å®ƒ. <br />
backtrace å‡½æ•°éœ€è¦æœ‰ä¸‹é¢æ ¼å¼çš„è¾“å‡ºä¿¡æ¯:</p>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>Stack backtrace:
  ebp f0109e58  eip f0100a62  args 00000001 f0109e80 f0109e98 f0100ed2 00000031
  ebp f0109ed8  eip f01000d6  args 00000000 00000000 f0100058 f0109f28 00000061
  ...
</code></pre></div></div>
<p>æ¯ä¸€è¡ŒåŒ…æ‹¬ ebp, eip å’Œ args. ebp å­˜å‚¨çš„æ˜¯å †æ ˆçš„ base point, ä¹Ÿå°±æ˜¯æˆ‘ä»¬ä¹‹å‰åœ¨ Exercise ä¸­æåˆ°çš„å¿«ç…§. eip æ˜¯ return instruction pointer, è¿”å›æŒ‡ä»¤åœ°å€, å­˜å‚¨çš„ä¸œè¥¿å°±ä¸ç”¨å¤šè¯´äº†. args æ˜¯ä¼ å…¥å‡½æ•°çš„å‰äº”é¡¹å‚æ•°, å½“ç„¶å‡½æ•°çš„å‚æ•°å¯èƒ½ä¸å¤Ÿäº”ä¸ª, æ— æ‰€è°“, åé¢çš„æ•°æ®å°±å½“æ˜¯åºŸçš„. <br />
ä»‹ç»å®Œæ¯•, é‚£ä¹ˆå¼€å§‹ Exercise 11.</p>

<p>æœ‰äº†è¿™ä¹ˆä¸€ä¸ªå‡½æ•°çš„æ”¯æ’‘å, ä¹Ÿå°±è·Ÿæˆ‘ä¸Šé¢æåˆ°è¿‡çš„å¼‚å¸¸é“¾ä¸€æ ·, å®ƒå¯ä»¥å¸®åŠ©ç”¨æˆ·æ›´å®¹æ˜“åœ°æ‰¾åˆ°åˆ°åº•æ˜¯ä»è°ƒç”¨åœ°å“ªä¸€å±‚å¼€å§‹å‡ºé”™çš„, ä¹Ÿç®—æ˜¯ä¸€ä¸ªå°å°çš„å¼‚å¸¸é“¾ç³»ç»Ÿäº†. <br />
lab1 çš„æœ€åä¸€ä¸ªå¤§ä½œä¸š, å°±æ˜¯è¦å°†è¿™ä¸ªå‡½æ•°æ•´åˆè¿›ç³»ç»Ÿçš„æŒ‡ä»¤ä¸­. æˆ‘ä»¬æä¾›ä¸€ä¸ªå‡½æ•° <code class="language-plaintext highlighter-rouge">debuginfo_eip()</code>, ç”¨æ¥æŸ¥é˜…ç¬¦å·è¡¨ä¸­çš„ eip å¹¶è¿”å›åœ°å€çš„è°ƒè¯•ä¿¡æ¯. è¿™ä¸ªå‡½æ•°è¢«å£°æ˜åœ¨ <code class="language-plaintext highlighter-rouge">kern/kdebug.c</code> ä¸­. åè§ Exersice 12.</p>

<p>æ­£æ–‡çš„å†…å®¹å°±æ­¤å®Œç»“, lab2 å†è§.</p>

<h1 id="exercises">Exercises</h1>
<h2 id="exercise-1">Exercise 1</h2>
<blockquote>
  <p><strong>Exercise 1.</strong> Familiarize yourself with the assembly language materials available on <a href="https://pdos.csail.mit.edu/6.828/2018/reference.html">the 6.828 reference page</a>. You donâ€™t have to read them now, but youâ€™ll almost certainly want to refer to some of this material when reading and writing x86 assembly.</p>

  <p>We do recommend reading the section â€œThe Syntaxâ€ in <a href="http://www.delorie.com/djgpp/doc/brennan/brennan_att_inline_djgpp.html">Brennanâ€™s Guide to Inline Assembly</a>. It gives a good (and quite brief) description of the AT&amp;T assembly syntax weâ€™ll be using with the GNU assembler in JOS.</p>
</blockquote>

<p>æ­£æ–‡éƒ¨åˆ†è¯´è¿‡äº†, æœ‰ä¸“é—¨å¼€ä¸€ä¸ªæ–‡ç« å†™æ±‡ç¼–ä¹¦. æœ¬èº«æ±‡ç¼–ä¹Ÿæ˜¯ä¸“ä¸šè¯¾å§, æ‰€ä»¥èŠ±äº†ç‚¹æ—¶é—´, ç»Ÿè®¡äº†ä¸‹æœ‰ 70k å­—.<br />
å¦å¤–ä¸€ä¸ª <a href="http://www.delorie.com/djgpp/doc/brennan/brennan_att_inline_djgpp.html"><em>Brennanâ€™s Guide to Inline Assembly</em></a> æ˜¯ä¸€ä¸ªè®² C Inline æ±‡ç¼–çš„æ–‡ç« . æ²¡æœ‰çœ‹äº†, è§å”çš„æ–‡ç« <a href="#ref2">$^2$</a>.</p>

<h2 id="exercise-2">Exercise 2</h2>
<blockquote>
  <p><strong>Exercise 2.</strong> Use GDBâ€™s si (Step Instruction) command to trace into the ROM BIOS for a few more instructions, and try to guess what it might be doing. You might want to look at <a href="http://web.archive.org/web/20040404164813/members.iweb.net.au/~pstorr/pcbook/book2/book2.htm">Phil Storrs I/O Ports Description</a>, as well as other materials on the <a href="https://pdos.csail.mit.edu/6.828/2018/reference.html">6.828 reference materials page</a>. No need to figure out all the details - just the general idea of what the BIOS is doing first.</p>
</blockquote>

<p>ä½¿ç”¨ <code class="language-plaintext highlighter-rouge">si</code> æŒ‡ä»¤é€æ­¥è°ƒè¯•ç„¶åçŒœä½œç”¨.</p>
<pre><code class="language-asm">[f000:fff0]    0xffff0:	ljmp   $0xf000,$0xe05b
[f000:e05b]    0xfe05b:	cmpl   $0x0,%cs:0x6c48      # cs == 0xf000
[f000:e062]    0xfe062:	jne    0xfd2e1
[f000:e066]    0xfe066:	xor    %dx,%dx              # dx = 0
[f000:e068]    0xfe068:	mov    %dx,%ss              # ss = dx = 0
[f000:e06a]    0xfe06a:	mov    $0x7000,%esp         # esp = 0x7000
[f000:e070]    0xfe070:	mov    $0xf3691,%edx        # edx = 0xf3691
[f000:e076]    0xfe076:	jmp    0xfd165
[f000:d165]    0xfd165:	mov    %eax,%ecx            # ecx = eax
[f000:d168]    0xfd168:	cli                         # 
[f000:d169]    0xfd169:	cld                         # DF = 0, å¢æ–¹å‘
</code></pre>
<blockquote>
  <p>CLIï¼šClear Interupt, ç¦æ­¢ä¸­æ–­å‘ç”Ÿ. STLï¼šSet Interupt, å…è®¸ä¸­æ–­å‘ç”Ÿ. CLIå’ŒSTIæ˜¯ç”¨æ¥å±è”½ä¸­æ–­å’Œæ¢å¤ä¸­æ–­ç”¨çš„, å¦‚è®¾ç½®æ ˆåŸºå€SSå’Œåç§»åœ°å€SPæ—¶, éœ€è¦CLI, å› ä¸ºå¦‚æœè¿™ä¸¤æ¡æŒ‡ä»¤è¢«åˆ†å¼€äº†, é‚£ä¹ˆå¾ˆæœ‰å¯èƒ½SSè¢«ä¿®æ”¹äº†, ä½†ç”±äºä¸­æ–­, è€Œä»£ç è·³å»å…¶å®ƒåœ°æ–¹æ‰§è¡Œäº†, SPè¿˜æ²¡æ¥å¾—åŠä¿®æ”¹, å°±æœ‰å¯èƒ½å‡ºé”™. <br />
CLD: Clear Director. STDï¼šSet Director. åœ¨å­—è¡Œå—ä¼ é€æ—¶ä½¿ç”¨çš„, å®ƒä»¬å†³å®šäº†å—ä¼ é€çš„æ–¹å‘. CLDä½¿å¾—ä¼ é€æ–¹å‘ä»ä½åœ°å€åˆ°é«˜åœ°å€, è€ŒSTDåˆ™ç›¸å. <a href="#ref3">$^3$</a></p>
</blockquote>

<pre><code class="language-asm">[f000:d16a]    0xfd16a:	mov    $0x8f,%eax           # eax = 0x8f
[f000:d170]    0xfd170:	out    %al,$0x70            # å°† al çš„æ•°æ®å¯¼å‡ºåˆ° 0x70 ç«¯å£
[f000:d172]    0xfd172:	in     $0x71,%al            # å°† 0x71 ç«¯å£çš„æ•°æ®å¯¼å…¥åˆ° al
</code></pre>
<p>out å’Œ in æŒ‡ä»¤ç”¨äºæ“ä½œ IO ç«¯å£.</p>
<blockquote>
  <p>CPUä¸å¤–éƒ¨è®¾å¤‡é€šè®¯æ—¶, é€šå¸¸æ˜¯é€šè¿‡è®¿é—®, ä¿®æ”¹è®¾å¤‡æ§åˆ¶å™¨ä¸­çš„å¯„å­˜å™¨æ¥å®ç°çš„. é‚£ä¹ˆè¿™äº›ä½äºè®¾å¤‡æ§åˆ¶å™¨å½“ä¸­çš„å¯„å­˜å™¨ä¹Ÿå«åšIOç«¯å£. ä¸ºäº†æ–¹ä¾¿ç®¡ç†, 80x86CPUé‡‡ç”¨IOç«¯å£å•ç‹¬ç¼–å€çš„æ–¹å¼, å³æ‰€æœ‰è®¾å¤‡çš„ç«¯å£éƒ½è¢«å‘½ååˆ°ä¸€ä¸ªIOç«¯å£åœ°å€ç©ºé—´ä¸­. è¿™ä¸ªç©ºé—´æ˜¯ç‹¬ç«‹äºå†…å­˜åœ°å€ç©ºé—´çš„. æ‰€ä»¥å¿…é¡»é‡‡ç”¨å’Œè®¿é—®å†…å­˜çš„æŒ‡ä»¤ä¸ä¸€æ ·çš„æŒ‡ä»¤æ¥è®¿é—®ç«¯å£. <br />
0x70ç«¯å£å’Œ0x71ç«¯å£æ˜¯ç”¨äºæ§åˆ¶ç³»ç»Ÿä¸­ä¸€ä¸ªå«åšCMOSçš„è®¾å¤‡, è¿™ä¸ªè®¾å¤‡æ˜¯ä¸€ä¸ªä½åŠŸè€—çš„å­˜å‚¨è®¾å¤‡, å®ƒå¯ä»¥ç”¨äºåœ¨è®¡ç®—æœºå…³é—­æ—¶å­˜å‚¨ä¸€äº›ä¿¡æ¯, å®ƒæ˜¯ç”±ç‹¬ç«‹çš„ç”µæ± ä¾›ç”µçš„. <br />
è¿™ä¸ªCMOSä¸­å¯ä»¥æ§åˆ¶è·ŸPCç›¸å…³çš„å¤šä¸ªåŠŸèƒ½, å…¶ä¸­æœ€é‡è¦çš„å°±æ˜¯æ—¶é’Ÿè®¾å¤‡ï¼ˆReal Time Clockï¼‰çš„ , å®ƒè¿˜å¯ä»¥æ§åˆ¶æ˜¯å¦å“åº”ä¸å¯å±è”½ä¸­æ–­NMI(Non-Maskable Interrupt). <br />
æ“ä½œCMOSå­˜å‚¨å™¨ä¸­çš„å†…å®¹éœ€è¦ä¸¤ä¸ªç«¯å£, ä¸€ä¸ªæ˜¯0x70å¦ä¸€ä¸ªå°±æ˜¯0x71. å…¶ä¸­0x70å¯ä»¥å«åšç´¢å¼•å¯„å­˜å™¨, è¿™ä¸ª8ä½å¯„å­˜å™¨çš„æœ€é«˜ä½æ˜¯ä¸å¯å±è”½ä¸­æ–­(NMI)ä½¿èƒ½ä½. å¦‚æœä½ æŠŠè¿™ä¸ªä½ç½®1, åˆ™NMIä¸ä¼šè¢«å“åº”. ä½7ä½ç”¨äºæŒ‡å®šCMOSå­˜å‚¨å™¨ä¸­çš„å­˜å‚¨å•å…ƒåœ°å€, æ‰€ä»¥å¦‚æœä½ æƒ³è®¿é—®ç¬¬1å·å­˜å‚¨å•å…ƒ, å¹¶ä¸”åœ¨è®¿é—®æ—¶, æˆ‘è¦ä½¿èƒ½NMI, é‚£ä¹ˆä½ å°±åº”è¯¥å‘ç«¯å£0x70é‡Œé¢é€å…¥0b10000001 = 0x81. <a href="#ref4">$^4$</a></p>
</blockquote>

<p>è¿™é‡Œ mov 0x8f åˆ° eax ä¸­, ç„¶åå°†å€¼å¯¼å…¥ 0x70 ç«¯å£, æ˜¯ä¸ºäº†èƒ½é€šè¿‡ 0x71 ç«¯å£è®¿é—®å­˜å‚¨å•å…ƒ 0xf çš„å€¼(<code class="language-plaintext highlighter-rouge">in $0x71,%al</code>), å¹¶ä¸”å…³é—­ NMI ä¸­æ–­. ä½†æ˜¯ al çš„å€¼å¹¶æ²¡æœ‰è¢«åˆ©ç”¨. <strong>æ‰€ä»¥è®¤ä¸ºè¿™ä¸‰è¡Œæ˜¯ç”¨æ¥å…³é—­ NMI ä¸­æ–­çš„.</strong></p>
<pre><code class="language-asm">[f000:d174]    0xfd174:	in     $0x92,%al            # å°† 0x92 ç«¯å£çš„æ•°æ®å¯¼å…¥åˆ° al
[f000:d176]    0xfd176:	or     $0x2,%al             # å°† al çš„(å³æ•°)ç¬¬ 1 ä½(bit1)ç½®ä¸º 1
[f000:d178]    0xfd178:	out    %al,$0x92            # å°† al å¯¼å›å»
</code></pre>
<p>è¿™ä¸‰è¡Œçš„ä½œç”¨å°±æ˜¯å°† 0x92 ç«¯å£çš„ bit1 ä¿®æ”¹ä¸º 1.<br />
0x92 æ§åˆ¶çš„æ˜¯ PS/2 ç³»ç»Ÿæ§åˆ¶æ¥å£ A<a href="#ref5">$^5$</a>, è€Œ bit 1= 1 indicates A20 active, å³ bit1 æ˜¯ A20 ä½, å³ç¬¬ 21 ä¸ªåœ°å€çº¿è¢«ä½¿èƒ½. <strong>A20 åœ°å€çº¿è¢«æ¿€æ´»æ—¶, ç³»ç»Ÿå·¥ä½œåœ¨ä¿æŠ¤æ¨¡å¼.</strong> ä½†æ˜¯ boot loader ç¨‹åºä¸­è®¡ç®—æœºä»éœ€è¦å·¥ä½œåœ¨å®æ¨¡å¼ä¸‹. æ‰€ä»¥è¿™é‡Œåº”è¯¥åªæ˜¯æµ‹è¯•å¯ç”¨å†…å­˜ç©ºé—´.<a href="#ref6">$^6$</a></p>
<pre><code class="language-asm">[f000:d17a]    0xfd17a:	lidtw  %cs:0x6c38           # å°†ä»åœ°å€ 0x6c38 èµ·å§‹çš„åé¢ 6 ä¸ªå­—èŠ‚æ•°æ®è¯»å…¥ IDTR ä¸­
</code></pre>
<blockquote>
  <p>lidtæŒ‡ä»¤ï¼šåŠ è½½ä¸­æ–­å‘é‡è¡¨å¯„å­˜å™¨(IDTR). è¿™ä¸ªæŒ‡ä»¤ä¼šæŠŠä»åœ°å€0xf6ab8èµ·å§‹çš„åé¢6ä¸ªå­—èŠ‚çš„æ•°æ®è¯»å…¥åˆ°ä¸­æ–­å‘é‡è¡¨å¯„å­˜å™¨(IDTR)ä¸­. ä¸­æ–­æ˜¯æ“ä½œç³»ç»Ÿä¸­éå¸¸é‡è¦çš„ä¸€éƒ¨åˆ†, æœ‰äº†ä¸­æ–­æ“ä½œç³»ç»Ÿæ‰èƒ½çœŸæ­£å®ç°è¿›ç¨‹. æ¯ä¸€ç§ä¸­æ–­éƒ½æœ‰è‡ªå·±å¯¹åº”çš„ä¸­æ–­å¤„ç†ç¨‹åº, é‚£ä¹ˆè¿™ä¸ªä¸­æ–­çš„å¤„ç†ç¨‹åºçš„é¦–åœ°å€å°±å«åšè¿™ä¸ªä¸­æ–­çš„ä¸­æ–­å‘é‡. ä¸­æ–­å‘é‡è¡¨è‡ªç„¶æ˜¯å­˜æ”¾æ‰€æœ‰ä¸­æ–­å‘é‡çš„è¡¨äº†. <a href="#ref4">$^4$</a></p>
</blockquote>

<pre><code class="language-asm">[f000:d180]    0xfd180:	lgdtw  %cs:0x6bf4           # 
</code></pre>
<p>æŠŠä» 0xf6bf4 ä¸ºèµ·å§‹åœ°å€å¤„çš„6ä¸ªå­—èŠ‚çš„å€¼åŠ è½½åˆ°å…¨å±€æè¿°ç¬¦è¡¨æ ¼å¯„å­˜å™¨(GDTR)ä¸­. GDTR å°†åœ¨ boot loader ä¸­ä»‹ç».</p>
<pre><code class="language-asm">[f000:d186]    0xfd186:	mov    %cr0,%eax
[f000:d189]    0xfd189:	or     $0x1,%eax
[f000:d18d]    0xfd18d:	mov    %eax,%cr0            # cr0 |= 0x1
</code></pre>
<p>å°†æ§åˆ¶å¯„å­˜å™¨çš„ bit0 ç½® 1. è®¡ç®—æœºåŒ…å«å››ä¸ªæ§åˆ¶å¯„å­˜å™¨ CR0~CR3, CR0 æ˜¯ PE ä½(å¯åŠ¨ä¿æŠ¤ä½), ç½® 1 è¡¨ç¤ºå¼€å¯ä¿æŠ¤æ¨¡å¼.</p>
<pre><code class="language-asm">[f000:d190]    0xfd190:	ljmpl  $0x8,$0xfd198
The target architecture is assumed to be i386
=&gt; 0xfd198:	mov    $0x10,%eax                       # eax = 0x10
=&gt; 0xfd19d:	mov    %eax,%ds                         # ds = eax
=&gt; 0xfd19f:	mov    %eax,%es                         # es = eax
=&gt; 0xfd1a1:	mov    %eax,%ss                         # ss = eax
=&gt; 0xfd1a3:	mov    %eax,%fs                         # fs = eax
=&gt; 0xfd1a5:	mov    %eax,%gs                         # gs = eax
=&gt; 0xfd1a7:	mov    %ecx,%eax                        # eax = ecx
=&gt; 0xfd1a9:	jmp    *%edx
=&gt; 0xf3691:	push   %ebx                             # ç†Ÿæ‚‰çš„å­ç¨‹åºè°ƒç”¨...
...
</code></pre>
<p>ä¸Šé¢è¿™äº›å¯„å­˜å™¨è®¾ç½®æ˜¯æŒ‰è§„å®šæ¥çš„. åˆšåˆšåŠ è½½å®Œ GDTR å¿…é¡»è¦é‡æ–°åŠ è½½æ‰€æœ‰æ®µå¯„å­˜å™¨çš„å€¼<a href="#ref7">$^7$</a>, è€Œ CS æ®µå¯„å­˜å™¨å¿…é¡»é€šè¿‡é•¿è·³è½¬æŒ‡ä»¤(<code class="language-plaintext highlighter-rouge">ljmp</code>), è¿™æ ·ç›¸å½“äºä½¿ GDTR ç”Ÿæ•ˆ<a href="#ref4">$^4$</a>.</p>

<blockquote>
  <p>F Segment (FS). Pointer to more extra data (â€˜Fâ€™ comes after â€˜Eâ€™).<br />
G Segment (GS). Pointer to still more extra data (â€˜Gâ€™ comes after â€˜Fâ€™).<a href="#ref2">$^2$</a></p>
</blockquote>

<h2 id="exercise-3">Exercise 3</h2>
<blockquote>
  <p><strong>Exercise 3.</strong> Take a look at the <a href="https://pdos.csail.mit.edu/6.828/2018/labguide.html">lab tools guide</a>, especially the section on GDB commands. Even if youâ€™re familiar with GDB, this includes some esoteric GDB commands that are useful for OS work.</p>

  <p>Set a breakpoint at address 0x7c00, which is where the boot sector will be loaded. Continue execution until that breakpoint. Trace through the code in <code class="language-plaintext highlighter-rouge">boot/boot.S</code>, using the source code and the disassembly file <code class="language-plaintext highlighter-rouge">obj/boot/boot.asm</code> to keep track of where you are. Also use the <code class="language-plaintext highlighter-rouge">x/i</code> command in GDB to disassemble sequences of instructions in the boot loader, and compare the original boot loader source code with both the disassembly in <code class="language-plaintext highlighter-rouge">obj/boot/boot.asm</code> and GDB.</p>

  <p>Trace into <code class="language-plaintext highlighter-rouge">bootmain()</code> in <code class="language-plaintext highlighter-rouge">boot/main.c</code>, and then into <code class="language-plaintext highlighter-rouge">readsect()</code>. Identify the exact assembly instructions that correspond to each of the statements in <code class="language-plaintext highlighter-rouge">readsect()</code>. Trace through the rest of <code class="language-plaintext highlighter-rouge">readsect()</code> and back out into <code class="language-plaintext highlighter-rouge">bootmain()</code>, and identify the begin and end of the <code class="language-plaintext highlighter-rouge">for</code> loop that reads the remaining sectors of the kernel from the disk. Find out what code will run when the loop is finished, set a breakpoint there, and continue to that breakpoint. Then step through the remainder of the boot loader.</p>
</blockquote>

<p>ç”¨ GDB åœ¨ 0x7c00 å¤„æ‰“ä¸ªæ–­ç‚¹, è¿™ä¸ªåœ°å€ä¹Ÿå°±æ˜¯å¼•å¯¼æ‰‡åŒºçš„èµ·å§‹åœ°å€. ä½¿ç”¨ <code class="language-plaintext highlighter-rouge">x/i</code> æ¥æŸ¥çœ‹ boot loader å†…çš„æŒ‡ä»¤, ç„¶åä¸ <code class="language-plaintext highlighter-rouge">obj/bool/boot.asm</code> çš„åæ±‡ç¼–ä»£ç è¿›è¡Œæ¯”è¾ƒ.<br />
åœ¨ <code class="language-plaintext highlighter-rouge">boot.S</code> éƒ¨åˆ†, è®¾ç½® CR0 æ—¶, GDB è°ƒè¯•å‡ºçš„ä»£ç , å’Œåæ±‡ç¼–ä»£ç éƒ½ä¸å¤ªç›¸åŒ:<br />
GDB:</p>
<pre><code class="language-asm">   0x7c1a:	mov    $0xdf,%al
   0x7c1c:	out    %al,$0x60
   0x7c1e:	lgdtw  0x7c64
   0x7c23:	mov    %cr0,%eax
</code></pre>
<p>boot.asm:</p>
<pre><code class="language-asm">  movl    %cr0, %eax
    7c24:       20 c0                   and    %al,%al
  orl     $CR0_PE_ON, %eax
    7c26:       66 83 c8 01             or     $0x1,%ax
  movl    %eax, %cr0
    7c2a:       0f 22 c0                mov    %eax,%cr0
</code></pre>
<p>åŸå› æœªçŸ¥, ä½†æ˜¯åŠŸèƒ½å®ç°äº†, ä¾¿æ— è®ºä»£ç äº†.<br />
æ¥ç€åˆ° 0x7d15<bootmain> çš„ä½ç½®:</bootmain></p>
<pre><code class="language-asm"># void bootmain(void) {
    0x7d15:	push   %ebp
    0x7d16:	mov    %esp,%ebp
    0x7d18:	push   %esi
    0x7d19:	push   %ebx

    # ä¸‰ä¸ªå‚æ•°å…¥æ ˆ
    0x7d1a:	push   $0x0                  # offset = 0
    0x7d1c:	push   $0x1000               # count  = SECTSIZE * 8 = 0x200 &lt;&lt; 3
    0x7d21:	push   $0x10000              # pa     = 0x10000
    # è°ƒç”¨ readseg
    0x7d26:	call   0x7cdc
        # void readseg(uint32_t pa, uint32_t count, uint32_t offset) {
        0x7cdc:	push   %ebp
        0x7cdd:	mov    %esp,%ebp
        0x7cdf:	push   %edi
        0x7ce0:	push   %esi

        0x7ce1:	mov    0x10(%ebp),%edi   # edi = offset
        0x7ce4:	push   %ebx              # ä¿å­˜ ebx, ä¸‹ä¸‹è¡Œç”¨åˆ°äº†è¿™ä¸ªå¯„å­˜å™¨
        0x7ce5:	mov    0xc(%ebp),%esi    # esi = count
        0x7ce8:	mov    0x8(%ebp),%ebx    # ebx = pa

        0x7ceb:	shr    $0x9,%edi         # offset = (offset / SECTSIZE)
        0x7cee:	add    %ebx,%esi         # count += pa, esi(count) --&gt; esi(end_pa)
        0x7cf0:	inc    %edi              # offset += 1   // è·Ÿä¸Šä¸Šä¸€è¡Œå…±åŒæ„æˆ offset = (offset / SECTSIZE) + 1;
        0x7cf1:	and    $0xfffffe00,%ebx  # pa &amp;= ~(SECTSIZE - 1);

        # while (pa &lt; end_pa)
        0x7cf7:	cmp    %esi,%ebx
        0x7cf9:	jae    0x7d0d

        # å‚æ•°å…¥æ ˆå‡†å¤‡è°ƒç”¨å‡½æ•°
        0x7cfb:	push   %edi              # offset
        0x7cfc:	push   %ebx              # pa

        0x7cfd:	inc    %edi              # offset++;
        0x7cfe:	add    $0x200,%ebx       # pa += SECTSIZE;
        # è°ƒç”¨ readsect
        0x7d04:	call   0x7c7c
            # void readsect(void *dst, uint32_t offset) {
            0x7c7c:	push   %ebp
            0x7c7d:	mov    %esp,%ebp

            0x7c7f:	push   %edi                          # ä¿å­˜ edi
            0x7c80:	mov    0xc(%ebp),%ecx                # ecx = offset
            # è°ƒç”¨ waitdisk
            0x7c83:	call   0x7c6a
                # void waitdisk(void) {
                0x7c6a:	push   %ebp
                0x7c6b:	mov    $0x1f7,%edx           # edx = 0x1f7
                0x7c70:	mov    %esp,%ebp

                0x7c72:	in     (%dx),%al             # al = inb(0x1F7)
                0x7c73:	and    $0xffffffc0,%eax      # eax &amp; 0xC0
                # while ((inb(0x1F7) &amp; 0xC0) != 0x40)
                0x7c76:	cmp    $0x40,%al
                0x7c78:	jne    0x7c72

                0x7c7a:	pop    %ebp
                0x7c7b:	ret
                # }

            # outb(0x1F2, 1);
            0x7c88:	mov    $0x1f2,%edx               # edx = 0x1f2
            0x7c8d:	mov    $0x1,%al                  # al = 1
            0x7c8f:	out    %al,(%dx)
            # outb(0x1F3, offset);
            0x7c90:	mov    $0x1f3,%edx               # edx = 0x1f3
            0x7c95:	mov    %cl,%al                   # al = cl; ecx == offset
            0x7c97:	out    %al,(%dx)
            # outb(0x1F4, offset &gt;&gt; 8);
            0x7c98:	mov    %ecx,%eax                 # eax = ecx = offset
            0x7c9a:	mov    $0x1f4,%edx               # edx = 0x1f4
            0x7c9f:	shr    $0x8,%eax                 # eax &gt;&gt;= 8
            0x7ca2:	out    %al,(%dx)
            # outb(0x1F5, offset &gt;&gt; 16);
            0x7ca3:	mov    %ecx,%eax                 # eax = ecx = offset 
            0x7ca5:	mov    $0x1f5,%edx               # edx = 0x1f5
            0x7caa:	shr    $0x10,%eax                # eax &gt;&gt;= 16
            0x7cad:	out    %al,(%dx)
            # outb(0x1F6, (offset &gt;&gt; 24) | 0xE0);
            0x7cae:	mov    %ecx,%eax                 # eax = ecx = offset
            0x7cb0:	mov    $0x1f6,%edx               # edx = 0x1f6
            0x7cb5:	shr    $0x18,%eax                # edx &gt;&gt;= 24
            0x7cb8:	or     $0xffffffe0,%eax          # edx |= 0xe0
            0x7cbb:	out    %al,(%dx)
            # outb(0x1F7, 0x20)
            0x7cbc:	mov    $0x1f7,%edx               # edx = 0x1f7
            0x7cc1:	mov    $0x20,%al                 # al = 0x20
            0x7cc3:	out    %al,(%dx)

            # è°ƒç”¨ waitdisk (ç•¥)
            0x7cc4:	call   0x7c6a

            # insl(0x1F0, dst, SECTSIZE/4);
            0x7cc9:	mov    0x8(%ebp),%edi            # dst
            0x7ccc:	mov    $0x80,%ecx                # SECTSIZE/4
            0x7cd1:	mov    $0x1f0,%edx               # 0x1F0
            0x7cd6:	cld                              # DF = 0
            0x7cd7:	repnz insl (%dx),%es:(%edi)

            0x7cd9:	pop    %edi
            0x7cda:	pop    %ebp
            0x7cdb:	ret
            # }

        0x7d0d:	lea    -0xc(%ebp),%esp               # å¤åŸ esp
        0x7d10:	pop    %ebx
        0x7d11:	pop    %esi
        0x7d12:	pop    %edi
        0x7d13:	pop    %ebp
        0x7d14:	ret
        # }

    # å‚æ•°é€€æ ˆ
    0x7d2b:	add    $0xc,%esp
    # if (ELFHDR-&gt;e_magic != ELF_MAGIC) {
    0x7d2e:	cmpl   $0x464c457f,0x10000
    # goto bad;
    0x7d38:	jne    0x7d71
    # }

        # bad: {
        # outw(0x8A00, 0x8A00);
        0x7d71:	mov    $0x8a00,%edx
        0x7d76:	mov    $0xffff8a00,%eax
        0x7d7b:	out    %ax,(%dx)
        # outw(0x8A00, 0x8E00);
        0x7d7d:	mov    $0xffff8e00,%eax
        0x7d82:	out    %ax,(%dx)
        # while (1);
        0x7d84:	jmp    0x7d84
        # }

    # ebx == ph, esi == eph
    # ph = (struct Proghdr *) ((uint8_t *) ELFHDR + ELFHDR-&gt;e_phoff);
    0x7d3a:	mov    0x1001c,%eax                      # eax = 0x1001c == ELFHDR-&gt;e_phoff
    0x7d3f:	movzwl 0x1002c,%esi                      # esi = 0x1002c
    0x7d46:	lea    0x10000(%eax),%ebx                # ph = ebx = eax + ELFHDR
    # eph = ph + ELFHDR-&gt;e_phnum;
    0x7d4c:	shl    $0x5,%esi                         # esi &lt;&lt;= 5; esi == ELFHDR-&gt;e_phnum
    0x7d4f:	add    %ebx,%esi                         # eph = esi = ELFHDR-&gt;e_phnum + ph

    # for (; ph &lt; eph; ph++) {
    0x7d51:	cmp    %esi,%ebx
    0x7d53:	jae    0x7d6b

    # å‚æ•°å…¥æ ˆ
    0x7d55:	pushl  0x4(%ebx)                         # ph-&gt;p_offset
    0x7d58:	pushl  0x14(%ebx)                        # ph-&gt;p_memsz
    0x7d5b:	add    $0x20,%ebx                        # ph++
    0x7d5e:	pushl  -0x14(%ebx)                       # ph-&gt;p_pa
    0x7d61:	call   0x7cdc                            # è°ƒç”¨ readseg (ç•¥)
    0x7d66:	add    $0xc,%esp                         # å‚æ•°å‡ºæ ˆ
    0x7d69:	jmp    0x7d51
    # }

    # ((void (*)(void)) (ELFHDR-&gt;e_entry))();
    0x7d6b:	call   *0x10018
# } // bootmain quit
</code></pre>
<p>å°±æ²¡æ¯”è¾ƒäº†, èŠ±äº†å¥½é•¿æ—¶é—´æŠŠä»£ç è¯»äº†, å¹¶ä¸”å’Œ C æºä»£ç åšäº†å¯¹åº”.</p>

<h2 id="exercise-4">Exercise 4</h2>
<blockquote>
  <p><strong>Exercise 4.</strong> Read about programming with pointers in C. The best reference for the C language is <em>The C Programming Language</em> by Brian Kernighan and Dennis Ritchie (known as â€˜K&amp;Râ€™). We recommend that students purchase this book (here is an <a href="http://www.amazon.com/C-Programming-Language-2nd/dp/0131103628/sr=8-1/qid=1157812738/ref=pd_bbs_1/104-1502762-1803102?ie=UTF8&amp;s=books">Amazon Link</a>) or find one of <a href="http://library.mit.edu/F/AI9Y4SJ2L5ELEE2TAQUAAR44XV5RTTQHE47P9MKP5GQDLR9A8X-10422?func=item-global&amp;doc_library=MIT01&amp;doc_number=000355242&amp;year=&amp;volume=&amp;sub_library=">MITâ€™s 7 copies</a>.</p>

  <p>Read 5.1 (Pointers and Addresses) through 5.5 (Character Pointers and Functions) in K&amp;R. Then download the code for <a href="https://pdos.csail.mit.edu/6.828/2018/labs/lab1/pointers.c">pointers.c</a>, run it, and make sure you understand where all of the printed values come from. In particular, make sure you understand where the pointer addresses in printed lines 1 and 6 come from, how all the values in printed lines 2 through 4 get there, and why the values printed in line 5 are seemingly corrupted.</p>

  <p>There are other references on pointers in C (e.g., <a href="https://pdos.csail.mit.edu/6.828/2018/readings/pointers.pdf">A tutorial by Ted Jensen</a> that cites K&amp;R heavily), though not as strongly recommended.</p>

  <p>Warning: Unless you are already thoroughly versed in C, do not skip or even skim this reading exercise. If you do not really understand pointers in C, you will suffer untold pain and misery in subsequent labs, and then eventually come to understand them the hard way. Trust us; you donâ€™t want to find out what â€œthe hard wayâ€ is.</p>
</blockquote>

<p>è¢«å®‰åˆ©äº†ä¸¤æœ¬ classic, ä¸€æœ¬æ˜¯ K&amp;R, å¦å¤–ä¸€æœ¬æ˜¯ <em>Pointers in C</em>. ä»–è®©æˆ‘ä»¬å»è¯»å…³äº C æŒ‡é’ˆçš„å†…å®¹. è¿‡äºåŸºç¡€æˆ‘ä»¬è·³è¿‡.<br />
æœ€åè¿˜æœ‰ä¸ªè­¦å‘Š, è¯´çš„æ˜¯å³ä½¿ä½ æ˜¯è€å¸æœºè¿˜æ˜¯ä¸æ¨èè·³è¿‡æˆ–è€…ç•¥è¯»æ¨èå†…å®¹, å› ä¸ºè€å¸æœºåœ¨åé¢çš„ lab ä¸­ä¹Ÿå¾ˆå®¹æ˜“ç¿»è½¦. æˆ‘ä»¬ç›´æ¥æ— è§†å®ƒ.<br />
pointer.c çš„ä»£ç :</p>
<div class="language-c highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="cp">#include &lt;stdio.h&gt;
#include &lt;stdlib.h&gt;
</span>
<span class="kt">void</span>
<span class="nf">f</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
    <span class="kt">int</span> <span class="n">a</span><span class="p">[</span><span class="mi">4</span><span class="p">];</span>
    <span class="kt">int</span> <span class="o">*</span><span class="n">b</span> <span class="o">=</span> <span class="n">malloc</span><span class="p">(</span><span class="mi">16</span><span class="p">);</span>
    <span class="kt">int</span> <span class="o">*</span><span class="n">c</span><span class="p">;</span>
    <span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

    <span class="n">printf</span><span class="p">(</span><span class="s">"1: a = %p, b = %p, c = %p</span><span class="se">\n</span><span class="s">"</span><span class="p">,</span> <span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">,</span> <span class="n">c</span><span class="p">);</span>

    <span class="n">c</span> <span class="o">=</span> <span class="n">a</span><span class="p">;</span>
    <span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">4</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
        <span class="n">a</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="mi">100</span> <span class="o">+</span> <span class="n">i</span><span class="p">;</span>
    <span class="n">c</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="mi">200</span><span class="p">;</span>
    <span class="n">printf</span><span class="p">(</span><span class="s">"2: a[0] = %d, a[1] = %d, a[2] = %d, a[3] = %d</span><span class="se">\n</span><span class="s">"</span><span class="p">,</span>
	      <span class="n">a</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">a</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">a</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span> <span class="n">a</span><span class="p">[</span><span class="mi">3</span><span class="p">]);</span>

    <span class="n">c</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="mi">300</span><span class="p">;</span>
    <span class="o">*</span><span class="p">(</span><span class="n">c</span> <span class="o">+</span> <span class="mi">2</span><span class="p">)</span> <span class="o">=</span> <span class="mi">301</span><span class="p">;</span>
    <span class="mi">3</span><span class="p">[</span><span class="n">c</span><span class="p">]</span> <span class="o">=</span> <span class="mi">302</span><span class="p">;</span>
    <span class="n">printf</span><span class="p">(</span><span class="s">"3: a[0] = %d, a[1] = %d, a[2] = %d, a[3] = %d</span><span class="se">\n</span><span class="s">"</span><span class="p">,</span>
	      <span class="n">a</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">a</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">a</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span> <span class="n">a</span><span class="p">[</span><span class="mi">3</span><span class="p">]);</span>

    <span class="n">c</span> <span class="o">=</span> <span class="n">c</span> <span class="o">+</span> <span class="mi">1</span><span class="p">;</span>
    <span class="o">*</span><span class="n">c</span> <span class="o">=</span> <span class="mi">400</span><span class="p">;</span>
    <span class="n">printf</span><span class="p">(</span><span class="s">"4: a[0] = %d, a[1] = %d, a[2] = %d, a[3] = %d</span><span class="se">\n</span><span class="s">"</span><span class="p">,</span>
	      <span class="n">a</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">a</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">a</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span> <span class="n">a</span><span class="p">[</span><span class="mi">3</span><span class="p">]);</span>

    <span class="n">c</span> <span class="o">=</span> <span class="p">(</span><span class="kt">int</span> <span class="o">*</span><span class="p">)</span> <span class="p">((</span><span class="kt">char</span> <span class="o">*</span><span class="p">)</span> <span class="n">c</span> <span class="o">+</span> <span class="mi">1</span><span class="p">);</span>
    <span class="o">*</span><span class="n">c</span> <span class="o">=</span> <span class="mi">500</span><span class="p">;</span>
    <span class="n">printf</span><span class="p">(</span><span class="s">"5: a[0] = %d, a[1] = %d, a[2] = %d, a[3] = %d</span><span class="se">\n</span><span class="s">"</span><span class="p">,</span>
	      <span class="n">a</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">a</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">a</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span> <span class="n">a</span><span class="p">[</span><span class="mi">3</span><span class="p">]);</span>

    <span class="n">b</span> <span class="o">=</span> <span class="p">(</span><span class="kt">int</span> <span class="o">*</span><span class="p">)</span> <span class="n">a</span> <span class="o">+</span> <span class="mi">1</span><span class="p">;</span>
    <span class="n">c</span> <span class="o">=</span> <span class="p">(</span><span class="kt">int</span> <span class="o">*</span><span class="p">)</span> <span class="p">((</span><span class="kt">char</span> <span class="o">*</span><span class="p">)</span> <span class="n">a</span> <span class="o">+</span> <span class="mi">1</span><span class="p">);</span>
    <span class="n">printf</span><span class="p">(</span><span class="s">"6: a = %p, b = %p, c = %p</span><span class="se">\n</span><span class="s">"</span><span class="p">,</span> <span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">,</span> <span class="n">c</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">int</span>
<span class="nf">main</span><span class="p">(</span><span class="kt">int</span> <span class="n">ac</span><span class="p">,</span> <span class="kt">char</span> <span class="o">**</span><span class="n">av</span><span class="p">)</span>
<span class="p">{</span>
    <span class="n">f</span><span class="p">();</span>
    <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></div></div>

<h2 id="exercise-5">Exercise 5</h2>
<blockquote>
  <p><strong>Exercise 5.</strong> Trace through the first few instructions of the boot loader again and identify the first instruction that would â€œbreakâ€ or otherwise do the wrong thing if you were to get the boot loaderâ€™s link address wrong. Then change the link address in boot/Makefrag to something wrong, run<code class="language-plaintext highlighter-rouge"> make clean</code>, recompile the lab with <code class="language-plaintext highlighter-rouge">make</code>, and trace into the boot loader again to see what happens. Donâ€™t forget to change the link address back and <code class="language-plaintext highlighter-rouge">make clean</code> again afterward!</p>
</blockquote>

<p>è¿™ä¸ªä¹ é¢˜æˆ‘æœ‰ç•™æ„ myk å’Œå”çš„æ–‡ç« , å­Ÿä½¬æŠŠæ”¹æˆ 0x8c00 äº†, å”æ”¹æˆäº† 0x6c00, æˆ‘å°±è¯•è¯• 0x1c00 ä¼šæ€ä¹ˆæ ·å§. <br />
ä¿®æ”¹ <code class="language-plaintext highlighter-rouge">boot/Makefrag</code> é‡Œçš„åœ°å€ä¿¡æ¯(éšä¾¿æ”¹, åæ­£æ•´ä¸ªé¡¹ç›®æœ‰ç‰ˆæœ¬æ§åˆ¶ç¨‹åºæ‰˜ç®¡), å°† 0x7c00 æ”¹æˆ 0x1c00, å…ˆæ‰§è¡Œä¸€æ¬¡ <code class="language-plaintext highlighter-rouge">make clean</code>, å†æ‰§è¡Œä¸€æ¬¡ <code class="language-plaintext highlighter-rouge">make</code>, çœ‹æ•ˆæœ.<br />
make çš„ä¿¡æ¯è¿˜æ˜¯è·Ÿä¹‹å‰ä¸€æ ·. ä½†æ˜¯è¿™é‡Œè¦æ’å…¥ä¸€å°æ®µ, <code class="language-plaintext highlighter-rouge">ld: warning: section '.bss' type changed to PROGBITS</code> è¿™ä¸€è¡Œæ ¹æ®å”çš„æ–‡ç« , åœ¨ 0x7c00 çš„æƒ…å†µä¸‹ä»–æ˜¯æ²¡æœ‰å‡ºç°çš„, è€Œæˆ‘æ˜¯ä¸¤æ¬¡éƒ½æœ‰å‡ºç°, å¼•ç”¨ä¸€ä¸‹ä»–çš„æ–‡ç« :</p>
<blockquote>
  <p>å¦‚æœ.bssæ˜¯NOBITSçš„ï¼Œé‚£ä¹ˆé“¾æ¥å™¨ä¼šåœ¨è¾“å‡ºçš„æ–‡ä»¶é‡Œå‘Šè¯‰æ“ä½œç³»ç»Ÿå½“è¿™ä¸ªç¨‹åºè¢«åŠ è½½çš„æ—¶å€™ï¼Œæ ¹æ®æä¾›çš„ä¿¡æ¯ï¼Œå°†æŸä¸€å—å†…å­˜ç»™åˆ†é…å‡ºæ¥ï¼Œå¹¶ç½®0ï¼Œä½†æ˜¯å¦‚æœæ˜¯PROGBITSçš„è¯ï¼Œå°±æ˜¯å‘Šè¯‰ç³»ç»Ÿä»æ–‡ä»¶é‡Œå–å‡ºä¸€å—å·²ç»è¢«ç½®0çš„æ•°æ®æ®µå­˜å…¥å†…å­˜ä¸­ï¼Œæ‰€ä»¥åŒºåˆ«å°±åœ¨NOBITSçš„æ–‡ä»¶ä¸­ï¼Œ.bbsæ•°æ®æ®µæ˜¯ä¸å ç”¨ç©ºé—´çš„ï¼Œä½†æ˜¯PROGBITSçš„æ•°æ®æ®µæ˜¯å ç”¨ç©ºé—´çš„ã€‚è™½ç„¶æœ€åå¯¹è¿è¡Œçš„ç¨‹åºæ²¡ä»€ä¹ˆå½±å“ï¼Œæœ€å¤§çš„å½±å“æ˜¯å¯æ‰§è¡Œæ–‡ä»¶å¤šäº†ä¸€å—è¢«ç½®é›¶çš„æ•°æ®æ®µï¼Œéœ€è¦å ç”¨æ›´å¤šçš„ç©ºé—´ã€‚<a href="#ref2">$^2$</a></p>
</blockquote>

<p>ç„¶å, å…ˆç”¨ <code class="language-plaintext highlighter-rouge">objdump</code> æ£€æŸ¥ä¸€ä¸‹åœ°å€:</p>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>$ objdump -h obj/boot/boot.out 

obj/boot/boot.out:     file format elf32-i386

Sections:
Idx Name          Size      VMA       LMA       File off  Algn
  0 .text         00000186  00001c00  00001c00  00000074  2**2
                  CONTENTS, ALLOC, LOAD, CODE
  1 .eh_frame     000000a8  00001d88  00001d88  000001fc  2**2
                  CONTENTS, ALLOC, LOAD, READONLY, DATA
  2 .stab         00000720  00000000  00000000  000002a4  2**2
                  CONTENTS, READONLY, DEBUGGING
  3 .stabstr      0000088f  00000000  00000000  000009c4  2**0
                  CONTENTS, READONLY, DEBUGGING
  4 .comment      00000035  00000000  00000000  00001253  2**0
                  CONTENTS, READONLY
</code></pre></div></div>
<p>å¯ä»¥çœ‹åˆ° <code class="language-plaintext highlighter-rouge">.text</code> çš„ VMA å’Œ LMA ç¡®å®æ˜¯åˆ° 0x1c00 äº†.<br />
æ¥ç€æˆ‘ä½¿ç”¨ gdb åœ¨ 0x1c00 å¤„æ–­ç‚¹æ˜¯æ²¡æ³•è·Ÿè¸ªçš„. ç›´æ¥è¿è¡Œè¿›è¡Œæµ‹è¯•:</p>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>$ make qemu-nox
sed "s/localhost:1234/localhost:26000/" &lt; .gdbinit.tmpl &gt; .gdbinit
***
*** Use Ctrl-a x to exit qemu
***
qemu-system-i386 -nographic -drive file=obj/kern/kernel.img,index=0,media=disk,format=raw -serial mon:stdio -gdb tcp::26000 -D qemu.log 
main-loop: WARNING: I/O thread spun for 1000 iterations
</code></pre></div></div>
<p>ç„¶åå°±åœ¨è¿™é‡Œå¡ä½äº†. è½¬åˆ°è™šæ‹Ÿæœºä¸­çš„ Ubuntu æ¡Œé¢ç¯å¢ƒæ‰§è¡Œ <code class="language-plaintext highlighter-rouge">make qemu</code>, ä¼šå‘ç° qemu çª—å£åœ¨ä¸åœé—ªçƒ, éšçº¦çœ‹åˆ°æœ‰ <code class="language-plaintext highlighter-rouge">Booting from hard disk</code> çš„å­—æ ·. 
æ¥ç€æˆ‘ä»¬æµ‹è¯• 0x7c00 ä¹‹åçš„åœ°å€, æˆ‘é€‰æ‹©äº† 0xac00. æƒ…å†µå®Œå…¨ç›¸åŒ. 
ä½¿ç”¨ gdb è°ƒè¯•, å°†æ–­ç‚¹æ‰“åœ¨ 0x7c00 çš„ä½ç½®:</p>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>(gdb) b *0x7c00
Breakpoint 1 at 0x7c00
(gdb) c
Continuing.
[   0:7c00] =&gt; 0x7c00:	cli    

Breakpoint 1, 0x00007c00 in ?? ()
(gdb) x/50
   0x7c01:	cld    
   0x7c02:	xor    %ax,%ax
   0x7c04:	mov    %ax,%ds
   0x7c06:	mov    %ax,%es
   0x7c08:	mov    %ax,%ss
   0x7c0a:	in     $0x64,%al
   0x7c0c:	test   $0x2,%al
   0x7c0e:	jne    0x7c0a
   0x7c10:	mov    $0xd1,%al
   0x7c12:	out    %al,$0x64
   0x7c14:	in     $0x64,%al
   0x7c16:	test   $0x2,%al
   0x7c18:	jne    0x7c14
   0x7c1a:	mov    $0xdf,%al
   0x7c1c:	out    %al,$0x60
   0x7c1e:	lgdtw  -0x539c
   0x7c23:	mov    %cr0,%eax
   0x7c26:	or     $0x1,%eax
   0x7c2a:	mov    %eax,%cr0
   0x7c2d:	ljmp   $0x8,$0xac32
   0x7c32:	mov    $0xd88e0010,%eax
   0x7c38:	mov    %ax,%es
   0x7c3a:	mov    %ax,%fs
   0x7c3c:	mov    %ax,%gs
   0x7c3e:	mov    %ax,%ss
   0x7c40:	mov    $0xac00,%sp
   0x7c43:	add    %al,(%bx,%si)
   0x7c45:	call   0x7d13
   0x7c48:	add    %al,(%bx,%si)
   0x7c4a:	jmp    0x7c4a
   0x7c4c:	add    %al,(%bx,%si)
   0x7c4e:	add    %al,(%bx,%si)
   0x7c50:	add    %al,(%bx,%si)
   0x7c52:	add    %al,(%bx,%si)
   0x7c54:	(bad)  
   0x7c55:	incw   (%bx,%si)
   0x7c57:	add    %al,(%bx,%si)
   0x7c59:	lcall  $0xffff,$0xcf
   0x7c5e:	add    %al,(%bx,%si)
   0x7c60:	add    %dl,0xcf(%bp,%si)
   0x7c64:	pop    %ss
   0x7c65:	add    %cl,-0x54(%si)
   0x7c68:	add    %al,(%bx,%si)
   0x7c6a:	push   %bp
   0x7c6b:	mov    $0x1f7,%dx
   0x7c6e:	add    %al,(%bx,%si)
   0x7c70:	mov    %sp,%bp
   0x7c72:	in     (%dx),%al
   0x7c73:	and    $0xffc0,%ax
   0x7c76:	cmp    $0x40,%al
</code></pre></div></div>

<p>ä½œä¸ºå‚è€ƒæˆ‘æ‰“å°äº†åŸæ¥æƒ…å½¢çš„åæ–‡ 50 ä¸ªæŒ‡ä»¤:</p>
<pre><code class="language-asm">(gdb) x/50
   0x7c01:	cld    
   0x7c02:	xor    %ax,%ax
   0x7c04:	mov    %ax,%ds
   0x7c06:	mov    %ax,%es
   0x7c08:	mov    %ax,%ss
   0x7c0a:	in     $0x64,%al
   0x7c0c:	test   $0x2,%al
   0x7c0e:	jne    0x7c0a
   0x7c10:	mov    $0xd1,%al
   0x7c12:	out    %al,$0x64
   0x7c14:	in     $0x64,%al
   0x7c16:	test   $0x2,%al
   0x7c18:	jne    0x7c14
   0x7c1a:	mov    $0xdf,%al
   0x7c1c:	out    %al,$0x60
   0x7c1e:	lgdtw  0x7c64
   0x7c23:	mov    %cr0,%eax
   0x7c26:	or     $0x1,%eax
   0x7c2a:	mov    %eax,%cr0
   0x7c2d:	ljmp   $0x8,$0x7c32
   0x7c32:	mov    $0xd88e0010,%eax
   0x7c38:	mov    %ax,%es
   0x7c3a:	mov    %ax,%fs
   0x7c3c:	mov    %ax,%gs
   0x7c3e:	mov    %ax,%ss
   0x7c40:	mov    $0x7c00,%sp
   0x7c43:	add    %al,(%bx,%si)
   0x7c45:	call   0x7d13
   0x7c48:	add    %al,(%bx,%si)
   0x7c4a:	jmp    0x7c4a
   0x7c4c:	add    %al,(%bx,%si)
   0x7c4e:	add    %al,(%bx,%si)
   0x7c50:	add    %al,(%bx,%si)
   0x7c52:	add    %al,(%bx,%si)
   0x7c54:	(bad)  
   0x7c55:	incw   (%bx,%si)
   0x7c57:	add    %al,(%bx,%si)
   0x7c59:	lcall  $0xffff,$0xcf
   0x7c5e:	add    %al,(%bx,%si)
   0x7c60:	add    %dl,0xcf(%bp,%si)
   0x7c64:	pop    %ss
   0x7c65:	add    %cl,0x7c(%si)
   0x7c68:	add    %al,(%bx,%si)
   0x7c6a:	push   %bp
   0x7c6b:	mov    $0x1f7,%dx
   0x7c6e:	add    %al,(%bx,%si)
   0x7c70:	mov    %sp,%bp
   0x7c72:	in     (%dx),%al
   0x7c73:	and    $0xffc0,%ax
   0x7c76:	cmp    $0x40,%al
</code></pre>
<p>å› ä¸ºä¸€æ—¶é—´æ‰‹å¤´æ²¡æœ‰ä»€ä¹ˆæ¯”è¾ƒæ–‡æœ¬çš„å·¥å…·, å°±ç›´æ¥ç”¨ <code class="language-plaintext highlighter-rouge">git diff</code> äº†:</p>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>diff --git a/ex5 b/ex5
index 3955d53..76c3fd6 100644
--- a/ex5
+++ b/ex5
@@ -14,17 +14,17 @@
    0x7c18:     jne    0x7c14
    0x7c1a:     mov    $0xdf,%al
    0x7c1c:     out    %al,$0x60
-   0x7c1e:     lgdtw  0x7c64
+   0x7c1e:     lgdtw  -0x539c
    0x7c23:     mov    %cr0,%eax
    0x7c26:     or     $0x1,%eax
    0x7c2a:     mov    %eax,%cr0
-   0x7c2d:     ljmp   $0x8,$0x7c32
+   0x7c2d:     ljmp   $0x8,$0xac32
    0x7c32:     mov    $0xd88e0010,%eax
    0x7c38:     mov    %ax,%es
    0x7c3a:     mov    %ax,%fs
    0x7c3c:     mov    %ax,%gs
    0x7c3e:     mov    %ax,%ss
-   0x7c40:     mov    $0x7c00,%sp
+   0x7c40:     mov    $0xac00,%sp
    0x7c43:     add    %al,(%bx,%si)
    0x7c45:     call   0x7d13
    0x7c48:     add    %al,(%bx,%si)
@@ -40,7 +40,7 @@
    0x7c5e:     add    %al,(%bx,%si)
    0x7c60:     add    %dl,0xcf(%bp,%si)
    0x7c64:     pop    %ss
-   0x7c65:     add    %cl,0x7c(%si)
+   0x7c65:     add    %cl,-0x54(%si)
    0x7c68:     add    %al,(%bx,%si)
    0x7c6a:     push   %bp
    0x7c6b:     mov    $0x1f7,%dx
</code></pre></div></div>
<p>å‡ºäº†ä¸€äº›è›®å¤§çš„é—®é¢˜, GDTR è¢«æ‰”äº†ä¸€ä¸ªè´Ÿåœ°å€è¿›å», è¿™æ˜¾ç„¶æ˜¯ä¸åˆæ³•çš„; é•¿è·³è½¬çš„ä½ç½®éšç€ 0x7c00 è¢«ä¿®æ”¹æˆ 0xac00 ä¹Ÿéšä¹‹å˜åŠ¨äº†, åŸæœ¬åº”è¯¥ç›´æ¥è·³è½¬åˆ°ä¸‹ä¸€ä¸ªæŒ‡ä»¤çš„, ç°åœ¨ä¸çŸ¥é“è·³åˆ°å“ªé‡Œå»äº†, æ‰€ä»¥åé¢å°±ä¸ç”¨å†çœ‹äº†.<br />
æˆ‘åœ¨ä¿®æ”¹æ—¶å€™å»ºäº†ä¸ªåˆ†æ”¯, ç°åœ¨åˆ‡å› <code class="language-plaintext highlighter-rouge">lab1</code> åˆ†æ”¯, ç„¶åæŠŠæ”¹åŠ¨çš„åˆ é™¤.</p>

<h2 id="exercise-6">Exercise 6</h2>
<blockquote>
  <p><strong>Exercise 6.</strong> We can examine memory using GDBâ€™s <code class="language-plaintext highlighter-rouge">x</code> command. The <a href="https://sourceware.org/gdb/current/onlinedocs/gdb/Memory.html">GDB manual</a> has full details, but for now, it is enough to know that the command <code class="language-plaintext highlighter-rouge">x/Nx ADDR</code> prints N words of memory at ADDR. (Note that both â€˜<code class="language-plaintext highlighter-rouge">x</code>â€™s in the command are lowercase.) Warning: The size of a word is not a universal standard. In GNU assembly, a word is two bytes (the â€˜wâ€™ in xorw, which stands for word, means 2 bytes).</p>

  <p>Reset the machine (exit QEMU/GDB and start them again). Examine the 8 words of memory at 0x00100000 at the point the BIOS enters the boot loader, and then again at the point the boot loader enters the kernel. Why are they different? What is there at the second breakpoint? (You do not really need to use QEMU to answer this question. Just think.)</p>
</blockquote>

<p>åœ¨åˆšè¿›å…¥ boot loader çš„æ—¶å€™(å°†æ–­ç‚¹æ‰“åœ¨ 0x7c00), æ‰“å°å‡ºçš„æ•°æ®å…¨æ˜¯ 0.</p>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>(gdb) x/8x 0x00100000
0x100000:	0x00000000	0x00000000	0x00000000	0x00000000
0x100010:	0x00000000	0x00000000	0x00000000	0x00000000
</code></pre></div></div>
<p>æ¥ç€æˆ‘ä»¬å°†æ–­ç‚¹æ‰“åœ¨è°ƒç”¨ <code class="language-plaintext highlighter-rouge">e_entry</code> çš„ä½ç½®:</p>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>(gdb) b *0x7d6b
Breakpoint 1 at 0x7d6b
(gdb) c
Continuing.
The target architecture is assumed to be i386
=&gt; 0x7d6b:	call   *0x10018

Breakpoint 1, 0x00007d6b in ?? ()
(gdb) x/8x 0x0010000
0x10000:	0x464c457f	0x00010101	0x00000000	0x00000000
0x10010:	0x00030002	0x00000001	0x0010000c	0x00000034
</code></pre></div></div>
<p>å¯ä»¥çœ‹åˆ° 0x0010000 ä¸­å·²ç»æœ‰æ•°æ®äº†.<br />
è¿™é‡Œç¨‹åºæ‰§è¡Œåˆ°äº† <code class="language-plaintext highlighter-rouge">call *0x10018</code> çš„ä½ç½®, å†æ‰§è¡Œä¸€æ¬¡ <code class="language-plaintext highlighter-rouge">si</code>, ç¨‹åºè·³è½¬åˆ°äº† 0x10000c çš„ä½ç½®, æŸ¥çœ‹äº†ä¸€ä¸‹ 0x10018 å†…å­˜ä¸­çš„ä¸€ä¸ªå­—, å‘ç°é‡Œé¢ç¡®å®å­˜å‚¨çš„æ˜¯ 0x0010000c, è¿™å°±ä¸æ˜¯é—®é¢˜äº†.</p>

<p>è¿™é‡Œæˆ‘ä»¬å¯ä»¥æ–­è¨€, 0x0010000c æ˜¯ kernel çš„å…¥å£ä»£ç åœ°å€. ä¸¤æ¬¡æ‰“å°ç»“æœä¸åŒæ˜¯å› ä¸º kernel åœ¨ä¹‹åè¢«åŠ è½½è¿›äº†å†…å­˜ä¸­.</p>

<p>å‚è€ƒå”çš„æ–‡ç« , è¿™é‡Œæˆ‘ä»¬è¿˜å‘ç°äº†ä¸€ä¸ªé—®é¢˜:</p>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>(gdb) x/10i 0x100000
   0x100000:	add    0x1bad(%eax),%dh
   0x100006:	add    %al,(%eax)
   0x100008:	decb   0x52(%edi)
   0x10000b:	in     $0x66,%al
   0x10000d:	movl   $0xb81234,0x472
   0x100017:	add    %dl,(%ecx)
   0x100019:	add    %cl,(%edi)
   0x10001b:	and    %al,%bl
   0x10001d:	mov    %cr0,%eax
   0x100020:	or     $0x80010001,%eax
</code></pre></div></div>
<p>è¿™é‡Œæˆ‘ä»¬å‘ç°, æ˜¾ç¤º 0x100000 åé¢çš„æŒ‡ä»¤, å¹¶æ²¡æœ‰å‡ºç° 0x10000c åœ°å€å¤„çš„æŒ‡ä»¤, è¿™æ˜¾ç„¶æ˜¯æœ‰é—®é¢˜çš„. æˆ‘ä»¬æ¢ä¸€ä¸ªæ–¹å¼:</p>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>(gdb) x/5i 0x10000c
=&gt; 0x10000c:	movw   $0x1234,0x472
   0x100015:	mov    $0x110000,%eax
   0x10001a:	mov    %eax,%cr3
   0x10001d:	mov    %cr0,%eax
   0x100020:	or     $0x80010001,%eax
</code></pre></div></div>
<p>æ¥ç€æˆ‘ä»¬å»å…³æ³¨ä¸€ä¸‹ kernel ç¼–è¯‘çš„æ±‡ç¼–æ–‡ä»¶ <code class="language-plaintext highlighter-rouge">obj/kern/kernel.asm</code>:</p>
<pre><code class="language-asm">f0100000:       02 b0 ad 1b 00 00       add    0x1bad(%eax),%dh
f0100006:       00 00                   add    %al,(%eax)
f0100008:       fe 4f 52                decb   0x52(%edi)
f010000b:       e4                      .byte 0xe4

f010000c &lt;entry&gt;:
f010000c:       66 c7 05 72 04 00 00    movw   $0x1234,0x472
f0100013:       34 12
        # sufficient until we set up our real page table in mem_init
        # in lab 2.

        # Load the physical address of entry_pgdir into cr3.  entry_pgdir
        # is defined in entrypgdir.c.
        movl    $(RELOC(entry_pgdir)), %eax
f0100015:       b8 00 00 11 00          mov    $0x110000,%eax
        movl    %eax, %cr3
f010001a:       0f 22 d8                mov    %eax,%cr3
        # Turn on paging.
        movl    %cr0, %eax
f010001d:       0f 20 c0                mov    %cr0,%eax
        orl     $(CR0_PE|CR0_PG|CR0_WP), %eax
</code></pre>
<p>0xf010000b å¤„çš„ <code class="language-plaintext highlighter-rouge">e4</code> ç¼–ç è¢« gdb é”™è¯¯çš„è§£é‡Šäº†. æ‰€ä»¥æ‰ä¼šé‡åˆ°åˆšæ‰çš„é—®é¢˜.</p>

<h2 id="exercise-7">Exercise 7</h2>
<blockquote>
  <p><strong>Exercise 7.</strong> Use QEMU and GDB to trace into the JOS kernel and stop at the <code class="language-plaintext highlighter-rouge">movl %eax, %cr0</code>. Examine memory at 0x00100000 and at 0xf0100000. Now, single step over that instruction using the <code class="language-plaintext highlighter-rouge">stepi</code> GDB command. Again, examine memory at 0x00100000 and at 0xf0100000. Make sure you understand what just happened.</p>

  <p>What is the first instruction <em>after</em> the new mapping is established that would fail to work properly if the mapping werenâ€™t in place? Comment out the <code class="language-plaintext highlighter-rouge">movl %eax, %cr0</code> in <code class="language-plaintext highlighter-rouge">kern/entry.S</code>, trace into it, and see if you were right.</p>
</blockquote>

<p>æˆ‘å…ˆå°†æ–­ç‚¹æ‰“åœ¨äº† 0x7c00 çš„ä½ç½®, ç„¶åç”¨ <code class="language-plaintext highlighter-rouge">x/50</code> å»æ‰¾ <code class="language-plaintext highlighter-rouge">ELFHDR-&gt;e_entry()</code> çš„è°ƒç”¨ä½ç½®, ç»“æœç¡¬æ˜¯çœ¼çæ²¡æ‰¾åˆ°. å°±å‚è€ƒäº† Exercise 6 çš„ç»“æœ, å°†æ–­ç‚¹æ‰“åœ¨äº† *0x7d6b çš„ä½ç½®, ç„¶ååŠ è½½ kernel. é€æ­¥è°ƒè¯•å, é”å®šåˆ°äº†é¢˜ä¸­ç¤ºæ„çš„æŒ‡ä»¤:</p>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>=&gt; 0x100025:	mov    %eax,%cr0
</code></pre></div></div>
<p>æ¥ç€æˆ‘ä»¬æ£€éªŒä¸€ä¸‹é¢˜ä¸­ç¤ºæ„çš„å†…å­˜(å¤šå¤åˆ¶äº†ä¸€æ®µæ–¹ä¾¿å’Œç¬¬äºŒæ®µçš„ä»£ç æ¯”è¾ƒ):</p>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>(gdb) si
=&gt; 0x100020:	or     $0x80010001,%eax
0x00100020 in ?? ()
(gdb) si
=&gt; 0x100025:	mov    %eax,%cr0
0x00100025 in ?? ()
(gdb) x/8x 0x00100000
0x100000:	0x1badb002	0x00000000	0xe4524ffe	0x7205c766
0x100010:	0x34000004	0x0000b812	0x220f0011	0xc0200fd8
(gdb) x/8x 0xf0100000
0xf0100000 &lt;_start+4026531828&gt;:	0x00000000	0x00000000	0x00000000	0x00000000
0xf0100010 &lt;entry+4&gt;:	0x00000000	0x00000000	0x00000000	0x00000000
</code></pre></div></div>
<p>ç„¶åå•æ­¥è°ƒè¯•åå†æ¬¡æ£€æŸ¥:</p>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>(gdb) si
=&gt; 0x100028:	mov    $0xf010002f,%eax
0x00100028 in ?? ()
(gdb) x/8x 0x00100000
0x100000:	0x1badb002	0x00000000	0xe4524ffe	0x7205c766
0x100010:	0x34000004	0x0000b812	0x220f0011	0xc0200fd8
(gdb) x/8x 0xf0100000
0xf0100000 &lt;_start+4026531828&gt;:	0x1badb002	0x00000000	0xe4524ffe	0x7205c766
0xf0100010 &lt;entry+4&gt;:	0x34000004	0x0000b812	0x220f0011	0xc0200fd8
</code></pre></div></div>
<p>è¿™é‡Œå®Œæˆäº†å°†ç«‹å³æ•° 0xf010002f èµ‹å€¼ç»™å¯„å­˜å™¨ EAX, è™½ç„¶ 0xf010002f å’Œ 0xf0100000 å¾ˆæ¥è¿‘, ä½†æ˜¯è¿˜æ˜¯ä¸è½»æ˜“çŒœæµ‹å®ƒçš„ç”¨é€”å§.</p>

<p>ç„¶åæˆ‘ä»¬å®Œæˆé—®é¢˜çš„ç¬¬äºŒéƒ¨åˆ†, æ³¨é‡Šæ‰è¿™ä¸ª <code class="language-plaintext highlighter-rouge">movl %eax, %cr0</code> in <code class="language-plaintext highlighter-rouge">kern/entry.S</code> ä¼šæ€ä¹ˆæ ·.<br />
ä¾æ—§ä½¿ç”¨ <code class="language-plaintext highlighter-rouge">git</code> å»ºä¸€ä¸ªæ–°åˆ†æ”¯ç„¶åå†æ”¹ä»£ç .</p>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>(gdb) si
=&gt; 0x100020:	or     $0x80010001,%eax
0x00100020 in ?? ()
(gdb) si
=&gt; 0x100025:	mov    $0xf010002c,%eax
0x00100025 in ?? ()
(gdb) x/8x 0x00100000
0x100000:	0x1badb002	0x00000000	0xe4524ffe	0x7205c766
0x100010:	0x34000004	0x0000b812	0x220f0011	0xc0200fd8
(gdb) x/8x 0xf0100000
0xf0100000 &lt;_start+4026531828&gt;:	0x00000000	0x00000000	0x00000000	0x00000000
0xf0100010 &lt;entry+4&gt;:	0x00000000	0x00000000	0x00000000	0x00000000
</code></pre></div></div>
<p>å›åˆ° lab1 åˆ†æ”¯, <code class="language-plaintext highlighter-rouge">make clean</code> ä¸€ä¸‹, è¿™ä¸ª Exercise å°±ç®—ç»“æŸäº†.
ä¸è¿‡è¿™é‡Œè¿˜æœ‰é—®é¢˜æ²¡æœ‰è§£å†³, CR0 é‡Œåˆ°åº•è¢«å¡äº†ä¸€ä¸ªä»€ä¹ˆä¸œè¥¿è¿›å». æˆ‘ä»¬å†å›å¤´æ¥çœ‹ä¸€ä¸‹ 0x100025 å‰é¢çš„ä»£ç :</p>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>(gdb) si
=&gt; 0x10001d:	mov    %cr0,%eax
0x0010001d in ?? ()
(gdb) si
=&gt; 0x100020:	or     $0x80010001,%eax
0x00100020 in ?? ()
(gdb) si
=&gt; 0x100025:	mov    %eax,%cr0
0x00100025 in ?? ()
</code></pre></div></div>
<p>åœ¨è¿™ä¹‹å‰å…ˆæŠŠ CR0 çš„å€¼å–åˆ° EAX, ç„¶åç”¨å¸¸æ•°è·Ÿ EAX åšæˆ–è¿ç®—, å†æ”¾å› CR0. è¿™æ˜¯æˆ‘ä»¬åœ¨ Exercise 2 ä¸­å°±å·²ç»é‡åˆ°çš„å¯¹ CR0 åšçš„æ©ç æ“ä½œ. æ—©åœ¨ Exercise 2 çš„å†…å®¹ä¸­å°±æèµ·è¿‡, CR0 çš„ bit0 ç½®ä½è¡¨ç¤ºä¿æŠ¤æ¨¡å¼å¼€å¯. ä»å”çš„æ–‡ç« é‡Œç›—äº†ä¸€å¼ è¡¨æ¥äº†:</p>

<table>
  <thead>
    <tr>
      <th>bit</th>
      <th>label</th>
      <th>descrption</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td>0</td>
      <td>Pe</td>
      <td>Protected mode enable</td>
    </tr>
    <tr>
      <td>1</td>
      <td>Mp</td>
      <td>Monitor co-processor</td>
    </tr>
    <tr>
      <td>2</td>
      <td>Em</td>
      <td>Emulation</td>
    </tr>
    <tr>
      <td>3</td>
      <td>Ts</td>
      <td>Task switched</td>
    </tr>
    <tr>
      <td>4</td>
      <td>Et</td>
      <td>extension type</td>
    </tr>
    <tr>
      <td>5</td>
      <td>Ne</td>
      <td>Numeric error</td>
    </tr>
    <tr>
      <td>16</td>
      <td>Wp</td>
      <td>write protect</td>
    </tr>
    <tr>
      <td>18</td>
      <td>Am</td>
      <td>alignment mask</td>
    </tr>
    <tr>
      <td>29</td>
      <td>Nw</td>
      <td>Not-write through</td>
    </tr>
    <tr>
      <td>30</td>
      <td>Cd</td>
      <td>cache disable</td>
    </tr>
    <tr>
      <td>31</td>
      <td>Pg</td>
      <td>paging</td>
    </tr>
  </tbody>
</table>

<p>æ¥ç€æˆ‘ä»¬æ¨ä¸€ä¸‹, è¿™ä¸ªæ©ç æ“ä½œçš„ç›®çš„æ˜¯: æ‰“å¼€ä¿æŠ¤æ¨¡å¼, å¼€å¯å†™ä¿æŠ¤, æ‰“å¼€ Paging. è¿™æ—¶å€™è®©æˆ‘æƒ³åˆ°åœ¨ <code class="language-plaintext highlighter-rouge">kern/entry.S</code> çš„è¿™ä¸‰æ¡æŒ‡ä»¤ä¸Šé¢æœ‰ä¸ª <code class="language-plaintext highlighter-rouge">Turn on paging.</code> çš„æ³¨é‡Š. å‚è€ƒå”çš„æ–‡ç« , pagingæ˜¯åˆ†é¡µå…è®¸ä½, ä»–è¡¨ç¤ºèŠ¯ç‰‡ä¸Šçš„åˆ†é¡µéƒ¨ä»¶æ˜¯å¦å…è®¸å·¥ä½œ. ä¸‹é¢è¿™æ®µæ˜¯ä»–æ‘˜è‡ª Wikipediaçš„:</p>
<blockquote>
  <p>Paging is a system which allows each process to see a full virtual address space, without actually requiring the full amount of physical memory to be available or present. In fact, current implementations of x86-64 have a limit of between 4 GiB and 256 TiB of physical address space (and an architectural limit of 4 PiB of physical address space).</p>
</blockquote>

<p>æŒ‰ç»´åŸºç™¾ç§‘ä¸Šé¢è¯´çš„, Paging æ˜¯ä¸€ä¸ªä½¿å®Œæ•´è™šæ‹Ÿåœ°å€å¯è§çš„ç³»ç»Ÿ, å¹¶ä¸”ä¸éœ€è¦å®Œå…¨æ•°é‡çš„ç‰©ç†åœ°å€æ˜ å°„. è¿™æ ·æˆ‘ä»¬æ‰èƒ½å®Œæˆä¸Šé¢çš„ 4MB çš„æ˜ å°„.</p>

<h2 id="exercise-8">Exercise 8</h2>
<blockquote>
  <p><strong>Exercise 8.</strong> We have omitted a small fragment of code - the code necessary to print octal numbers using patterns of the form â€œ%oâ€. Find and fill in this code fragment.
Be able to answer the following questions:</p>
</blockquote>

<p>è¿™é¢˜å«æˆ‘ä»¬å»è‡ªå·±å†™ä¸€æ®µæ ¼å¼åŒ–è¾“å‡ºçš„ä¸€æ®µä»£ç : å…³äº <code class="language-plaintext highlighter-rouge">%o</code> æ ¼å¼çš„. <br />
åˆ° <code class="language-plaintext highlighter-rouge">lib/printfmt.c</code> é‡Œ, æ‰¾åˆ° L206 å…³äºå…«è¿›åˆ¶è¾“å‡ºçš„ä»£ç . æ¨¡ä»¿ä¸€ä¸‹ <code class="language-plaintext highlighter-rouge">%x</code> çš„, æ”¹æˆä¸‹é¢è¿™æ®µ:</p>
<div class="language-c highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">case</span> <span class="sc">'o'</span><span class="p">:</span>
    <span class="n">num</span> <span class="o">=</span> <span class="n">getint</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ap</span><span class="p">,</span> <span class="n">lflag</span><span class="p">);</span>
    <span class="n">base</span> <span class="o">=</span> <span class="mi">8</span><span class="p">;</span>
    <span class="k">goto</span> <span class="n">number</span><span class="p">;</span>
    <span class="k">break</span><span class="p">;</span>
</code></pre></div></div>
<p>ç„¶åæ‰“ä¸€ä¸ª commit.</p>

<h2 id="exercise-9">Exercise 9</h2>
<blockquote>
  <p><strong>Exercise 9.</strong> Determine where the kernel initializes its stack, and exactly where in memory its stack is located. How does the kernel reserve space for its stack? And at which â€œendâ€ of this reserved area is the stack pointer initialized to point to?</p>
</blockquote>

<p>è¿™ä¸ª Exercise æ²¡æœ‰ç»™ä»»ä½•æç¤º, å†…å®¹ä¹Ÿæ¯”è¾ƒå¤š.<br />
æˆ‘ä»¬é€šè¿‡æŸ¥çœ‹ <code class="language-plaintext highlighter-rouge">obj/kern/kernel.asm</code> é‡Œçš„æ³¨é‡Š, å¯ä»¥å‘ç°è¿™ä¹ˆä¸€æ®µ:</p>
<pre><code class="language-asm">relocated:

        # Clear the frame pointer register (EBP)
        # so that once we get into debugging C code,
        # stack backtraces will be terminated properly.
        movl    $0x0,%ebp                       # nuke frame pointer
f010002f:       bd 00 00 00 00          mov    $0x0,%ebp

        # Set the stack pointer
        movl    $(bootstacktop),%esp
f0100034:       bc 00 00 11 f0          mov    $0xf0110000,%esp
</code></pre>
<p>ä»è¿™é‡Œæˆ‘ä»¬å¯ä»¥çœ‹åˆ°, æ ˆæ˜¯è¢« locate åœ¨äº†è™šæ‹Ÿå†…å­˜ 0xf0110000 çš„ä½ç½®, å³ç‰©ç†åœ°å€çš„ 0x00110000 çš„ä½ç½®. ç”±äº 0xf0100000 æ˜¯ entry çš„ä½ç½®, æ‰€ä»¥ç›¸å½“äºæ ˆçš„å¯ç”¨èŒƒå›´æ˜¯ 0xf0110000~0xf0100001 (æ ˆå¢æ–¹å‘, åœ°å€å‡æ–¹å‘). ä¹Ÿå°±æ˜¯ $2^{20}$ ä¸ªå­—èŠ‚å•¦.(ä½†æ˜¯åé¢çš„å†…å®¹è¯æ˜è¿™é‡Œçš„è¯´æ³•å¹¶ä¸æ­£ç¡®)</p>

<p>å…³äºå†…æ ¸æ˜¯æ€ä¹ˆä¿ç•™è¿™äº›ç©ºé—´çš„, ç­”æ¡ˆå…¶å®æ˜¯æˆ‘ä»¬éƒ½çŸ¥é“çš„, æ ˆé¡¶æ”¾åœ¨é«˜åœ°å€ä½ç½®, æ ˆåº•å¾€ä½åœ°å€æ–¹å‘å¢é•¿.(è¿™ä¸ªå¥½åƒè·Ÿæˆ‘è®¤çŸ¥çš„æ ˆç»“æ„æ˜¯åçš„) ä¸‹é¢æ˜¯å…·ä½“çš„, ä»æºç åæ˜ å‡ºæ¥çš„å†…å®¹.</p>

<p>æˆ‘ä»¬éœ€è¦å»æ‰¾ä¸€ä¸‹ <code class="language-plaintext highlighter-rouge">bootstacktop</code> çš„å®šä¹‰. åœ¨ <code class="language-plaintext highlighter-rouge">kernel.asm</code> çš„æºä»£ç  <code class="language-plaintext highlighter-rouge">kern/entry.S</code> ä¸­, æœ‰å®šä¹‰åœ¨ <code class="language-plaintext highlighter-rouge">.data</code> æ®µçš„å†…å®¹:</p>
<pre><code class="language-asm">.data
###################################################################
# boot stack
###################################################################
        .p2align        PGSHIFT         # force page alignment
        .globl          bootstack
bootstack:
        .space          KSTKSIZE
        .globl          bootstacktop
bootstacktop:
</code></pre>
<p>æˆ‘ä»¬çœ‹åˆ°æ ˆåŒºåŸŸæ˜¯è¢«æ•°æ®æ®µä¿å­˜äº†.<br />
ä¸è¿‡è¿™é‡Œåˆå‡ºç°äº†ä¸¤ä¸ªæ–°çš„å¸¸é‡(?), <code class="language-plaintext highlighter-rouge">PGSHIFT</code> å’Œ <code class="language-plaintext highlighter-rouge">KSTKSIZE</code>. æ ¹æ®è¿™ä¸ªæ–‡ä»¶ä¸Šé¢çš„ <code class="language-plaintext highlighter-rouge">#include</code>, é¡ºè—¤æ‘¸ç“œå¯ä»¥æ‰¾åˆ° <code class="language-plaintext highlighter-rouge">inc/memlayout.h</code> ä¸­çš„å®å®šä¹‰:</p>
<div class="language-c highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">// Kernel stack.</span>
<span class="cp">#define KSTACKTOP       KERNBASE
#define KSTKSIZE        (8*PGSIZE)              // size of a kernel stack
#define KSTKGAP         (8*PGSIZE)              // size of a kernel stack guard
</span></code></pre></div></div>
<p>ä»¥åŠ <code class="language-plaintext highlighter-rouge">inc/mmu.h</code> ä¸­çš„:</p>
<div class="language-c highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="cp">#define PGSIZE          4096            // bytes mapped by a page
#define PGSHIFT         12              // log2(PGSIZE)
</span></code></pre></div></div>
<p><code class="language-plaintext highlighter-rouge">PGSIZE</code> æ˜¯é¡µå¤§å°, <code class="language-plaintext highlighter-rouge">PGSHIFT</code> å–å…¶å¯¹æ•°è‡ªç„¶å°±æ˜¯å¯¹åº”çš„å·¦ç§»é‡(è‹±æ–‡æœ¬èº«ä¹Ÿå°±æ˜¯ shift).<br />
<code class="language-plaintext highlighter-rouge">KSTKSIZE</code> å³ä¸ºæ ˆçš„å¤§å°äº†. æ˜¯ $8\times 4096=2^{15}$ ä¸ªå­—èŠ‚. <code class="language-plaintext highlighter-rouge">KSTKGAP</code> çœ‹æ³¨é‡Šåº”è¯¥æ˜¯å®ˆæŠ¤æ ˆåŒºåŸŸçš„ä¸€ä¸ªä»€ä¹ˆå¸¸æ•°, æ‰€ä»¥è·Ÿæ ˆå¤§å°ç›¸åŒ. 
<code class="language-plaintext highlighter-rouge">KSTACKTOP</code> è¢«å®šä¹‰æˆäº† <code class="language-plaintext highlighter-rouge">KERNBASE</code>, æˆ‘ä»¬å›åˆ° <code class="language-plaintext highlighter-rouge">memlayout.h</code>:</p>
<div class="language-c highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">// All physical memory mapped at this address</span>
<span class="cp">#define KERNBASE        0xF0000000
</span></code></pre></div></div>

<p>æ‰€ä»¥ä¸‹é¢æ¥æ­£å¼å›ç­”ä¸€ä¸‹è¿™ä¸ª Exercise çš„é—®é¢˜:</p>
<ol>
  <li>æ ˆåœ¨ <code class="language-plaintext highlighter-rouge">kern/entry.S</code> ä¸­è¢«åˆå§‹åŒ–, åœ¨æ ˆé¡¶åœ¨å®é™…ç‰©ç†å†…å­˜çš„ 0x00110000.</li>
  <li>å†…æ ¸ä¸ºäº†ä¿å­˜è¿™æ®µåŒºåŸŸ, å°†å®ƒæ”¾åœ¨äº† <code class="language-plaintext highlighter-rouge">.data</code> æ®µä¸­, åˆ†é…äº† 8 ä¸ªé¡µè¡¨çš„ç©ºé—´.</li>
  <li>è¿™ 8 ä¸ªé¡µè¡¨çš„åŒºåŸŸä¸ºç‰©ç†åœ°å€çš„ 0x00108000~0x00110000. æ‰€è°“çš„ the â€œendâ€ of this reserved area, åº”è¯¥å°±æ˜¯ 0x00108000.</li>
</ol>

<h2 id="exercise-10">Exercise 10</h2>
<blockquote>
  <p><strong>Exercise 10.</strong> To become familiar with the C calling conventions on the x86, find the address of the <code class="language-plaintext highlighter-rouge">test_backtrace</code> function in <code class="language-plaintext highlighter-rouge">obj/kern/kernel.asm</code>, set a breakpoint there, and examine what happens each time it gets called after the kernel starts. How many 32-bit words does each recursive nesting level of <code class="language-plaintext highlighter-rouge">test_backtrace</code> push on the stack, and what are those words?</p>

  <p>Note that, for this exercise to work properly, you should be using the patched version of QEMU available on the <a href="https://pdos.csail.mit.edu/6.828/2018/tools.html">tools</a> page or on Athena. Otherwise, youâ€™ll have to manually translate all breakpoint and memory addresses to linear addresses.</p>
</blockquote>

<p>åœ¨ <code class="language-plaintext highlighter-rouge">obj/kern/kernel.asm</code> ä¸­æ‰¾åˆ°:</p>
<pre><code class="language-asm">f0100040 &lt;test_backtrace&gt;:
#include &lt;kern/console.h&gt;

// Test the stack backtrace function (lab 1 only)
void
test_backtrace(int x)
{
f0100040:       55                      push   %ebp
f0100041:       89 e5                   mov    %esp,%ebp
</code></pre>
<p>å¯ä»¥çœ‹åˆ° <code class="language-plaintext highlighter-rouge">test_backtrace</code> çš„åœ°å€åœ¨ 0xf0100040. åœ¨æ–­ç‚¹è°ƒè¯•ä¹‹å‰å…ˆçœ‹ä¸€ä¸‹ <code class="language-plaintext highlighter-rouge">test_backtrace()</code> å‡½æ•°çš„.<br />
<code class="language-plaintext highlighter-rouge">kern/init.c</code>:</p>
<div class="language-c highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">// Test the stack backtrace function (lab 1 only)</span>
<span class="kt">void</span>
<span class="nf">test_backtrace</span><span class="p">(</span><span class="kt">int</span> <span class="n">x</span><span class="p">)</span>
<span class="p">{</span>
        <span class="n">cprintf</span><span class="p">(</span><span class="s">"entering test_backtrace %d</span><span class="se">\n</span><span class="s">"</span><span class="p">,</span> <span class="n">x</span><span class="p">);</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">x</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span>
                <span class="n">test_backtrace</span><span class="p">(</span><span class="n">x</span><span class="o">-</span><span class="mi">1</span><span class="p">);</span>
        <span class="k">else</span>
                <span class="n">mon_backtrace</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
        <span class="n">cprintf</span><span class="p">(</span><span class="s">"leaving test_backtrace %d</span><span class="se">\n</span><span class="s">"</span><span class="p">,</span> <span class="n">x</span><span class="p">);</span>
<span class="p">}</span>
</code></pre></div></div>
<p><code class="language-plaintext highlighter-rouge">kern/monitor.c</code>:</p>
<div class="language-c highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kt">int</span>
<span class="nf">mon_backtrace</span><span class="p">(</span><span class="kt">int</span> <span class="n">argc</span><span class="p">,</span> <span class="kt">char</span> <span class="o">**</span><span class="n">argv</span><span class="p">,</span> <span class="k">struct</span> <span class="n">Trapframe</span> <span class="o">*</span><span class="n">tf</span><span class="p">)</span>
<span class="p">{</span>
        <span class="c1">// Your code here.</span>
        <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></div></div>
<p><em>è¿™ä¸ªåº”è¯¥å°±æ˜¯ lab1 æœ€åå¤§é¢˜äº†å§.</em><br />
å¼€å§‹è°ƒè¯•.</p>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>(gdb) c
Continuing.
The target architecture is assumed to be i386
=&gt; 0xf0100040 &lt;test_backtrace&gt;:	push   %ebp

Breakpoint 1, test_backtrace (x=5) at kern/init.c:13
13	{
</code></pre></div></div>
<p>è°ƒç”¨ <code class="language-plaintext highlighter-rouge">test_backtrace</code> å‡½æ•°, åˆå§‹å‚æ•°ä¸º <code class="language-plaintext highlighter-rouge">5</code>.(è¿™ä¸ªè°ƒç”¨æˆ‘çœ‹äº†ä¸€ä¸‹æ˜¯åœ¨ <code class="language-plaintext highlighter-rouge">i386_init()</code> é‡Œé¢) <br />
è¿™é‡Œæˆ‘ä»¬å…ˆçœ‹ä¸€ä¸‹ esp çš„å€¼(ebp ç”±äºä¸€ç›´éƒ½æ˜¯ esp çš„ä¸€ä¸ªå¿«ç…§åº”è¯¥æ˜¯ä¸ç”¨å…³æ³¨çš„):</p>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>(gdb) x/2d $esp
0xf010ffdc:	-267386668	5
</code></pre></div></div>
<p>å‰é¢ä¸€ä¸ªæ•°æ˜¯å‡½æ•°çš„è¿”å›åœ°å€, ç¬¬äºŒä¸ªå°±æ˜¯ <code class="language-plaintext highlighter-rouge">test_backtrace</code> çš„ç¬¬ä¸€å‚æ•°. <br />
æ­¤æ—¶çš„ <code class="language-plaintext highlighter-rouge">$esp = 0xf010ffdc</code>.</p>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>(gdb) x/5i 0xf0100040
   0xf0100040 &lt;test_backtrace&gt;:	  push   %ebp
   0xf0100041 &lt;test_backtrace+1&gt;:	mov    %esp,%ebp
   0xf0100043 &lt;test_backtrace+3&gt;:	push   %ebx
   0xf0100044 &lt;test_backtrace+4&gt;:	sub    $0xc,%esp
=&gt; 0xf0100047 &lt;test_backtrace+7&gt;:	mov    0x8(%ebp),%ebx
</code></pre></div></div>
<p>æˆ‘ä»¬æ‰“å°äº† <code class="language-plaintext highlighter-rouge">test_backtrace</code> è°ƒç”¨åçš„ 5 è¡Œ prologue code éƒ¨åˆ†. è¿™é‡Œèƒ½çœ‹åˆ°æ ˆå‘ç”Ÿäº†ä¸€äº›å˜åŒ–. å…ˆå±•ç¤ºä¸€ä¸‹ esp ç°åœ¨çš„å€¼:</p>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>(gdb) x/x $esp
0xf010ffc8:	0x00
</code></pre></div></div>
<p>æ¥ç»Ÿè®¡ä¸€ä¸‹è¿™é‡Œæ ˆåšçš„å˜åŒ–: ä¿å­˜ ebp å…¥æ ˆ -4, ä¿å­˜ ebx å…¥æ ˆ -4, <code class="language-plaintext highlighter-rouge">sub</code> æ‰§è¡Œ -12, åˆè®¡ 0x14(20) ä¸ªå­—èŠ‚. å‡å» 12 çš„æ„ä¹‰æš‚æ—¶ä¸æ˜. æ£€æŸ¥ä¸€ä¸‹ <code class="language-plaintext highlighter-rouge">obj/kern/kernel.asm</code> ä¸­å¯ä»¥çœ‹åˆ°è¿™ä¸€æ®µæ˜¯æ‰€æœ‰ <code class="language-plaintext highlighter-rouge">test_backtrace</code> çš„å…±æœ‰éƒ¨åˆ†. æ ¹æ® C è¯­è¨€ä¸€äº›åŸºç¡€çŸ¥è¯†å¯ä»¥åˆ¤æ–­, <code class="language-plaintext highlighter-rouge">test_backtrace</code> è°ƒç”¨å…­æ¬¡åº”è¯¥ä¼šå ç”¨æ‰æ ˆçš„ 6*(20+4+4)=168 ä¸ªå­—èŠ‚. (è¿™é‡Œç¬¬ä¸€ä¸ªåŠ  4 æ˜¯è¦åŒ…å« <code class="language-plaintext highlighter-rouge">test_backtrace</code> æ¯æ¬¡è°ƒç”¨çš„å‚æ•°, ç¬¬äºŒä¸ªåŠ  4 æ˜¯æ¯ä¸€æ¬¡è°ƒç”¨çš„è¿”å›åœ°å€)</p>

<p>æˆ‘ä»¬åœ¨æœ€åä¸€æ¬¡è°ƒç”¨è¿”å›ä¹‹å‰, è¾“å‡ºäº†ä¸€ä¸‹ esp å¾€åçš„å†…å®¹, ä¸€ç›´åˆ°æœ€æ—©çš„ 0xf010ffdc + 0x4 = 0xf010ffe0 ä½ç½®çš„åˆå§‹å‚æ•° 5.</p>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>(gdb) x/49d $esp
0xf010ff20:	-267380548	0	0	0
0xf010ff30:	-267384641	1	-267321512	-267386776
0xf010ff40:	0	1	-267321480	0
0xf010ff50:	-267384641	2	-267321480	-267386776
0xf010ff60:	1	2	-267321448	0
0xf010ff70:	-267384641	3	-267321448	-267386776
0xf010ff80:	2	3	-267321416	0
0xf010ff90:	-267384641	4	-267321416	-267386776
0xf010ffa0:	3	4	0	0
0xf010ffb0:	0	5	-267321384	-267386776
0xf010ffc0:	4	5	0	65684
0xf010ffd0:	65684	65684	-267321352	-267386668
0xf010ffe0:	5
</code></pre></div></div>
<p>å‰åç›¸å·® 192. 
emmmmâ€¦ å¥½åƒè¶Šç»•è¶Šå¤æ‚äº†, æˆ‘ä»¬ç¨å¾®æŠŠå·²çŸ¥çš„ä¿¡æ¯ç†æ¸…ä¸€ä¸‹(cnt ä¸ºæ ˆåç§»å­—èŠ‚è®¡æ•°å™¨):</p>
<ol>
  <li><code class="language-plaintext highlighter-rouge">test_backtrace(5)</code> åœ¨<code class="language-plaintext highlighter-rouge">i386_init()</code> ä¸­è¢«è°ƒç”¨é˜¶æ®µ. å‚æ•°å…¥æ ˆ, è¿”å›åœ°å€å…¥æ ˆ, cnt = 0 + 8 = 8.</li>
  <li><code class="language-plaintext highlighter-rouge">test_backtrace(5)</code> çš„ prologue code é˜¶æ®µ. ebp å…¥æ ˆ, ebx å…¥æ ˆ, esp å -12, cnt = 8 + 20 = 28.</li>
  <li>ç¬¬ä¸€ä¸ª <code class="language-plaintext highlighter-rouge">cprintf()</code> å’Œ <code class="language-plaintext highlighter-rouge">if</code> é˜¶æ®µ. <code class="language-plaintext highlighter-rouge">cprintf()</code> ä¸¤å‚æ•°å…¥æ ˆ, è¿”å›å esp å 16, cnt = 28 + 2*4 - 16 = 20.</li>
  <li><code class="language-plaintext highlighter-rouge">test_backtrace(n-1)</code> é€’å½’é¢„å¤‡é˜¶æ®µ. esp å 12, cnt = 20 + 12 = 32. è‡³æ­¤å¼€å§‹å¾ªç¯ 1, 2, 3, 4 çš„æ‰§è¡Œ.</li>
  <li>é€’å½’é‡å¤äº† 5 æ¬¡, cnt = cnt + cnt*5 = 192.</li>
  <li>æœ€é‡Œå±‚è°ƒç”¨ <code class="language-plaintext highlighter-rouge">else</code> ä¸­çš„ <code class="language-plaintext highlighter-rouge">mon_backtrace</code>, esp å -4, ä¸‰å‚æ•°å…¥æ ˆ, è¿”å›å esp å 16, cnt = 192 + 4 + 3*4 - 16 = 192</li>
  <li>æœ€é‡Œå±‚å¼€å§‹è°ƒç”¨ç¬¬äºŒä¸ª <code class="language-plaintext highlighter-rouge">cprintf</code>, esp å -8, ä¸¤å‚æ•°è¿›æ ˆ, è¿”å›å esp å 16, cnt = 192 + 8 + 2*4 - 16 = 192</li>
  <li>è¿™é‡Œå°±åˆ°äº†æœ€åæˆ‘å•æ­¥è°ƒè¯•åˆ°çš„ä½ç½®äº†.</li>
</ol>

<p>åæ­£ä¹Ÿä¸çŸ¥é“ä¸Šé¢å“ªé‡Œæ¼äº†, æ€»ä¹‹æœ€åæ˜¯å¯¹äº†. æ‰€ä»¥è¿™é¢˜çš„ç­”æ¡ˆåº”è¯¥æ˜¯, æ¯ä¸ªæ ˆ 32 ä¸ªå­—èŠ‚(ä¹Ÿå¯èƒ½è¯´æ˜¯ 20 ä¸ªå­—èŠ‚), ä¹Ÿå°±æ˜¯ 8 ä¸ª 32 ä½å­—. å…³äºé‡Œé¢æœ‰ä»€ä¹ˆ, ä¸Šé¢ä¹Ÿéƒ½è¯´çš„å¾ˆæ¸…æ¥šäº†, æœ‰ä¸€äº›æ˜¯ä¿ç•™çš„å¯„å­˜å™¨, ä¸€äº›æ˜¯ç©ºæ´. <br />
åè¯, å…³äºè¿™é‡Œä¸ºä»€ä¹ˆæ¯æ¬¡ä¼šæµªè´¹ 3+3 ä¸ªåŒå­—(24 ä¸ªå­—èŠ‚)çš„ç©ºé—´ä¸ä½¿ç”¨æˆ‘ä¹Ÿä¸æ˜¯å¾ˆæ¸…æ¥š. å¯èƒ½æ˜¯ä¸ºäº†å¯¹é½?(è¿·æƒ‘è¡Œä¸º)</p>

<h2 id="exercise-11">Exercise 11</h2>
<blockquote>
  <p><strong>Exercise 11.</strong> Implement the backtrace function as specified above. Use the same format as in the example, since otherwise the grading script will be confused. When you think you have it working right, run <code class="language-plaintext highlighter-rouge">make grade</code> to see if its output conforms to what our grading script expects, and fix it if it doesnâ€™t. After you have handed in your Lab 1 code, you are welcome to change the output format of the backtrace function any way you like.</p>

  <p>If you use <code class="language-plaintext highlighter-rouge">read_ebp()</code>, note that GCC may generate â€œoptimizedâ€ code that calls <code class="language-plaintext highlighter-rouge">read_ebp()</code> <em>before</em> <code class="language-plaintext highlighter-rouge">mon_backtrace()</code>â€™s function prologue, which results in an incomplete stack trace (the stack frame of the most recent function call is missing). While we have tried to disable optimizations that cause this reordering, you may want to examine the assembly of <code class="language-plaintext highlighter-rouge">mon_backtrace()</code> and make sure the call to <code class="language-plaintext highlighter-rouge">read_ebp()</code> is happening after the function prologue.</p>
</blockquote>

<p>åœ¨å†™ä»£ç ä¹‹å‰, è¿˜æ˜¯è¦çœ‹æ¸…é¢˜é¢ä¸­çš„æç¤º. å¦‚æœè¦ä½¿ç”¨ <code class="language-plaintext highlighter-rouge">read_ebp()</code>, æ³¨æ„ä¸€ä¸‹ GCC å¯èƒ½ä¼šç”Ÿæˆåœ¨ <code class="language-plaintext highlighter-rouge">mon_backtrace()</code> çš„ prologue code ä¹‹å‰çš„â€ä¼˜åŒ–â€ä»£ç . ç®€å•è¯´å°±æ˜¯ä½ ä¸çŸ¥é“ <code class="language-plaintext highlighter-rouge">read_ebp()</code> è¯»å–åˆ°çš„ ebp æ˜¯åœ¨ prologue code ä¿®æ”¹ä¹‹å‰è¿˜æ˜¯ä¹‹åçš„, è¿™ä¸ªç¨åæˆ‘ä»¬é€šè¿‡æ±‡ç¼–æ¥éªŒè¯.<br />
In <code class="language-plaintext highlighter-rouge">kern/monitor.c</code>:</p>
<div class="language-c highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kt">int</span>
<span class="nf">mon_backtrace</span><span class="p">(</span><span class="kt">int</span> <span class="n">argc</span><span class="p">,</span> <span class="kt">char</span> <span class="o">**</span><span class="n">argv</span><span class="p">,</span> <span class="k">struct</span> <span class="n">Trapframe</span> <span class="o">*</span><span class="n">tf</span><span class="p">)</span>
<span class="p">{</span>
        <span class="n">cprintf</span><span class="p">(</span><span class="s">"Stack backtrace:</span><span class="se">\n</span><span class="s">"</span><span class="p">);</span>
        <span class="kt">uint32_t</span> <span class="o">*</span><span class="n">ebp</span> <span class="o">=</span> <span class="p">(</span><span class="kt">uint32_t</span> <span class="o">*</span><span class="p">)</span><span class="n">read_ebp</span><span class="p">();</span>
        <span class="k">while</span> <span class="p">(</span><span class="n">ebp</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
                <span class="kt">uint32_t</span> <span class="n">eip</span> <span class="o">=</span> <span class="o">*</span><span class="p">(</span><span class="n">ebp</span> <span class="o">+</span> <span class="mi">1</span><span class="p">);</span>
                <span class="kt">uint32_t</span> <span class="o">*</span><span class="n">args</span> <span class="o">=</span> <span class="n">ebp</span> <span class="o">+</span> <span class="mi">2</span><span class="p">;</span>
                <span class="n">cprintf</span><span class="p">(</span><span class="s">"  ebp %08x  eip %08x  args"</span><span class="p">,</span> <span class="n">ebp</span><span class="p">,</span> <span class="n">eip</span><span class="p">);</span>
                <span class="k">for</span> <span class="p">(</span><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">4</span><span class="p">;</span> <span class="o">++</span><span class="n">i</span><span class="p">)</span> <span class="p">{</span>
                        <span class="n">cprintf</span><span class="p">(</span><span class="s">" %08x"</span><span class="p">,</span> <span class="o">*</span><span class="p">(</span><span class="n">args</span> <span class="o">+</span> <span class="n">i</span><span class="p">));</span>
                <span class="p">}</span>
                <span class="n">cprintf</span><span class="p">(</span><span class="s">"</span><span class="se">\n</span><span class="s">"</span><span class="p">);</span>
                <span class="n">ebp</span> <span class="o">=</span> <span class="p">(</span><span class="kt">uint32_t</span> <span class="o">*</span><span class="p">)(</span><span class="o">*</span><span class="n">ebp</span><span class="p">);</span>
        <span class="p">}</span>
        <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></div></div>

<h2 id="exercise-12">Exercise 12</h2>
<blockquote>
  <p><strong>Exercise 12.</strong> Modify your stack backtrace function to display, for each <code class="language-plaintext highlighter-rouge">eip</code>, the function name, source file name, and line number corresponding to that <code class="language-plaintext highlighter-rouge">eip</code>.</p>

  <p>In <code class="language-plaintext highlighter-rouge">debuginfo_eip</code>, where do <code class="language-plaintext highlighter-rouge">__STAB_*</code> come from? This question has a long answer; to help you to discover the answer, here are some things you might want to do:</p>

  <p>look in the file <code class="language-plaintext highlighter-rouge">kern/kernel.ld</code> for <code class="language-plaintext highlighter-rouge">__STAB_*</code><br />
run <code class="language-plaintext highlighter-rouge">objdump -h obj/kern/kernel</code><br />
run <code class="language-plaintext highlighter-rouge">objdump -G obj/kern/kernel</code><br />
run <code class="language-plaintext highlighter-rouge">gcc -pipe -nostdinc -O2 -fno-builtin -I. -MD -Wall -Wno-format -DJOS_KERNEL -gstabs -c -S kern/init.c</code>, and look at init.s.<br />
see if the bootloader loads the symbol table in memory as part of loading the kernel binary<br />
Complete the implementation of <code class="language-plaintext highlighter-rouge">debuginfo_eip</code> by inserting the call to <code class="language-plaintext highlighter-rouge">stab_binsearch</code> to find the line number for an address.</p>

  <p>Add a <code class="language-plaintext highlighter-rouge">backtrace</code> command to the kernel monitor, and extend your implementation of <code class="language-plaintext highlighter-rouge">mon_backtrace</code> to call <code class="language-plaintext highlighter-rouge">debuginfo_eip</code> and print a line for each stack frame of the form:</p>

  <div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>K&gt; backtrace  
Stack backtrace:  
  ebp f010ff78  eip f01008ae  args 00000001 f010ff8c 00000000 f0110580 00000000  
         kern/monitor.c:143: monitor+106  
  ebp f010ffd8  eip f0100193  args 00000000 00001aac 00000660 00000000 00000000  
         kern/init.c:49: i386_init+59  
  ebp f010fff8  eip f010003d  args 00000000 00000000 0000ffff 10cf9a00 0000ffff  
         kern/entry.S:70: &lt;unknown&gt;+0  
K&gt;   
</code></pre></div>  </div>

  <p>Each line gives the file name and line within that file of the stack frameâ€™s <code class="language-plaintext highlighter-rouge">eip</code>, followed by the name of the function and the offset of the <code class="language-plaintext highlighter-rouge">eip</code> from the first instruction of the function (e.g., <code class="language-plaintext highlighter-rouge">monitor+106</code> means the return <code class="language-plaintext highlighter-rouge">eip</code> is 106 bytes past the beginning of <code class="language-plaintext highlighter-rouge">monitor</code>).</p>

  <p>Be sure to print the file and function names on a separate line, to avoid confusing the grading script.</p>

  <p>Tip: printf format strings provide an easy, albeit obscure, way to print non-null-terminated strings like those in STABS tables. <code class="language-plaintext highlighter-rouge">printf("%.*s", length, string)</code> prints at most <code class="language-plaintext highlighter-rouge">length</code> characters of <code class="language-plaintext highlighter-rouge">string</code>. Take a look at the printf man page to find out why this works.</p>

  <p>You may find that some functions are missing from the backtrace. For example, you will probably see a call to <code class="language-plaintext highlighter-rouge">monitor()</code> but not to <code class="language-plaintext highlighter-rouge">runcmd()</code>. This is because the compiler in-lines some function calls. Other optimizations may cause you to see unexpected line numbers. If you get rid of the <code class="language-plaintext highlighter-rouge">-O2</code> from <code class="language-plaintext highlighter-rouge">GNUMakefile</code>, the backtraces may make more sense (but your kernel will run more slowly).</p>
</blockquote>

<p><em>æœ€åä¸€é“å‹è½´é¢˜äº†, é¢˜é¢å¤šåˆ°äººä¸æƒ³è¯».</em></p>

<p>é¦–å…ˆ, å¯¹äº <code class="language-plaintext highlighter-rouge">debuginfo_eip()</code> å‡½æ•°, å®ƒå‚æ•°ä¸­çš„ <code class="language-plaintext highlighter-rouge">__STAB_*</code> æ˜¯å“ªæ¥çš„, æ˜¯å¹²å˜›ç”¨çš„.<br />
æŸ¥çœ‹ä¸€ä¸‹ <code class="language-plaintext highlighter-rouge">kern/kernel.ld</code> æ–‡ä»¶:</p>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>/* Include debugging information in kernel memory */
.stab : {
        PROVIDE(__STAB_BEGIN__ = .);
        *(.stab);
        PROVIDE(__STAB_END__ = .);
        BYTE(0)         /* Force the linker to allocate space
                            for this section */
}

.stabstr : {
        PROVIDE(__STABSTR_BEGIN__ = .);
        *(.stabstr);
        PROVIDE(__STABSTR_END__ = .);
        BYTE(0)         /* Force the linker to allocate space
                            for this section */
}
</code></pre></div></div>
<p>è¿™é‡Œæœ‰æŒ‡ç¤º stab æ˜¯ kernel å†…å­˜ä¸­åŒ…å«è°ƒè¯•ä¿¡æ¯çš„åŒºåŸŸ.</p>

<p>å†æ‰§è¡Œä¸€ä¸‹å®ƒè¯´çš„å‡ ä¸ªæŒ‡ä»¤:</p>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>$ objdump -h obj/kern/kernel

obj/kern/kernel:     file format elf32-i386

Sections:
Idx Name          Size      VMA       LMA       File off  Algn
  0 .text         00001941  f0100000  00100000  00001000  2**4
                  CONTENTS, ALLOC, LOAD, READONLY, CODE
  1 .rodata       00000748  f0101960  00101960  00002960  2**5
                  CONTENTS, ALLOC, LOAD, READONLY, DATA
  2 .stab         00003a15  f01020a8  001020a8  000030a8  2**2
                  CONTENTS, ALLOC, LOAD, READONLY, DATA
  3 .stabstr      000018e6  f0105abd  00105abd  00006abd  2**0
                  CONTENTS, ALLOC, LOAD, READONLY, DATA
  4 .data         0000a300  f0108000  00108000  00009000  2**12
                  CONTENTS, ALLOC, LOAD, DATA
  5 .bss          00000648  f0112300  00112300  00013300  2**5
                  CONTENTS, ALLOC, LOAD, DATA
  6 .comment      00000035  00000000  00000000  00013948  2**0
                  CONTENTS, READONLY
</code></pre></div></div>
<p>è¿™é‡Œæœ‰çœ‹åˆ°ä¸€ä¸ª <code class="language-plaintext highlighter-rouge">.stab</code> æ®µå’Œ <code class="language-plaintext highlighter-rouge">.stabstr</code> æ®µ. <br />
å¯ä»¥ç®—å‡º <code class="language-plaintext highlighter-rouge">.stab</code> çš„åœ°å€æ˜¯ 0x00102068~0x00105abc, <code class="language-plaintext highlighter-rouge">.stabstr</code> çš„åœ°å€æ˜¯ 0x00105abd~0x00107fff. è¿™é‡Œç”¨ä¸åˆ°è®¡ç®—å™¨, å› ä¸ºè·Ÿå®ƒä»¬åé¢çš„æ®µéƒ½æ˜¯çº¿æ€§è¿æ¥èµ·æ¥çš„. <br />
æ³¨æ„è¿™ä¸ªåœ°å€æ¯æ¬¡é‡æ–°ç¼–è¯‘å¯èƒ½ä¼šå‘ç”Ÿå˜åŒ–, è¢«å‘äº†.</p>

<p>ç»§ç»­:</p>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>$ objdump -G obj/kern/kernel | more

obj/kern/kernel:     file format elf32-i386

Contents of .stab section:

Symnum n_type n_othr n_desc n_value  n_strx String

-1     HdrSym 0      1231   000018cd 1     
0      SO     0      0      f0100000 1      {standard input}
1      SOL    0      0      f010000c 18     kern/entry.S
2      SLINE  0      44     f010000c 0      
3      SLINE  0      57     f0100015 0      
4      SLINE  0      58     f010001a 0      
5      SLINE  0      60     f010001d 0      
6      SLINE  0      61     f0100020 0      
7      SLINE  0      62     f0100025 0      
8      SLINE  0      67     f0100028 0      
9      SLINE  0      68     f010002d 0      
10     SLINE  0      74     f010002f 0      
11     SLINE  0      77     f0100034 0      
12     SLINE  0      80     f0100039 0      
13     SLINE  0      83     f010003e 0      
14     SO     0      2      f0100040 31     kern/entrypgdir.c
15     OPT    0      0      00000000 49     gcc2_compiled.
16     LSYM   0      0      00000000 64     int:t(0,1)=r(0,1);-2147483648;2147483647;
17     LSYM   0      0      00000000 106    char:t(0,2)=r(0,2);0;127;
18     LSYM   0      0      00000000 132    long int:t(0,3)=r(0,3);-2147483648;2147483647;
19     LSYM   0      0      00000000 179    unsigned int:t(0,4)=r(0,4);0;4294967295;
20     LSYM   0      0      00000000 220    long unsigned int:t(0,5)=r(0,5);0;4294967295;
21     LSYM   0      0      00000000 266    __int128:t(0,6)=r(0,6);0;-1;
22     LSYM   0      0      00000000 295    __int128 unsigned:t(0,7)=r(0,7);0;-1;
23     LSYM   0      0      00000000 333    long long int:t(0,8)=r(0,8);-0;4294967295;
24     LSYM   0      0      00000000 376    long long unsigned int:t(0,9)=r(0,9);0;-1;
25     LSYM   0      0      00000000 419    short int:t(0,10)=r(0,10);-32768;32767;
26     LSYM   0      0      00000000 459    short unsigned int:t(0,11)=r(0,11);0;65535;
27     LSYM   0      0      00000000 503    signed char:t(0,12)=r(0,12);-128;127;
--More--
</code></pre></div></div>
<p>ä¹‹å‰å°±æœ‰æƒ³æŸ¥, ç»“æœå¿˜äº†, æˆ‘ä»¬åœ¨è¿™é‡Œ man ä¸€ä¸‹ <code class="language-plaintext highlighter-rouge">objdump</code>:</p>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>OBJDUMP(1)                                            GNU Development Tools                                            OBJDUMP(1)

NAME
       objdump - display information from object files.

SYNOPSIS
       objdump [-a|--archive-headers]
               [-b bfdname|--target=bfdname]
               [-C|--demangle[=style] ]
               [-d|--disassemble]
               [-D|--disassemble-all]
               [-z|--disassemble-zeroes]
               [-EB|-EL|--endian={big | little }]
               [-f|--file-headers]
               [-F|--file-offsets]
               [--file-start-context]
               [-g|--debugging]
               [-e|--debugging-tags]
               [-h|--section-headers|--headers]
               [-i|--info]
               [-j section|--section=section]
               [-l|--line-numbers]
               [-S|--source]
               [-m machine|--architecture=machine]
               [-M options|--disassembler-options=options]
               [-p|--private-headers]
               [-P options|--private=options]
               [-r|--reloc]
               [-R|--dynamic-reloc]
               [-s|--full-contents]
               [-W[lLiaprmfFsoRt]|
                --dwarf[=rawline,=decodedline,=info,=abbrev,=pubnames]
                        [=aranges,=macro,=frames,=frames-interp,=str,=loc]
                        [=Ranges,=pubtypes,=trace_info,=trace_abbrev]
                        [=trace_aranges,=gdb_index]
               [-G|--stabs]
               [-t|--syms]
               [-T|--dynamic-syms]
               [-x|--all-headers]
               [-w|--wide]
               [--start-address=address]
               [--stop-address=address]
               [--prefix-addresses]
               [--[no-]show-raw-insn]
               [--adjust-vma=offset]
               [--special-syms]
               [--prefix=prefix]
               [--prefix-strip=level]
               [--insn-width=width]
               [-V|--version]
               [-H|--help]
               objfile...
</code></pre></div></div>
<p>è¿™é‡Œå¯ä»¥çœ‹åˆ°æˆ‘ä»¬ä½¿ç”¨åˆ°çš„ä¸¤ä¸ªå‚æ•°, ä¸€ä¸ª <code class="language-plaintext highlighter-rouge">-h</code> æ˜¾ç¤ºå¤´, ä¸€ä¸ª <code class="language-plaintext highlighter-rouge">-G</code> æ˜¾ç¤º stab. 
æœ€åè¿˜æœ‰ä¸€ä¸ª:</p>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>$ gcc -pipe -nostdinc -O2 -fno-builtin -I. -MD -Wall -Wno-format -DJOS_KERNEL -gstabs -c -S kern/init.c
$ more ./init.s
	.file	"init.c"
	.stabs	"kern/init.c",100,0,2,.Ltext0
	.text
.Ltext0:
	.stabs	"gcc2_compiled.",60,0,0,0
	.stabs	"int:t(0,1)=r(0,1);-2147483648;2147483647;",128,0,0,0
	.stabs	"char:t(0,2)=r(0,2);0;127;",128,0,0,0
	.stabs	"long int:t(0,3)=r(0,3);-2147483648;2147483647;",128,0,0,0
	.stabs	"unsigned int:t(0,4)=r(0,4);0;4294967295;",128,0,0,0
	.stabs	"long unsigned int:t(0,5)=r(0,5);0;4294967295;",128,0,0,0
	.stabs	"__int128:t(0,6)=r(0,6);0;-1;",128,0,0,0
	.stabs	"__int128 unsigned:t(0,7)=r(0,7);0;-1;",128,0,0,0
	.stabs	"long long int:t(0,8)=r(0,8);-0;4294967295;",128,0,0,0
	.stabs	"long long unsigned int:t(0,9)=r(0,9);0;-1;",128,0,0,0
	.stabs	"short int:t(0,10)=r(0,10);-32768;32767;",128,0,0,0
	.stabs	"short unsigned int:t(0,11)=r(0,11);0;65535;",128,0,0,0
	.stabs	"signed char:t(0,12)=r(0,12);-128;127;",128,0,0,0
	.stabs	"unsigned char:t(0,13)=r(0,13);0;255;",128,0,0,0
	.stabs	"float:t(0,14)=r(0,1);4;0;",128,0,0,0
	.stabs	"double:t(0,15)=r(0,1);8;0;",128,0,0,0
	.stabs	"long double:t(0,16)=r(0,1);12;0;",128,0,0,0
	.stabs	"_Decimal32:t(0,17)=r(0,1);4;0;",128,0,0,0
	.stabs	"_Decimal64:t(0,18)=r(0,1);8;0;",128,0,0,0
	.stabs	"_Decimal128:t(0,19)=r(0,1);16;0;",128,0,0,0
	.stabs	"void:t(0,20)=(0,20)",128,0,0,0
	.stabs	"./inc/stdio.h",130,0,0,0
	.stabs	"./inc/stdarg.h",130,0,0,0
	.stabs	"va_list:t(2,1)=(2,2)=*(0,2)",128,0,0,0
	.stabn	162,0,0,0
	.stabn	162,0,0,0
	.stabs	"./inc/string.h",130,0,0,0
	.stabs	"./inc/types.h",130,0,0,0
	.stabs	"bool:t(4,1)=(4,2)=eFalse:0,True:1,;",128,0,0,0
	.stabs	" :T(4,3)=efalse:0,true:1,;",128,0,0,0
	.stabs	"int8_t:t(4,4)=(0,12)",128,0,0,0
	.stabs	"uint8_t:t(4,5)=(0,13)",128,0,0,0
--More--(19%)
</code></pre></div></div>
<p>æœ€å, é¢˜ä¸­è®©æˆ‘ä»¬çœ‹ä¸€ä¸‹ boot loader æœ‰æ²¡æœ‰å°†å®ƒåŠ è½½åˆ°å†…å­˜ä¸­:</p>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>(gdb) x/10s 0x00105abd
0x105abd:	""
0x105abe:	"{standard input}"
0x105acf:	"kern/entry.S"
0x105adc:	"kern/entrypgdir.c"
0x105aee:	"gcc2_compiled."
0x105afd:	"int:t(0,1)=r(0,1);-2147483648;2147483647;"
0x105b27:	"char:t(0,2)=r(0,2);0;127;"
0x105b41:	"long int:t(0,3)=r(0,3);-2147483648;2147483647;"
0x105b70:	"unsigned int:t(0,4)=r(0,4);0;4294967295;"
0x105b99:	"long unsigned int:t(0,5)=r(0,5);0;4294967295;"
</code></pre></div></div>
<p>å°±æ­¤æ‰“ä½. ä¸å†æ·±ç©¶äº†.</p>

<p>ç¬¬äºŒæ­¥, æˆ‘ä»¬å¾—ä¸ºè¯¥å‡½æ•°è¡¥ä¸Šä¸€æ®µä½¿ç”¨äºŒåˆ†æŸ¥æ‰¾çš„ä»£ç :<br />
kern/kdebug.c:</p>
<div class="language-c highlighter-rouge"><div class="highlight"><pre class="highlight"><code>	<span class="c1">// Your code here.</span>
	<span class="n">stab_binsearch</span><span class="p">(</span><span class="n">stabs</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">lline</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">rline</span><span class="p">,</span> <span class="n">N_SLINE</span><span class="p">,</span> <span class="n">addr</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">lline</span> <span class="o">&lt;=</span> <span class="n">rline</span><span class="p">)</span>
		<span class="n">info</span><span class="o">-&gt;</span><span class="n">eip_line</span> <span class="o">=</span> <span class="n">stabs</span><span class="p">[</span><span class="n">lline</span><span class="p">].</span><span class="n">n_desc</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
</code></pre></div></div>
<p>æœ¬æ¥æ˜¯æ‰“ç®—æŠŠæ•´ä¸ª <code class="language-plaintext highlighter-rouge">debuginfo_eip()</code> éƒ½æ‹¿è¿‡æ¥çš„, åšäº†ç‚¹æ³¨é‡Šä¹‹åå‘ç°æ²¡å•¥å¥½çœ‹çš„ä¸œè¥¿, å°±éƒ½åˆ æ‰äº†.<br />
æœ€åä¿®æ”¹ <code class="language-plaintext highlighter-rouge">kern/monitor.c</code>:</p>
<div class="language-c highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="o">---</span> <span class="n">a</span><span class="o">/</span><span class="n">kern</span><span class="o">/</span><span class="n">monitor</span><span class="p">.</span><span class="n">c</span>
<span class="o">+++</span> <span class="n">b</span><span class="o">/</span><span class="n">kern</span><span class="o">/</span><span class="n">monitor</span><span class="p">.</span><span class="n">c</span>
<span class="err">@@</span> <span class="o">-</span><span class="mi">24</span><span class="p">,</span><span class="mi">6</span> <span class="o">+</span><span class="mi">24</span><span class="p">,</span><span class="mi">7</span> <span class="err">@@</span> <span class="k">struct</span> <span class="n">Command</span> <span class="p">{</span>
 <span class="k">static</span> <span class="k">struct</span> <span class="n">Command</span> <span class="n">commands</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
        <span class="p">{</span> <span class="s">"help"</span><span class="p">,</span> <span class="s">"Display this list of commands"</span><span class="p">,</span> <span class="n">mon_help</span> <span class="p">},</span>
        <span class="p">{</span> <span class="s">"kerninfo"</span><span class="p">,</span> <span class="s">"Display information about the kernel"</span><span class="p">,</span> <span class="n">mon_kerninfo</span> <span class="p">},</span>
<span class="o">+</span>       <span class="p">{</span> <span class="s">"backtrace"</span><span class="p">,</span> <span class="s">"looks up eip in the symbol table and returns the debugging information for that address"</span><span class="p">,</span> <span class="n">mon_backtrace</span> <span class="p">},</span>
 <span class="p">};</span>
 
 <span class="cm">/***** Implementations of basic kernel monitor commands *****/</span>
<span class="err">@@</span> <span class="o">-</span><span class="mi">66</span><span class="p">,</span><span class="mi">8</span> <span class="o">+</span><span class="mi">67</span><span class="p">,</span><span class="mi">16</span> <span class="err">@@</span> <span class="n">mon_backtrace</span><span class="p">(</span><span class="kt">int</span> <span class="n">argc</span><span class="p">,</span> <span class="kt">char</span> <span class="o">**</span><span class="n">argv</span><span class="p">,</span> <span class="k">struct</span> <span class="n">Trapframe</span> <span class="o">*</span><span class="n">tf</span><span class="p">)</span>
                <span class="k">for</span> <span class="p">(</span><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">4</span><span class="p">;</span> <span class="o">++</span><span class="n">i</span><span class="p">)</span> <span class="p">{</span>
                        <span class="n">cprintf</span><span class="p">(</span><span class="s">" %08x"</span><span class="p">,</span> <span class="o">*</span><span class="p">(</span><span class="n">args</span> <span class="o">+</span> <span class="n">i</span><span class="p">));</span>
                <span class="p">}</span>
<span class="o">-</span>               <span class="n">cprintf</span><span class="p">(</span><span class="s">"</span><span class="se">\n</span><span class="s">"</span><span class="p">);</span>
<span class="o">+</span>               <span class="n">cprintf</span><span class="p">(</span><span class="s">"</span><span class="se">\n</span><span class="s">         "</span><span class="p">);</span>
                <span class="n">ebp</span> <span class="o">=</span> <span class="p">(</span><span class="kt">uint32_t</span> <span class="o">*</span><span class="p">)(</span><span class="o">*</span><span class="n">ebp</span><span class="p">);</span>
<span class="o">+</span>               <span class="k">struct</span> <span class="n">Eipdebuginfo</span> <span class="n">info</span><span class="p">;</span>
<span class="o">+</span>               <span class="k">if</span> <span class="p">(</span><span class="n">debuginfo_eip</span><span class="p">(</span><span class="n">eip</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">info</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
<span class="o">+</span>                       <span class="n">panic</span><span class="p">(</span><span class="s">"Error read stabs!"</span><span class="p">);</span>
<span class="o">+</span>                       <span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
<span class="o">+</span>               <span class="p">}</span>
<span class="o">+</span>               <span class="n">cprintf</span><span class="p">(</span><span class="s">"%s:%d: "</span><span class="p">,</span> <span class="n">info</span><span class="p">.</span><span class="n">eip_file</span><span class="p">,</span> <span class="n">info</span><span class="p">.</span><span class="n">eip_line</span><span class="p">);</span>
<span class="o">+</span>               <span class="n">cprintf</span><span class="p">(</span><span class="s">"%.*s"</span><span class="p">,</span> <span class="n">info</span><span class="p">.</span><span class="n">eip_fn_namelen</span><span class="p">,</span> <span class="n">info</span><span class="p">.</span><span class="n">eip_fn_name</span><span class="p">);</span>
<span class="o">+</span>               <span class="n">cprintf</span><span class="p">(</span><span class="s">"+%d</span><span class="se">\n</span><span class="s">"</span><span class="p">,</span> <span class="p">(</span><span class="kt">uint32_t</span><span class="p">)</span><span class="n">eip</span> <span class="o">-</span> <span class="p">(</span><span class="kt">uint32_t</span><span class="p">)</span><span class="n">info</span><span class="p">.</span><span class="n">eip_fn_addr</span><span class="p">);</span>
        <span class="p">}</span>
        <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
 <span class="err">}</span>
</code></pre></div></div>
<p>æ‰“ä¸Š commit, æ”¶å·¥.</p>

<h1 id="æ€»ç»“">æ€»ç»“</h1>
<p>lab1 å†…å®¹æŒºå¤š, çœ‹äº†ä¸€ä¸‹åé¢çš„å‡ ä¸ª lab å¥½åƒå†…å®¹éƒ½æ²¡æœ‰è¿™ä¹ˆå¤š. è¿™ä¸€ä¸ªå¤šæ˜ŸæœŸæ¥æ¯”è¾ƒè‚, åœ¨ MIT åŸè®¡åˆ’çš„ä¸¤å‘¨å†…è¶…é¢å®Œæˆäº†, å€¼å¾—é¼“åŠ±ä¸€ä¸‹.(å…¶å®é‚£ä¸€æœ¬ NASM çš„æŒ‡å¯¼ä¹¦å°±ä¸æ­¢ä¿©æ˜ŸæœŸäº†:p)</p>

<p>æ¯›ç—…è¿˜æ˜¯å¾ˆå¤šçš„, å®éªŒè¿‡ç¨‹ä¸­å¤§é‡å‚è€ƒäº†å”å’Œå­Ÿä½¬çš„æ–‡ç« , å¾ˆå¤šèµ„æ–™æ²¡æœ‰äº²è‡ªå»é˜…è¯»ä¸€äº›å†…å®¹å»å®Œæˆäº†. åœ¨æ•´ä¸ªå®éªŒè¿‡ç¨‹ä¸­éå¸¸ç¼ºä¹è‡ªå·±çš„æ€è€ƒå’Œå¯¹å»¶ç”³å†…å®¹çš„æ¢ç´¢, å¸Œæœ›èƒ½åœ¨åé¢çš„ lab ä¸­æ”¹è¿›.</p>

<p>P.S.: æˆ‘åœ¨åšåˆ° Exercise 10 çš„æ—¶å€™æ‰å‘ç°æˆ‘æŠŠ gdb <code class="language-plaintext highlighter-rouge">si</code> çš„è¾“å‡ºä¿¡æ¯ç†è§£é”™äº†(æˆ‘ä¸€ç›´è®¤ä¸ºæ˜¯ <code class="language-plaintext highlighter-rouge">si</code> è¾“å‡ºçš„é‚£ä¸€è¡Œå·²ç»åˆšåˆšè¢«è¿è¡Œ, å…¶å®åº”è¯¥æ˜¯å°†è¦è¿è¡Œçš„)â€¦ ä¸è¿‡å¥½åœ¨ä¸å¤ªå½±å“æ•´ä¸ªå®éªŒçš„å®Œæˆ. è¿™ç®—æ˜¯æœ¬æ¬¡å®éªŒéå¸¸å¤§çš„ä¸€ä¸ªç‘•ç–µ(?)äº†, ä¹‹åä¼šå¤šåŠ æ³¨æ„äº†.</p>

<p>æœ€å, <code class="language-plaintext highlighter-rouge">./grade-lab1</code> çš„è¾“å‡ºä¿¡æ¯çºªå¿µ lab1 å®Œæˆ:</p>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>running JOS: (0.6s) 
  printf: OK 
  backtrace count: OK 
  backtrace arguments: OK 
  backtrace symbols: OK 
  backtrace lines: OK 
Score: 50/50
</code></pre></div></div>

<h1 id="å¼•ç”¨">å¼•ç”¨</h1>
<ol>
  <li><a href="https://pdos.csail.mit.edu/6.828/2018/labs/lab1/">https://pdos.csail.mit.edu/6.828/2018/labs/lab1/</a></li>
  <li><span id="ref2"><a href="https://github.com/Spdwal/LearningLanuages/blob/master/OperatingSystem/6.828/lab1.md">https://github.com/Spdwal/LearningLanuages/blob/master/OperatingSystem/6.828/lab1.md</a></span></li>
  <li><span id="ref3"><a href="https://blog.csdn.net/qq_32473685/article/details/93626548#1%20%C2%A0%E4%B8%BB%E8%A6%81%E9%98%85%E8%AF%BB%E6%B1%87%E7%BC%96%E8%AF%AD%E8%A8%80%E8%B5%84%E6%96%99%E3%80%82">https://blog.csdn.net/qq_32473685/article/details/93626548#1%20%C2%A0%E4%B8%BB%E8%A6%81%E9%98%85%E8%AF%BB%E6%B1%87%E7%BC%96%E8%AF%AD%E8%A8%80%E8%B5%84%E6%96%99%E3%80%82</a></span></li>
  <li><span id="ref4"><a href="https://www.cnblogs.com/fatsheep9146/p/5078179.html">https://www.cnblogs.com/fatsheep9146/p/5078179.html</a></span></li>
  <li><span id="ref5"><a href="http://bochs.sourceforge.net/techspec/PORTS.LST">http://bochs.sourceforge.net/techspec/PORTS.LST</a></span></li>
  <li><span id="ref6"><a href="http://kernelx.weebly.com/a20-address-line.html">http://kernelx.weebly.com/a20-address-line.html</a></span></li>
  <li><span id="ref7"><a href="https://en.wikibooks.org/wiki/X86_Assembly/Global_Descriptor_Table">https://en.wikibooks.org/wiki/X86_Assembly/Global_Descriptor_Table</a></span></li>
  <li><a href="https://zhuanlan.zhihu.com/p/36926462">https://zhuanlan.zhihu.com/p/36926462</a></li>
  <li><a href="https://pdos.csail.mit.edu/6.828/2018/readings/elf.pdf">https://pdos.csail.mit.edu/6.828/2018/readings/elf.pdf</a></li>
  <li><a href="http://en.wikipedia.org/wiki/Executable_and_Linkable_Format">http://en.wikipedia.org/wiki/Executable_and_Linkable_Format</a></li>
</ol>
:ET